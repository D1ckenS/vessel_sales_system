{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}<span data-translate="transfer_items">Transfer Items</span> - <span data-translate="vessel_sales_system">Vessel Sales System</span>{% endblock %}

{% block extra_css %}
<style>
    .cart-summary-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-top: 2px solid #dee2e6;
    }

    /* Enhanced table row styling for better readability */
    .table tbody tr td {
        vertical-align: middle;
        padding: 12px 8px;
    }

    /* Responsive adjustments - EXACT COPY FROM PO SUPPLY */
    @media (max-width: 768px) {
        .cart-summary-section .row {
            text-align: center !important;
        }
        
        .cart-summary-section .col-md-4 {
            margin-top: 10px;
        }
    }

    /* Animation for cart updates */
    .cart-item-updated {
        animation: highlightUpdate 0.5s ease-in-out;
    }

    @keyframes highlightUpdate {
        0% { background-color: #fff3cd; }
        100% { background-color: transparent; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-arrow-left-right text-warning"></i> 
                    <span data-translate="transfer_items">Transfer Items</span>
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-ship text-danger"></i> <span class="vessel-name" data-en="{{ transfer.from_vessel.name }}" data-ar="{{ transfer.from_vessel.name_ar }}">{{ transfer.from_vessel.name }}</span>
                    <i class="bi bi-arrow-right mx-2"></i>
                    <i class="bi bi-ship text-success"></i> <span class="vessel-name" data-en="{{ transfer.to_vessel.name }}" data-ar="{{ transfer.to_vessel.name_ar }}">{{ transfer.to_vessel.name }}</span>
                    â€¢ <i class="bi bi-calendar"></i> <span data-transfer-date data-original="{{ transfer.transfer_date|date:'d/m/Y' }}">{{ transfer.transfer_date|date:"d/m/Y" }}</span>
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'frontend:transfer_entry' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> <span data-translate="back_to_transfers">Back to Transfers</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Summary Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #fd7e14, #ffc107); color: white;">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="total_cost">Total Cost</span></h6>
                        <h3 class="mb-0" id="transferTotalCost">
                            {% if not can_edit %}
                                <span data-number data-original="{{ transfer.total_cost|floatformat:3 }}">{{ transfer.total_cost|floatformat:3 }}</span> <span data-currency-symbol>JOD</span>
                            {% else %}
                                <span data-number data-original="0.000">0.000</span> <span data-currency-symbol>JOD</span>
                            {% endif %}
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="items_to_transfer">Items to Transfer</span></h6>
                        <h3 class="mb-0" id="transferItemCount">
                            {% if not can_edit %}
                                <span data-number data-original="{{ transfer.transaction_count }}">{{ transfer.transaction_count }}</span>
                            {% else %}
                                <span data-number data-original="0">0</span>
                            {% endif %}
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="from_to">From â†’ To</span></h6>
                        <h3 class="mb-0" style="font-size: 1.5rem;">
                            <i class="bi bi-ship text-light opacity-75 me-1"></i>
                            <span class="vessel-name" data-en="{{ transfer.from_vessel.name }}" data-ar="{{ transfer.from_vessel.name_ar }}">{{ transfer.from_vessel.name }}</span>
                            <i class="bi bi-arrow-right mx-2"></i>
                            <i class="bi bi-ship text-light opacity-75 me-1"></i>
                            <span class="vessel-name" data-en="{{ transfer.to_vessel.name }}" data-ar="{{ transfer.to_vessel.name_ar }}">{{ transfer.to_vessel.name }}</span>
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="status">Status</span></h6>
                        <h3 class="mb-0">
                            {% if can_edit %}
                                <span class="badge bg-light text-dark"><span data-translate="in_progress">In Progress</span></span>
                            {% else %}
                                <span class="badge bg-success"><span data-translate="transfer_completed">Completed</span></span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Completed Alert (for completed transfers) -->
<div class="row">
    {% if can_edit %}
    <!-- LEFT SIDE: Transfer Form -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0" id="formTitle">
                    <i class="bi bi-plus-circle"></i> <span data-translate="add_transfer_item">Add Transfer Item</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="addTransferForm">
                    {% csrf_token %}
                    <input type="hidden" id="transferId" value="{{ transfer.id }}">
                    <input type="hidden" id="editIndex" value="-1">
                    <input type="hidden" id="fromVesselId" value="{{ transfer.from_vessel.id }}">
                    <input type="hidden" id="toVesselId" value="{{ transfer.to_vessel.id }}">
                    
                    <!-- Product Search -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search"></i> <span data-translate="search_product">Search Product</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="productSearch" 
                            data-placeholder-en="Type product name or ID..."
                            data-placeholder-ar="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..."
                            placeholder="Type product name or ID..." autocomplete="off">
                    </div>
                    
                    <!-- Product Info (Hidden initially) -->
                    <div id="productInfo" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-12">
                                    <strong><span data-translate="selected_product">Selected Product:</span></strong>
                                    <div id="productName">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quantity Input -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-123"></i> <span data-translate="quantity_to_transfer">Quantity to Transfer</span>
                        </label>
                        <input type="number" class="form-control form-control-lg" id="transferQuantity" 
                            placeholder="0" min="1" step="1" disabled>
                        <small class="text-muted" id="availableStock"><span data-translate="select_product_first">Select product first</span></small>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-chat-left-text"></i> <span data-translate="transfer_notes_optional">Transfer Notes (Optional)</span>
                        </label>
                        <input type="text" class="form-control" id="transferNotes" 
                            data-placeholder-en="Additional notes for this transfer..."
                            data-placeholder-ar="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ­ÙˆÙŠÙ„..."
                            placeholder="Additional notes for this transfer...">
                    </div>
                    
                    <!-- Duty-Free Warning -->
                    <div id="dutyFreeWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong><span data-translate="warning">Warning</span>:</strong> <span data-translate="duty_free_warning_text">This is a duty-free product. Make sure the destination vessel supports duty-free items.</span>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning" id="addTransferBtn" disabled>
                            <i class="bi bi-plus"></i> <span id="addBtnText" data-translate="add_to_transfer">Add to Transfer</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="bi bi-x-circle"></i> <span data-translate="clear_form">Clear Form</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="cancelEdit()">
                            <i class="bi bi-x-circle"></i> <span data-translate="cancel">Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- RIGHT SIDE: Available Products -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-boxes"></i> <span data-translate="available_products_for">Available products for</span> 
                    <span class="vessel-name" data-en="{{ transfer.from_vessel.name }}" data-ar="{{ transfer.from_vessel.name_ar }}">{{ transfer.from_vessel.name }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div style="height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th><span data-translate="product_name">Product Name</span></th>
                                <th class="text-center"><span data-translate="product_id">Product ID</span></th>
                                <th class="text-end"><span data-translate="stock_available">Stock Available</span></th>
                            </tr>
                        </thead>
                        <tbody id="availableProductsList">
                            <!-- Loading state -->
                            <tr id="productsLoadingState">
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span data-translate="loading_products">Loading products...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- For completed transfers: Show summary information instead of forms -->
    <div class="col-12">
        <div class="alert alert-success">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle"></i> <span data-translate="transfer_completed">Transfer Completed</span>
                    </h5>
                    <p class="mb-0">
                        <span data-translate="transfer_completed_desc">This transfer has been completed and is now read-only. All items have been transferred and inventory has been updated.</span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <strong><span data-translate="completion_date">Completed:</span></strong><br>
                    <span data-transfer-date data-original="{{ transfer.updated_at|date:'d/m/Y H:i' }}">{{ transfer.updated_at|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Transfer Items List -->
<!-- Transfer Cart Section - Bottom Full Width (Following trip_sales.html pattern) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        {% if can_edit %}
                            <i class="bi bi-cart"></i> <span data-translate="transfer_cart">Transfer Cart</span>
                        {% else %}
                            <i class="bi bi-check-circle"></i> <span data-translate="completed_transfer_items">Completed Transfer Items</span>
                        {% endif %}
                    </h5>
                    {% if not can_edit %}
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="window.showUnifiedExportModal('single_transfer',{ transfer_id: {{ transfer.id }} })">
                            <i class="bi bi-download"></i> <span data-translate="export">Export</span>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="bi bi-printer"></i> <span data-translate="print">Print</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                {% if can_edit %}
                <!-- Transfer Cart Table (Editable) -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><span data-translate="product">Product</span></th>
                                <th class="text-center"><span data-translate="quantity">Quantity</span></th>
                                <th class="text-end"><span data-translate="cost">Cost</span></th>
                                <th><span data-translate="notes">Notes</span></th>
                                <th class="text-center"><span data-translate="actions">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="transferItemsList">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="emptyTransferState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-cart-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3"><span data-translate="no_items_in_cart">No items in cart</span></h5>
                    <p class="text-muted"><span data-translate="use_form_transfer">Use the form above to add transfer items</span></p>
                </div>
                
                <!-- Cart Summary Footer (Following po_supply pattern exactly) -->
                <div class="card-footer bg-light cart-summary-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-cart-check text-success me-2" style="font-size: 1.2rem;"></i>
                                <strong><span data-translate="cart_summary">Cart Summary:</span></strong>
                                <span class="ms-2">
                                    <span id="cartSummaryItems" data-number>0</span> <span data-translate="total_items">total items</span>
                                    â€¢ 
                                    <span id="cartSummaryTotal" data-number>0.000</span> <span data-currency-symbol>JOD</span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-warning btn-lg" id="completeTransferBtnFooter" onclick="completeTransfer()" disabled>
                                <span id="completeFooterBtnText">
                                    <i class="bi bi-check-circle"></i> <span data-translate="complete_transfer">Complete Transfer</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Completed Transfer Items (Read-only) -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><span data-translate="time">Time</span></th>
                                <th><span data-translate="product">Product</span></th>
                                <th class="text-center"><span data-translate="quantity">Quantity</span></th>
                                <th class="text-end"><span data-translate="cost">Cost</span></th>
                                <th class="text-end"><span data-translate="notes">Notes</span></th>
                            </tr>
                        </thead>
                        <tbody id="completedTransfersList">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State for Completed -->
                <div id="emptyCompletedState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3"><span data-translate="no_completed_transfers">No completed transfer items</span></h5>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global state - following trip_sales pattern
let transferItemsCart = [];
let selectedProduct = null;
let availableProducts = [];
let editingIndex = -1;

// Initialize page (following trip_sales pattern)
document.addEventListener('DOMContentLoaded', function() {
    window.initializePage({
        titleKey: 'transfer_items',
        fallbackTitle: 'Transfer Items'
    });
    
    // Check if required elements exist and if transfer is editable
    const transferIdElement = document.getElementById('transferId');
    const canEdit = {{ can_edit|yesno:"true,false" }};
    
    if (!canEdit) {
        console.log('Transfer completed - displaying read-only data');
        {% if completed_transfers_json %}
        try {
            const completedTransfersRaw = '{{ completed_transfers_json|escapejs }}';
            const completedTransfers = JSON.parse(completedTransfersRaw);
            
            if (completedTransfers && completedTransfers.length > 0) {
                displayCompletedTransfers(completedTransfers);
                updateCompletedTransferTotals(completedTransfers);
            } else {
                console.log('ðŸ” No completed transfers to display');
            }
        } catch (e) {
            console.log('Error parsing completed transfers:', e);
        }
        {% else %}
        console.log('ðŸ” No completed_transfers_json available');
        {% endif %}
        // No need to load available products for completed transfers
        window.updatePageTranslations();
        return;
    }
    
    if (!transferIdElement) {
        console.log('Transfer elements missing, skipping cart initialization');
        return;
    }
    
    // Initialize for editable transfers (following trip_sales pattern)
    try {
        initializeTransferCart();
        loadAvailableProducts();
        updateCartDisplay();
        setupEventListeners();
    } catch (error) {
        console.error('Error initializing transfer cart:', error);
        window.showAlert(window._ ? window._('error_loading_cart') : 'Error loading cart', 'warning');
        transferItemsCart = [];
        updateCartDisplay();
    }
    
    // Apply translations
    window.updatePageTranslations();
});

// Load available products (from Step 3)
function loadAvailableProducts() {
    const fromVesselId = document.getElementById('fromVesselId').value;
    
    if (!fromVesselId) {
        console.error('No from vessel ID found');
        return;
    }
    
    // Show loading state
    const loadingState = document.getElementById('productsLoadingState');
    if (loadingState) {
        loadingState.style.display = 'table-row';
    }
    
    fetch('/transfer/available-products/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.getCsrfToken()
        },
        body: JSON.stringify({
            vessel_id: parseInt(fromVesselId)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Available products loaded:', data);
        
        if (data.success) {
            displayAvailableProducts(data.products);
            availableProducts = data.products; // Store globally for search functionality
        } else {
            console.error('Error loading products:', data.error);
            showProductsError(data.error || 'Failed to load products');
        }
    })
    .catch(error => {
        console.error('Error fetching available products:', error);
        showProductsError('Network error occurred while loading products');
    });
}

// Display available products (from Step 3)
function displayAvailableProducts(products) {
    const tbody = document.getElementById('availableProductsList');
    
    if (!products || products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted py-4">
                    <i class="bi bi-box-x"></i><br>
                    <span data-translate="no_products_available">No products available for transfer</span>
                </td>
            </tr>
        `;
        return;
    }
    
    // Build table rows (following trip_sales pattern exactly)
    const rows = products.map(product => {
        const productName = product.name || 'Unknown Product';
        const productId = product.item_id || product.id;
        const stock = product.total_quantity || 0;
        const dutyFreeBadge = product.is_duty_free ? '<br><span class="badge bg-warning text-dark ms-1">' + (window._ ? window._('duty_free') : 'Duty Free') + '</span>' : '';
        
        // Check if already in cart (following trip_sales pattern)
        const isInCart = transferItemsCart.some(item => item.product_id == product.id);
        const rowClass = isInCart ? 'table-warning' : '';
        
        return `
            <tr class="${rowClass} cursor-pointer" onclick="selectProductFromList(${product.id}, '${productName.replace(/'/g, "\\'")}', ${stock}, ${product.is_duty_free || false})">
                <td>
                    <div>
                        <strong>${productName}</strong>
                        ${dutyFreeBadge}
                        ${isInCart ? '<br><span class="badge bg-info">In Cart</span>' : ''}
                    </div>
                </td>
                <td class="text-center">
                    <code data-number data-original="${productId}">${window.translateNumber ? window.translateNumber(productId) : productId}</code>
                </td>
                <td class="text-end">
                    <span class="fw-bold text-success" data-number data-original="${stock}">${window.translateNumber ? window.translateNumber(stock.toString()) : stock}</span>
                    <small class="text-muted d-block"><span data-translate="units">units</span></small>
                </td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = rows;
    
    // Apply translations after DOM update
    setTimeout(() => {
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
    }, 100);
}

// Show error state
function showProductsError(errorMessage) {
    const tbody = document.getElementById('availableProductsList');
    tbody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle"></i><br>
                <small>${errorMessage}</small><br>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadAvailableProducts()">
                    <i class="bi bi-arrow-clockwise"></i> <span data-translate="retry">Retry</span>
                </button>
            </td>
        </tr>
    `;
}

function selectProductFromList(productId, productName, availableStock, isDutyFree) {
    // Set selected product data (like po_supply)
    selectedProduct = {
        id: productId,
        name: productName,
        available_stock: availableStock,
        total_quantity: availableStock, // For compatibility
        is_duty_free: isDutyFree
    };
    
    // Update product info display (like po_supply)
    document.getElementById('productName').textContent = productName;
    document.getElementById('productInfo').style.display = 'block';
    
    // Update product search input
    document.getElementById('productSearch').value = productName;
    
    // Enable form inputs (like po_supply)
    document.getElementById('transferQuantity').disabled = false;
    document.getElementById('transferQuantity').max = availableStock;
    
    // Update stock info
    const availableText = window._ ? window._('available') : 'Available:';
    const unitsText = window._ ? window._('units') : 'units';
    document.getElementById('availableStock').innerHTML = `<span data-translate="available">${availableText}</span> <strong>${availableStock}</strong> <span data-translate="units">${unitsText}</span>`;
    
    // Show/hide duty-free warning
    const dutyFreeWarning = document.getElementById('dutyFreeWarning');
    if (dutyFreeWarning) {
        dutyFreeWarning.style.display = isDutyFree ? 'block' : 'none';
    }
    
    // Focus on quantity input (like po_supply focuses on numBoxes)
    document.getElementById('transferQuantity').focus();
    
    // Update validation (like po_supply calls updateCalculations() and validateForm())
    validateTransferForm();
    
    // Show success feedback
    if (window.showAlert && window._) {
        window.showAlert(window._('product_selected_success') || 'Product selected successfully!', 'success', 2000);
    }
}

// Calculate FIFO cost for transfer item (NEW: Proper FIFO, no averages)
async function calculateFIFOCost(productId, quantity) {
    const fromVesselId = document.getElementById('fromVesselId').value;
    
    try {
        const response = await fetch('/transfer/calculate-fifo-cost/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.getCsrfToken()
            },
            body: JSON.stringify({
                vessel_id: parseInt(fromVesselId),
                product_id: parseInt(productId),
                quantity: parseInt(quantity)
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // REMOVED: No average_unit_cost handling
            if (data.warning) {
                console.warn('FIFO calculation warning:', data.warning);
                window.showAlert(data.warning, 'warning', 3000);
            }
            
            return {
                total_cost: data.total_cost || (quantity * 0.050), // Only total cost
                fifo_breakdown: data.fifo_breakdown || []
            };
        } else {
            throw new Error(data.error || 'Failed to calculate FIFO cost');
        }
    } catch (error) {
        console.error('Error calculating FIFO cost:', error);
        
        // Show user-friendly error message
        const errorMessage = error.message || 'Failed to calculate transfer cost';
        window.showAlert(`FIFO calculation failed: ${errorMessage}. Using fallback cost.`, 'warning', 5000);
        
        // Fallback cost - only total
        const fallbackTotalCost = quantity * 0.050; // 50 fils per unit
        return {
            total_cost: fallbackTotalCost,
            fifo_breakdown: [],
            isFallback: true
        };
    }
}

// Initialize transfer cart (following trip_sales pattern)
function initializeTransferCart() {
    const transferId = document.getElementById('transferId').value;
    const storageKey = `transfer_items_${transferId}`;
    
    // Try to load from localStorage first
    const savedCart = localStorage.getItem(storageKey);
    if (savedCart) {
        try {
            transferItemsCart = JSON.parse(savedCart);
            console.log('Loaded cart from localStorage:', transferItemsCart);
        } catch (e) {
            console.log('Error parsing saved cart, starting fresh');
            transferItemsCart = [];
        }
    }
    
    // If no saved cart, load from existing transfers (backend data)
    if (transferItemsCart.length === 0) {
        {% if existing_transfers_json %}
        try {
            const existingTransfers = JSON.parse('{{ existing_transfers_json|escapejs }}');
            if (existingTransfers && existingTransfers.length > 0) {
                transferItemsCart = existingTransfers.map(transfer => ({
                    product_id: transfer.product_id,
                    product_name: transfer.product_name,
                    product_item_id: transfer.product_item_id,
                    is_duty_free: transfer.is_duty_free,
                    quantity: transfer.quantity,
                    total_cost: transfer.total_amount, // Use total_amount as total_cost
                    notes: transfer.notes || ''
                }));
                
                console.log('Loaded existing transfers into cart:', transferItemsCart);
            }
        } catch (e) {
            console.log('Error parsing existing transfers:', e);
        }
        {% endif %}
    }
}

// Save cart to localStorage (following trip_sales pattern)
function saveCartToStorage() {
    try {
        const transferId = document.getElementById('transferId').value;
        const storageKey = `transfer_items_${transferId}`;
        localStorage.setItem(storageKey, JSON.stringify(transferItemsCart));
    } catch (error) {
        console.log('Error saving cart to storage:', error);
    }
}

// Setup event listeners (following trip_sales pattern)
function setupEventListeners() {
    // Product search input
    const productSearch = document.getElementById('productSearch');
    if (productSearch) {
        productSearch.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            if (searchTerm.length >= 2) {
                searchProducts(searchTerm);
            }
        });
    }
    
    const quantityInput = document.getElementById('transferQuantity');
    if (quantityInput) {
        quantityInput.addEventListener('input', validateTransferForm);
    }
    
    // Form submission
    const addTransferForm = document.getElementById('addTransferForm');
    if (addTransferForm) {
        addTransferForm.addEventListener('submit', function(e) {
            e.preventDefault();
            addTransferItem();
        });
    }
    
    // Complete transfer buttons
    const completeBtn = document.getElementById('completeTransferBtn');
    const completeBtnFooter = document.getElementById('completeTransferBtnFooter');
    
    if (completeBtn) {
        completeBtn.addEventListener('click', completeTransfer);
    }
    if (completeBtnFooter) {
        completeBtnFooter.addEventListener('click', completeTransfer);
    }
}

// Search products (following trip_sales pattern)
function searchProducts(searchTerm) {
    const fromVesselId = document.getElementById('fromVesselId').value;
    
    fetch('/transfer/search-products/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.getCsrfToken()
        },
        body: JSON.stringify({
            search: searchTerm,
            vessel_id: parseInt(fromVesselId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.products.length > 0) {
            // Auto-select first product if exact match
            const exactMatch = data.products.find(p => 
                p.name.toLowerCase() === searchTerm.toLowerCase() ||
                p.item_id === searchTerm
            );
            
            if (exactMatch) {
                selectProductFromList(exactMatch.id, exactMatch.name, exactMatch.total_quantity, exactMatch.is_duty_free);
            }
        }
    })
    .catch(error => {
        console.error('Error searching products:', error);
    });
}

// Update cart display (following trip_sales pattern)
function updateCartDisplay() {
    const transferList = document.getElementById('transferItemsList');
    const emptyState = document.getElementById('emptyTransferState');
    const completeBtn = document.getElementById('completeTransferBtn');
    const completeBtnFooter = document.getElementById('completeTransferBtnFooter');
    
    // Calculate totals
    const count = transferItemsCart.length;
    let totalCost = 0;
    
    transferItemsCart.forEach(item => {
        totalCost += item.total_cost || 0;
    });
    
    // EXACT SAME LOGIC AS PO SUPPLY
    if (transferItemsCart.length === 0) {
        if (transferList) transferList.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        if (completeBtn) completeBtn.disabled = true;
        if (completeBtnFooter) completeBtnFooter.disabled = true;
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    if (completeBtn) completeBtn.disabled = false; // Enable when items exist
    if (completeBtnFooter) completeBtnFooter.disabled = false; // Enable when items exist
    
    // Update header summary card
    updateHeaderSummary(count, totalCost);
    
    // Update cart footer summary - EXACT SAME AS PO SUPPLY
    updateCartFooterSummary(count, totalCost);
    
    // Update table display
    displayCartItems();
}

// Update header summary card
function updateHeaderSummary(count, totalCost) {
    const itemCountElement = document.getElementById('transferItemCount');
    const totalCostElement = document.getElementById('transferTotalCost');
    const badgeElement = document.getElementById('itemCountBadge');
    
    if (itemCountElement) {
        itemCountElement.setAttribute('data-original', count.toString());
        itemCountElement.innerHTML = `<span data-number data-original="${count}">${window.translateNumber ? window.translateNumber(count.toString()) : count}</span>`;
    }
    
    if (totalCostElement) {
        totalCostElement.setAttribute('data-original', totalCost.toFixed(3));
        totalCostElement.innerHTML = `<span data-number data-original="${totalCost.toFixed(3)}">${window.translateNumber ? window.translateNumber(totalCost.toFixed(3)) : totalCost.toFixed(3)}</span> <span data-currency-symbol>JOD</span>`;
    }
    
    if (badgeElement) {
        badgeElement.textContent = window.translateNumber ? window.translateNumber(count.toString()) : count;
    }
}

// Update cart footer summary (following trip_sales pattern)
function updateCartFooterSummary(count, totalCost) {
    // Update summary if elements exist - EXACT SAME AS PO SUPPLY
    const cartSummaryItems = document.getElementById('cartSummaryItems');
    const cartSummaryTotal = document.getElementById('cartSummaryTotal');
    const completeBtnText = document.getElementById('completeBtnText');
    const completeFooterBtnText = document.getElementById('completeFooterBtnText');
    
    if (cartSummaryItems) {
        cartSummaryItems.innerHTML = 
            `<span data-number data-original="${count}">${window.translateNumber ? window.translateNumber(count.toString()) : count}</span>`;
    }
    
    if (cartSummaryTotal) {
        cartSummaryTotal.innerHTML = 
            `<span data-number data-original="${totalCost.toFixed(3)}">${window.translateNumber ? window.translateNumber(totalCost.toFixed(3)) : totalCost.toFixed(3)}</span> <span data-currency-symbol>JOD</span>`;
    }
    
    // Update complete button text with current stats - EXACT SAME AS PO SUPPLY
    const buttonText = `<i class="bi bi-check-circle"></i> Complete Transfer (${count} items, ${totalCost.toFixed(3)} JOD)`;
    
    if (completeBtnText) {
        completeBtnText.innerHTML = buttonText;
    }
    
    if (completeFooterBtnText) {
        completeFooterBtnText.innerHTML = buttonText;
    }
}

// Update complete button states (following trip_sales pattern)
function updateCompleteButtons(count, totalCost) {
    const completeBtn = document.getElementById('completeTransferBtn');
    const completeBtnFooter = document.getElementById('completeTransferBtnFooter');
    const completeBtnText = document.getElementById('completeBtnText');
    const completeFooterBtnText = document.getElementById('completeFooterBtnText');
    
    // EXACT SAME FORMAT AS PO SUPPLY: Complete PO (${count} items, ${totalCost} JOD)
    const buttonText = `<i class="bi bi-check-circle"></i> Complete Transfer (${count} items, ${totalCost.toFixed(3)} JOD)`;
    
    if (completeBtn) {
        completeBtn.disabled = count === 0;
        if (completeBtnText) {
            completeBtnText.innerHTML = buttonText;
        }
    }
    
    if (completeBtnFooter) {
        completeBtnFooter.disabled = count === 0;
        if (completeFooterBtnText) {
            completeFooterBtnText.innerHTML = buttonText;
        }
    }
}

// Display cart items in table (following trip_sales pattern)
function displayCartItems() {
    const transferList = document.getElementById('transferItemsList');
    if (!transferList) return;
    
    const rows = transferItemsCart.map((item, index) => {
        const totalCost = item.total_cost || 0;
        
        return `
            <tr>
                <td>
                    <div>
                        <strong>${item.product_name}</strong>
                        <small class="text-muted d-block">${window._ ? window._('id_label') : 'ID'}: <span data-number data-original="${item.product_item_id}">${window.translateNumber ? window.translateNumber(item.product_item_id) : item.product_item_id}</span></small>
                        ${item.is_duty_free ? '<br><span class="badge bg-warning">Duty Free</span>' : ''}
                    </div>
                </td>
                <td class="text-center">
                    <span class="fw-bold text-primary">
                        <span data-number data-original="${item.quantity}">${window.translateNumber ? window.translateNumber(item.quantity.toString()) : item.quantity}</span>
                    </span>
                </td>
                <td class="text-end">
                    <div class="fw-bold text-success">
                        <span data-number data-original="${totalCost.toFixed(3)}">${window.translateNumber ? window.translateNumber(totalCost.toFixed(3)) : totalCost.toFixed(3)}</span> <span data-currency-symbol>JOD</span>
                    </div>
                </td>
                <td>
                    <small class="text-muted">${item.notes || '-'}</small>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editTransferItem(${index})" title="${window._ ? window._('edit_item') : 'Edit'}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="removeTransferItem(${index})" title="${window._ ? window._('remove_item') : 'Remove'}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    transferList.innerHTML = rows;
    
    // Apply translations after DOM update
    setTimeout(() => {
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
    }, 100);
}

async function addTransferItem() {
    if (!selectedProduct) return;
    
    const quantityInput = document.getElementById('transferQuantity');
    const notesInput = document.getElementById('transferNotes');
    const addBtn = document.getElementById('addTransferBtn');
    
    const quantity = parseInt(quantityInput.value);
    const notes = notesInput.value.trim();
    
    // Show loading state
    const originalBtnText = addBtn.innerHTML;
    addBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${window._ ? window._('calculating_cost') : 'Calculating cost...'}`;
    addBtn.disabled = true;
    
    try {
        // Calculate actual FIFO cost
        const costData = await calculateFIFOCost(selectedProduct.id, quantity);
        
        const transferItem = {
            product_id: selectedProduct.id,
            product_name: selectedProduct.name,
            product_item_id: selectedProduct.item_id || selectedProduct.id,
            quantity: quantity,
            // REMOVED: No unit_cost storage - only total_cost
            total_cost: costData.total_cost,
            fifo_breakdown: costData.fifo_breakdown,
            notes: notes,
            is_duty_free: selectedProduct.is_duty_free || false
        };
        
        // Following po_supply logic exactly
        if (editingIndex >= 0) {
            transferItemsCart[editingIndex] = transferItem;
            editingIndex = -1;
            exitEditMode();
        } else {
            transferItemsCart.push(transferItem);
        }
        
        saveCartToStorage();
        updateCartDisplay();
        clearForm();
        
        // Refresh available products to show "In Cart" status
        displayAvailableProducts(availableProducts);
        
        window.showAlert(window._ ? window._('item_added_success') : 'Item added successfully!', 'success');
        
        // Focus back to search field for next item
        document.getElementById('productSearch').focus();
        
    } catch (error) {
        console.error('Error adding transfer item:', error);
        window.showAlert(window._ ? window._('error_calculating_cost') : 'Error calculating cost. Please try again.', 'danger');
    } finally {
        // Restore button
        addBtn.innerHTML = originalBtnText;
        validateTransferForm();
    }
}

function validateTransferForm() {
    const quantityInput = document.getElementById('transferQuantity');
    const addBtn = document.getElementById('addTransferBtn');
    const addBtnText = document.getElementById('addBtnText');
    
    // FIXED: Return early if essential elements don't exist
    if (!addBtn || !addBtnText || !quantityInput) {
        console.warn('validateTransferForm: Essential form elements not found');
        return;
    }
    
    const hasProduct = selectedProduct && selectedProduct.id;
    const quantity = parseInt(quantityInput.value) || 0;
    const hasValidQuantity = quantity > 0;
    const availableStock = selectedProduct?.available_stock || selectedProduct?.total_quantity || 0;
    const isWithinStock = quantity <= availableStock;
    
    let isValid = hasProduct && hasValidQuantity && isWithinStock;
    let buttonText = editingIndex >= 0 ? (window._ ? window._('update_item') : 'Update Item') : (window._ ? window._('add_to_transfer') : 'Add to Transfer');
    let buttonClass = 'btn btn-warning';
    
    // Check for duplicate product (ONLY when not editing)
    if (selectedProduct && editingIndex === -1) {
        const existingIndex = transferItemsCart.findIndex(item => item.product_id === selectedProduct.id);
        if (existingIndex !== -1) {
            isValid = false;
            buttonText = window._ ? window._('already_in_cart') : 'Already in Cart';
            buttonClass = 'btn btn-secondary';
        }
    }
    
    // Validation messages
    if (!hasProduct) {
        buttonText = window._ ? window._('select_product_first') : 'Select product first';
        buttonClass = 'btn btn-warning';
        isValid = false;
    } else if (!hasValidQuantity) {
        buttonText = window._ ? window._('enter_valid_quantity') : 'Enter valid quantity';
        buttonClass = 'btn btn-warning';
        isValid = false;
    } else if (!isWithinStock) {
        buttonText = window._ ? window._('insufficient_inventory') : 'Insufficient inventory';
        buttonClass = 'btn btn-warning';
        isValid = false;
    }
    
    addBtn.disabled = !isValid;
    addBtn.className = buttonClass;
    addBtnText.textContent = buttonText;
}

function editTransferItem(index) {
    if (index < 0 || index >= transferItemsCart.length) {
        window.showAlert(window._ ? window._('invalid_item_edit') : 'Invalid item selected for editing.', 'error');
        return;
    }
    
    const item = transferItemsCart[index];
    
    // Set edit mode FIRST
    editingIndex = index;
    
    // FIXED: Update UI with null checks
    const formTitle = document.getElementById('formTitle');
    const addBtnText = document.getElementById('addBtnText');
    
    if (formTitle) {
        formTitle.innerHTML = '<i class="bi bi-pencil"></i> ' + (window._ ? window._('edit_transfer_item') : 'Edit Transfer Item');
    }
    if (addBtnText) {
        addBtnText.textContent = window._ ? window._('update_item') : 'Update Item';
    }
    
    // Find the product in available products
    selectedProduct = availableProducts.find(p => p.id === item.product_id);
    
    if (selectedProduct) {
        // FIXED: Populate form fields with null checks
        const productSearch = document.getElementById('productSearch');
        const transferQuantity = document.getElementById('transferQuantity');
        const transferNotes = document.getElementById('transferNotes');
        const productName = document.getElementById('productName');
        const productInfo = document.getElementById('productInfo');
        const availableStock = document.getElementById('availableStock');
        const dutyFreeWarning = document.getElementById('dutyFreeWarning');
        
        if (productSearch) productSearch.value = item.product_name;
        if (transferQuantity) transferQuantity.value = item.quantity;
        if (transferNotes) transferNotes.value = item.notes || '';
        
        // Show product info
        if (productName) productName.textContent = item.product_name;
        if (productInfo) productInfo.style.display = 'block';
        
        // Update stock info
        if (availableStock) {
            const availableStockValue = selectedProduct.total_quantity || selectedProduct.available_stock;
            const availableText = window._ ? window._('available') : 'Available:';
            const unitsText = window._ ? window._('units') : 'units';
            availableStock.innerHTML = `<span data-translate="available">${availableText}</span> <strong>${availableStockValue}</strong> <span data-translate="units">${unitsText}</span>`;
        }
        
        // Show/hide duty-free warning
        if (dutyFreeWarning) {
            dutyFreeWarning.style.display = item.is_duty_free ? 'block' : 'none';
        }
        
        // EXPLICITLY enable inputs
        if (transferQuantity) {
            transferQuantity.disabled = false;
            transferQuantity.max = selectedProduct.total_quantity || selectedProduct.available_stock;
        }
        
        // Update validation
        validateTransferForm();
        
        // Scroll to form
        const addTransferForm = document.getElementById('addTransferForm');
        if (addTransferForm) {
            addTransferForm.scrollIntoView({ behavior: 'smooth' });
        }
    }
}

// Remove transfer item (following trip_sales pattern)
async function removeTransferItem(index) {
    const confirmed = await window.confirmTranslated('remove_cart_item');
    if (confirmed) {
        transferItemsCart.splice(index, 1);
        saveCartToStorage();
        updateCartDisplay();
        window.showAlert(window._ ? window._('item_removed') : 'Item removed from cart.', 'info');
    }
}

function loadCompletedTransferData() {
    try {
        const transferData = JSON.parse(document.getElementById('transferData').textContent);
        const completedTransfers = transferData.completedTransfers || [];
        
        console.log('Loading completed transfers:', completedTransfers);
        
        if (completedTransfers && completedTransfers.length > 0) {
            displayCompletedTransfers(completedTransfers);
            updateCompletedTransferTotals(completedTransfers);
        } else {
            showEmptyCompletedState();
        }
    } catch (e) {
        console.error('Error loading completed transfers:', e);
        showEmptyCompletedState();
    }
}

// Display completed transfers in table (following trip_sales pattern)
function displayCompletedTransfers(completedTransfers) {
    const transfersList = document.getElementById('completedTransfersList');
    const emptyState = document.getElementById('emptyCompletedState');
    
    if (!transfersList) {
        console.log('ðŸ” completedTransfersList element not found');
        return;
    }
    
    // Update count with number translation
    const transfersListCount = document.getElementById('transferItemCount');
    if (transfersListCount) {
        transfersListCount.innerHTML = `<span data-number data-original="${completedTransfers.length}">${window.translateNumber ? window.translateNumber(completedTransfers.length.toString()) : completedTransfers.length}</span>`;
    }
    
    if (completedTransfers.length === 0) {
        console.log('ðŸ” No completed transfers found, showing empty state');
        transfersList.innerHTML = '';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    // Build table rows that match the current table structure
    const rows = completedTransfers.map((item, index) => {
        return `
            <tr>
                <td><small class="text-muted">${item.created_at || '-'}</small></td>
                <td>
                    <div>
                        <strong>${item.product_name}</strong>
                        <div class="small text-muted">
                            <span data-number data-original="${item.product_item_id}">${window.translateNumber ? window.translateNumber(item.product_item_id) : item.product_item_id}</span>
                        </div>
                        ${item.is_duty_free ? '<span class="badge bg-warning">Duty Free</span>' : ''}
                    </div>
                </td>
                <td class="text-center">
                    <span class="fw-bold text-primary">
                        <span data-number data-original="${item.quantity}">${window.translateNumber ? window.translateNumber(item.quantity.toString()) : item.quantity}</span>
                    </span>
                </td>
                <td class="text-end">
                    <span class="fw-bold text-success">
                        <span data-number data-original="${item.total_amount.toFixed(3)}">${window.translateNumber ? window.translateNumber(item.total_amount.toFixed(3)) : item.total_amount.toFixed(3)}</span> <span data-currency-symbol>JOD</span>
                    </span>
                </td>
                <td class="text-end">
                    <small class="text-muted">${item.notes || '-'}</small>
                </td>
            </tr>
        `;
    }).join('');
    
    transfersList.innerHTML = rows;
    
    // Apply translations after DOM update
    setTimeout(() => {
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
    }, 100);
}

function showEmptyCompletedState() {
    const tbody = document.getElementById('completedTransfersList');
    const emptyState = document.getElementById('emptyCompletedState');
    
    if (tbody) tbody.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
}

function updateCompletedTransferTotals(completedTransfers) {
    // Calculate totals from completed transfers data
    let totalCost = 0;
    let itemCount = completedTransfers.length;
    
    completedTransfers.forEach(item => {
        totalCost += item.total_amount;
    });
    
    // Update cost display for completed transfers
    const costElement = document.getElementById('transferTotalCost');
    if (costElement) {
        costElement.setAttribute('data-original', totalCost.toFixed(3));
        costElement.innerHTML = `<span data-number data-original="${totalCost.toFixed(3)}">${window.translateNumber ? window.translateNumber(totalCost.toFixed(3)) : totalCost.toFixed(3)}</span> <span data-currency-symbol>JOD</span>`;
    }
    
    // Update item count for completed transfers  
    const itemCountElement = document.getElementById('transferItemCount');
    if (itemCountElement) {
        itemCountElement.setAttribute('data-original', itemCount.toString());
        itemCountElement.innerHTML = `<span data-number data-original="${itemCount}">${window.translateNumber ? window.translateNumber(itemCount.toString()) : itemCount}</span>`;
    }
    
    console.log('Completed transfer totals updated');
}

function cleanupExistingCartItems() {
    transferItemsCart.forEach(item => {
        // Remove any legacy unit_cost properties if they exist
        if (item.unit_cost !== undefined) {
            delete item.unit_cost;
        }
        // Ensure total_cost exists
        if (!item.total_cost && item.quantity && item.unit_price) {
            item.total_cost = item.quantity * item.unit_price;
        }
    });
}

function exitEditMode() {
    editingIndex = -1;
    
    // FIXED: Add null checks before setting properties
    const formTitle = document.getElementById('formTitle');
    const addBtnText = document.getElementById('addBtnText');
    
    if (formTitle) {
        formTitle.innerHTML = '<i class="bi bi-plus-circle"></i> ' + (window._ ? window._('add_transfer_item') : 'Add Transfer Item');
    }
    
    if (addBtnText) {
        addBtnText.textContent = window._ ? window._('add_to_transfer') : 'Add to Transfer';
    }
    
    clearForm();
}

// Clear form (following trip_sales pattern)
function clearForm() {
    // FIXED: Add null checks for all elements
    const productSearch = document.getElementById('productSearch');
    const transferQuantity = document.getElementById('transferQuantity');
    const transferNotes = document.getElementById('transferNotes');
    const formTitle = document.getElementById('formTitle');
    const addBtnText = document.getElementById('addBtnText');
    
    // Reset form fields
    if (productSearch) productSearch.value = '';
    if (transferQuantity) transferQuantity.value = '';
    if (transferNotes) transferNotes.value = '';
    
    // Reset edit mode
    editingIndex = -1;
    
    if (formTitle) {
        formTitle.innerHTML = '<i class="bi bi-plus-circle"></i> ' + (window._ ? window._('add_transfer_item') : 'Add Transfer Item');
    }
    
    if (addBtnText) {
        addBtnText.textContent = window._ ? window._('add_to_transfer') : 'Add to Transfer';
    }
    
    // Clear product selection
    clearProductSelection();
}

function clearProductSelection() {
    selectedProduct = null;
    
    // FIXED: Add null checks
    const productInfo = document.getElementById('productInfo');
    const transferQuantity = document.getElementById('transferQuantity');
    const addTransferBtn = document.getElementById('addTransferBtn');
    const addBtnText = document.getElementById('addBtnText');
    const availableStock = document.getElementById('availableStock');
    const dutyFreeWarning = document.getElementById('dutyFreeWarning');
    
    if (productInfo) productInfo.style.display = 'none';
    if (transferQuantity) transferQuantity.disabled = true;
    if (addTransferBtn) {
        addTransferBtn.disabled = true;
        addTransferBtn.className = 'btn btn-warning';
    }
    if (addBtnText) {
        addBtnText.textContent = window._ ? window._('select_product_first') : 'Select product first';
    }
    if (availableStock) {
        availableStock.innerHTML = '<span data-translate="select_product_first">' + (window._ ? window._('select_product_first') : 'Select product first') + '</span>';
    }
    if (dutyFreeWarning) {
        dutyFreeWarning.style.display = 'none';
    }
}

// Cancel edit mode (following trip_sales pattern)
async function cancelEdit() {
    if (editingIndex >= 0) {
        exitEditMode();
        clearForm();
        return;
    }
    
    await window.standardizeCancelOperation(
        'transfer', 
        document.getElementById('transferId').value,
        '/transfer/cancel/',
        '/transfer/'
    );
}

// Complete transfer (following trip_sales pattern - FIXES the session ID error)
async function completeTransfer() {
    if (transferItemsCart.length === 0) {
        window.showAlert(window._ ? window._('add_one_item_first') : 'Please add at least one item to complete the transfer.', 'warning');
        return;
    }
    
    const totalCost = transferItemsCart.reduce((sum, item) => sum + (item.total_cost || 0), 0);
    
    const confirmed = await window.confirmTranslated('complete_transfer_confirm', {
        count: transferItemsCart.length,
        cost: totalCost.toFixed(3)
    });
    
    if (!confirmed) return;
    
    const completeBtn = document.getElementById('completeTransferBtn');
    const completeBtnFooter = document.getElementById('completeTransferBtnFooter');
    const originalText = completeBtn ? completeBtn.innerHTML : '';
    const originalFooterText = completeBtnFooter ? completeBtnFooter.innerHTML : '';
    
    // Show loading state
    const loadingText = `<span class="spinner-border spinner-border-sm"></span> ${window._ ? window._('completing') : 'Completing...'}`;
    if (completeBtn) {
        completeBtn.innerHTML = loadingText;
        completeBtn.disabled = true;
    }
    if (completeBtnFooter) {
        completeBtnFooter.innerHTML = loadingText;
        completeBtnFooter.disabled = true;
    }
    
    try {
        // FIXED: Use transfer_id instead of transfer_session_id
        const transferId = document.getElementById('transferId').value;
        
        const response = await fetch('/transfer/bulk-complete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.getCsrfToken()
            },
            body: JSON.stringify({
                transfer_id: parseInt(transferId), // FIXED: Use transfer_id
                items: transferItemsCart.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity,
                    notes: item.notes || ''
                }))
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear cart from localStorage
            const storageKey = `transfer_items_${transferId}`;
            localStorage.removeItem(storageKey);
            
            // Show success message
            window.showAlert(data.message || (window._ ? window._('transfer_completed') : 'Transfer completed successfully!'), 'success');
            
            // Redirect to transfer items page to show completed state
            setTimeout(() => {
                window.location.href = `/transfer/${transferId}/`;
            }, 1500);
            
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
        
    } catch (error) {
        console.error('Error completing transfer:', error);
        window.showAlert(window._ ? window._('error_completing_transfer') : 'Error completing transfer. Please try again.', 'danger');
        
        // Restore buttons
        if (completeBtn) {
            completeBtn.innerHTML = originalText;
            completeBtn.disabled = false;
        }
        if (completeBtnFooter) {
            completeBtnFooter.innerHTML = originalFooterText;
            completeBtnFooter.disabled = false;
        }
    }
}
</script>
{% endblock %}