{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}All Transactions - Vessel Sales System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-list-ul text-primary"></i> 
                    <span data-translate="all_transactions">All Transactions</span>
                </h2>
                <p class="text-muted mb-0"><span data-translate="complete_transaction_history">Complete transaction history across all vessels</span></p>
            </div>
            <a href="{% url 'frontend:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> <span data-translate="back_to_dashboard">Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> <span data-translate="filter_transactions">Filter Transactions</span>
                </h5>
            </div>
            <div class="card-body">
                <form method="GET">
                    <div class="row g-3">
                        <div class="col-lg-2 col-md-4">
                            <label class="form-label fw-bold"><span data-translate="transaction_type">Transaction Type</span></label>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
                                        id="transactionTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="selectedTransactionTypeText">
                                        {% if current_filters.transaction_type %}
                                            {% for code, display in transaction_types %}
                                                {% if code == current_filters.transaction_type %}
                                                    {{ display }}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span data-translate="all_types">All Types</span>
                                        {% endif %}
                                    </span>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="transactionTypeDropdown">
                                    <li><a class="dropdown-item" href="#" data-value="" onclick="selectTransactionType('', this)">
                                        <span data-translate="all_types">All Types</span>
                                    </a></li>
                                    {% for code, display in transaction_types %}
                                    <li><a class="dropdown-item {% if code == current_filters.transaction_type %}active{% endif %}" 
                                           href="#" data-value="{{ code }}" onclick="selectTransactionType('{{ code }}', this)">
                                        <i class="bi bi-arrow-repeat me-2"></i>
                                        {{ display }}
                                    </a></li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="transaction_type" id="transactionTypeInput" value="{{ current_filters.transaction_type|default:'' }}">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <label class="form-label fw-bold"><span data-translate="vessel">Vessel</span></label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" 
                                        id="vesselDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="selectedVesselText">
                                        {% if current_filters.vessel %}
                                            {% for vessel in vessels %}
                                                {% if vessel.id|stringformat:"s" == current_filters.vessel %}
                                                    <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span data-translate="all_vessels">All Vessels</span>
                                        {% endif %}
                                    </span>
                                </button>
                                <ul class="dropdown-menu w-100" aria-labelledby="vesselDropdown">
                                    <li><a class="dropdown-item" href="#" data-value="" onclick="selectVessel('', this)">
                                        <span data-translate="all_vessels">All Vessels</span>
                                    </a></li>
                                    {% for vessel in vessels %}
                                    <li><a class="dropdown-item {% if vessel.id|stringformat:'s' == current_filters.vessel %}active{% endif %}" 
                                           href="#" data-value="{{ vessel.id }}" onclick="selectVessel('{{ vessel.id }}', this)">
                                        <i class="bi bi-ship me-2"></i>
                                        <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                    </a></li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="vessel" id="vesselInput" value="{{ current_filters.vessel|default:'' }}">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4">
                            <label class="form-label fw-bold"><span data-translate="search_products">Search Products</span></label>
                            <div class="search-dropdown-container position-relative">
                                <input type="text" 
                                       class="form-control" 
                                       id="product-search" 
                                       placeholder="Name, Item ID..."
                                       data-placeholder-en="Name, Item ID..."
                                       data-placeholder-ar="الاسم، رقم الصنف،..."
                                       autocomplete="off"
                                       data-translate-placeholder="search_product_placeholder">
                                <select class="form-select d-none" name="product" id="product-select">
                                    <option value=""><span data-translate="all_products">All Products</span></option>
                                    {% for product in products %}
                                    <option value="{{ product.id }}" 
                                            data-name="{{ product.name|lower }}" 
                                            data-item-id="{{ product.item_id|lower }}"
                                            {% if current_filters.product == product.id|stringformat:"s" %}selected{% endif %}>
                                        {{ product.item_id }} - {{ product.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <label class="form-label fw-bold"><span data-translate="from_date">From Date</span></label>
                            <input type="date" class="form-control" name="date_from" value="{{ current_filters.date_from }}">
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <label class="form-label fw-bold"><span data-translate="to_date">To Date</span></label>
                            <input type="date" class="form-control" name="date_to" value="{{ current_filters.date_to }}">
                        </div>
                        <div class="col-lg-2 col-md-12 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel"></i> <span data-translate="filter">Filter</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> <span data-translate="recent_transactions">Recent Transactions</span> (<span dir="ltr" data-translate="latest_200">Latest 200</span>)
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success btn-sm" onclick="exportTransactions(this)">
                        <i class="bi bi-file-earmark-excel"></i> <span data-translate="export">Export</span>
                    </button>
                    <a href="?{% if current_filters.transaction_type %}transaction_type={{ current_filters.transaction_type }}&{% endif %}{% if current_filters.vessel %}vessel={{ current_filters.vessel }}&{% endif %}{% if current_filters.product %}product={{ current_filters.product }}&{% endif %}{% if current_filters.date_from %}date_from={{ current_filters.date_from }}&{% endif %}{% if current_filters.date_to %}date_to={{ current_filters.date_to }}&{% endif %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> <span data-translate="refresh">Refresh</span>
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><span data-translate="date">Date</span></th>
                                <th><span data-translate="type">Type</span></th>
                                <th><span data-translate="vessel">Vessel</span></th>
                                <th><span data-translate="product">Product</span></th>
                                <th class="text-center"><span data-translate="quantity">Quantity</span></th>
                                <th class="text-end"><span data-translate="amount">Amount</span></th>
                                <th><span data-translate="trip_po">Trip/PO</span></th>
                                <th><span data-translate="notes">Notes</span></th>
                                <th><span data-translate="created_by">Created By</span></th>
                                <th class="text-center"><span data-translate="actions">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>
                                    <div class="transaction-date" data-date="{{ transaction.transaction_date|date:"d-m-Y" }}">{{ transaction.transaction_date|date:"d-m-Y" }}</div>
                                    <small class="text-muted transaction-time" data-time="{{ transaction.created_at|time:"H:i" }}">{{ transaction.created_at|time:"H:i" }}</small>
                                </td>
                                <td>
                                    <span class="badge {% if transaction.transaction_type == 'SALE' %}bg-success{% elif transaction.transaction_type == 'SUPPLY' %}bg-primary{% elif transaction.transaction_type == 'TRANSFER_OUT' %}bg-warning{% elif transaction.transaction_type == 'TRANSFER_IN' %}bg-info{% elif transaction.transaction_type == 'WASTE' %}bg-danger{% endif %}">
                                        <span data-translate="transaction_{{ transaction.transaction_type|lower }}">{{ transaction.get_transaction_type_display }}</span>
                                    </span>
                                </td>
                                <td>
                                    <span class="vessel-name" data-en="{{ transaction.vessel.name }}" data-ar="{{ transaction.vessel.name_ar }}">{{ transaction.vessel.name }}</span>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ transaction.product.name }}</strong>
                                        <small class="text-muted d-block">{{ transaction.product.item_id }}</small>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold transaction-quantity" data-number data-original="{{ transaction.quantity|floatformat:0 }}">{{ transaction.quantity|floatformat:0 }}</span>
                                    <small class="text-muted d-block"><span data-translate="units">units</span></small>
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold transaction-amount" data-number data-original="{{ transaction.total_amount|floatformat:3 }}">{{ transaction.total_amount|floatformat:3 }}</span>
                                    <small class="text-muted d-block"><span data-currency-symbol>JOD</span></small>
                                </td>
                                <td>
                                    {% if transaction.trip %}
                                        <a href="{% url 'frontend:trip_sales' transaction.trip.id %}" class="text-decoration-none">
                                            <small><i class="bi bi-ship"></i> {{ transaction.trip.trip_number }}</small>
                                        </a>
                                    {% elif transaction.purchase_order %}
                                        <a href="{% url 'frontend:po_supply' transaction.purchase_order.id %}" class="text-decoration-none">
                                            <small><i class="bi bi-receipt"></i> {{ transaction.purchase_order.po_number }}</small>
                                        </a>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span data-notes="{{ transaction.notes }}" class="transaction-notes">
                                        {{ transaction.notes|default:"-" }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ transaction.created_by.username|default:"System" }}</small>
                                    <small class="text-muted d-block transaction-time-ago" data-time="{{ transaction.created_at|timesince }}">{{ transaction.created_at|timesince }} ago</small>
                                </td>
                                <td class="text-center">
                                    {% if user_permissions.is_admin_or_manager %}
                                    <button 
                                        class="btn btn-outline-danger btn-sm" 
                                        onclick="this.blur(); deleteTransaction({% if transaction.transaction_type == 'TRANSFER_IN' and transaction.related_transfer %}{{ transaction.related_transfer.id }}{% else %}{{ transaction.id }}{% endif %}, {% if transaction.transaction_type == 'TRANSFER_IN' %}'TRANSFER_OUT'{% else %}'{{ transaction.transaction_type }}'{% endif %}, '{{ transaction.product.name }}', '{{ transaction.vessel.name }}')"
                                        title="Delete Transaction{% if transaction.transaction_type == 'TRANSFER_IN' %} (deletes both transfer transactions){% endif %}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% else %}
                                    <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center text-muted py-5">
                                    <i class="bi bi-list-ul" style="font-size: 2.5rem; opacity: 0.5;"></i>
                                    <p class="mt-3 mb-1 fw-bold"><span data-translate="no_transactions_found">No transactions found</span></p>
                                    <small class="text-muted"><span data-translate="try_adjusting_filters">Try adjusting your filter criteria</span></small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Footer -->
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <span data-translate="showing_latest_200">Showing latest 200 transactions</span>
                                {% if current_filters.transaction_type or current_filters.vessel or current_filters.product or current_filters.date_from or current_filters.date_to %}
                                (<span dir="ltr" data-translate="filtered">filtered</span>)
                                {% endif %}
                            </small>
                        </div>
                        {% if current_filters.transaction_type or current_filters.vessel or current_filters.product or current_filters.date_from or current_filters.date_to %}
                        <div>
                            <a href="{% url 'frontend:transactions_list' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> <span data-translate="clear_filters">Clear Filters</span>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADD THIS PAGINATION SECTION -->
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Transactions pagination">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">&laquo; First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        
        <p class="text-center text-muted">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} transactions
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'frontend/js/transactions_list.js' %}"></script>

<!-- Notes Display Script -->
<script src="{% static 'frontend/js/notes-display.js' %}"></script>
{% endblock %}