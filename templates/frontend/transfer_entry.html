{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Transfer Entry - Vessel Sales System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-arrow-left-right text-warning"></i> 
                    <span data-translate="transfer_entry">Transfer Entry</span>
                </h2>
                <p class="text-muted mb-0"><span data-translate="transfer_entry_desc">Create new transfer and move inventory between vessels</span></p>
            </div>
            <a href="{% url 'frontend:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> <span data-translate="back_to_dashboard">Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Transfer Creation Form -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i> <span data-translate="create_new_transfer">Create New Transfer</span>
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="transferForm">
                    {% csrf_token %}
                    
                    <!-- Vessel Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-danger"></i> <span data-translate="from_vessel_source">From Vessel (Source)</span> *
                            </label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start btn-lg" type="button" 
                                        id="fromVesselDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="selectedFromVesselText">
                                        <span data-translate="choose_source_vessel">Choose source vessel...</span>
                                    </span>
                                </button>
                                <ul class="dropdown-menu w-100" aria-labelledby="fromVesselDropdown">
                                    {% for vessel in vessels %}
                                    <li><a class="dropdown-item" href="#" data-value="{{ vessel.id }}" 
                                           data-name="{{ vessel.name }}" data-name-ar="{{ vessel.name_ar }}" 
                                           data-duty-free="{{ vessel.has_duty_free }}" 
                                           onclick="selectFromVessel('{{ vessel.id }}', this, '{{ vessel.name }}', '{{ vessel.name_ar }}', {{ vessel.has_duty_free|yesno:'true,false' }})">
                                        <i class="bi bi-ship me-2 text-danger"></i>
                                        <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                        {% if vessel.has_duty_free %}<span class="badge bg-success ms-2"><span data-translate="duty_free">Duty-Free</span></span>{% endif %}
                                    </a></li>
                                    {% endfor %}
                                </ul>
                                <input type="hidden" name="from_vessel" id="fromVesselInput" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-success"></i> <span data-translate="to_vessel_destination">To Vessel (Destination)</span> *
                            </label>
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start btn-lg" type="button" 
                                        id="toVesselDropdown" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                    <span id="selectedToVesselText">
                                        <span data-translate="first_select_source_vessel">First select source vessel...</span>
                                    </span>
                                </button>
                                <ul class="dropdown-menu w-100" aria-labelledby="toVesselDropdown" id="toVesselDropdownMenu">
                                    <!-- Dynamically populated -->
                                </ul>
                                <input type="hidden" name="to_vessel" id="toVesselInput" required>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Date -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> <span data-translate="transfer_date">Transfer Date</span> *
                            </label>
                            <input type="date" class="form-control form-control-lg" name="transfer_date" value="{{ today|date:'Y-m-d' }}" required>
                        </div>
                    </div>

                    <!-- Transfer Notes -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-chat-left-text"></i> <span data-translate="transfer_notes">Transfer Notes (Optional)</span>
                        </label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  data-placeholder-en="Additional notes about this transfer..."
                                  data-placeholder-ar="ملاحظات إضافية عن هذا التحويل..."
                                  placeholder="Additional notes about this transfer..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary btn-lg me-md-2" onclick="clearForm()">
                            <i class="bi bi-x-circle"></i> <span data-translate="clear_form">Clear Form</span>
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="bi bi-arrow-right"></i> <span data-translate="create_transfer_add_items">Create Transfer & Add Items</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transfers -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> <span data-translate="recent_transfers">Recent Transfers</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-calendar"></i> <span data-translate="date">Date</span></th>
                                <th><i class="bi bi-ship"></i> <span data-translate="from_to">From → To</span></th>
                                <th><i class="bi bi-box"></i> <span data-translate="num_of_items"># of Items</span></th>
                                <th><i class="bi bi-check-circle"></i> <span data-translate="status">Status</span></th>
                                <th><i class="bi bi-person"></i> <span data-translate="by">By</span></th>
                                <th><i class="bi bi-gear"></i> <span data-translate="actions">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transfer in recent_transfers %}
                            <tr {% if not transfer.is_completed %}class="table-warning cursor-pointer" onclick="resumeTransfer({{ transfer.id }})" title="Click to resume this transfer"{% endif %} data-transfer-id="{{ transfer.id }}" data-completed="{{ transfer.is_completed }}">
                                <td>
                                    <span data-transfer-date data-original="{{ transfer.transfer_date|date:'d-m-Y' }}">{{ transfer.transfer_date|date:"d-m-Y" }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-ship text-danger me-1"></i>
                                        <span class="vessel-name me-2" data-en="{{ transfer.from_vessel.name }}" data-ar="{{ transfer.from_vessel.name_ar }}">{{ transfer.from_vessel.name }}</span>
                                        <span data-translate="→">→</span>
                                        <i class="bi bi-ship text-success me-1"></i>
                                        <span class="vessel-name" data-en="{{ transfer.to_vessel.name }}" data-ar="{{ transfer.to_vessel.name_ar }}">{{ transfer.to_vessel.name }}</span>
                                    </div>
                                    {% if not transfer.is_completed %}
                                        <small class="text-muted d-block"><span data-translate="click_to_resume">Click to resume</span></small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="fw-bold text-warning">{{ transfer.transaction_count }}</span>
                                    {% if not transfer.is_completed %}
                                        <small class="text-muted d-block">
                                            <span data-translate="click_to_resume_transfer">Click to resume this transfer</span>
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transfer.is_completed %}
                                        <span class="badge bg-success"><span data-translate="completed">Completed</span></span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark"><span data-translate="in_progress">In Progress</span></span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ transfer.created_by.username|default:"System" }}</small>
                                    <small class="text-muted d-block transaction-time" data-time="{{ transfer.created_at|timesince }}">{{ transfer.created_at|timesince }} <span data-translate="ago">ago</span></small>
                                </td>
                                <td>
                                    {% if not transfer.is_completed %}
                                        <a href="{% url 'frontend:transfer_items' transfer.id %}" class="btn btn-warning btn-sm">
                                            <i class="bi bi-plus"></i> <span data-translate="add_items">Add Items</span>
                                        </a>
                                    {% else %}
                                        <button class="btn btn-outline-secondary btn-sm" onclick="viewTransferDetails('{{ transfer.id }}')" title="View Details">
                                            <i class="bi bi-eye"></i> <span data-translate="view">View</span>
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-arrow-left-right" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0" data-translate="no_transfers_yet">No transfers recorded yet</p>
                                    <small data-translate="create_first_transfer">Create your first transfer using the form above</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Add page-specific translations
document.addEventListener('DOMContentLoaded', function() {
    window.initializePage({
        titleKey: 'transfer_entry',
        fallbackTitle: 'Transfer Entry',
    })    
    // Apply translations
    updatePageTranslations();
});

// From Vessel dropdown selection handler
function selectFromVessel(vesselId, element, vesselNameEn, vesselNameAr, hasDutyFree) {
    // Update hidden input
    document.getElementById('fromVesselInput').value = vesselId;
    
    // Update button text
    const buttonText = document.getElementById('selectedFromVesselText');
    buttonText.innerHTML = element.innerHTML;
    
    // Update active state
    document.querySelectorAll('#fromVesselDropdown + .dropdown-menu .dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('fromVesselDropdown'));
    if (dropdown) {
        dropdown.hide();
    }
    
    // Populate destination vessel dropdown (exclude source vessel)
    populateToVesselDropdown(vesselId);
    
    // Clear any previous selection for destination
    document.getElementById('toVesselInput').value = '';
    document.getElementById('selectedToVesselText').innerHTML = '<span data-translate="choose_destination_vessel">Choose destination vessel...</span>';
    
    // Prevent default link behavior
    event.preventDefault();
    return false;
}

// To Vessel dropdown selection handler
function selectToVessel(vesselId, element, vesselNameEn, vesselNameAr, hasDutyFree) {
    // Update hidden input
    document.getElementById('toVesselInput').value = vesselId;
    
    // Update button text
    const buttonText = document.getElementById('selectedToVesselText');
    buttonText.innerHTML = element.innerHTML;
    
    // Update active state
    document.querySelectorAll('#toVesselDropdown + .dropdown-menu .dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('toVesselDropdown'));
    if (dropdown) {
        dropdown.hide();
    }
    
    // Prevent default link behavior
    event.preventDefault();
    return false;
}

function populateToVesselDropdown(excludeVesselId) {
    const toVesselMenu = document.getElementById('toVesselDropdownMenu');
    const toVesselButton = document.getElementById('toVesselDropdown');
    
    // Clear existing options
    toVesselMenu.innerHTML = '';
    
    // Get all vessels from the from vessel dropdown
    const fromVesselItems = document.querySelectorAll('#fromVesselDropdown + .dropdown-menu .dropdown-item');
    
    fromVesselItems.forEach(item => {
        const vesselId = item.getAttribute('data-value');
        const vesselName = item.getAttribute('data-name');
        const vesselNameAr = item.getAttribute('data-name-ar');
        const hasDutyFree = item.getAttribute('data-duty-free') === 'True';
        
        // Exclude the selected source vessel
        if (vesselId !== excludeVesselId) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.setAttribute('data-value', vesselId);
            a.setAttribute('data-name', vesselName);
            a.setAttribute('data-name-ar', vesselNameAr);
            a.setAttribute('data-duty-free', hasDutyFree);
            a.setAttribute('onclick', `selectToVessel('${vesselId}', this, '${vesselName}', '${vesselNameAr}', ${hasDutyFree})`);
            
            a.innerHTML = `
                <i class="bi bi-ship me-2 text-success"></i>
                <span class="vessel-name" data-en="${vesselName}" data-ar="${vesselNameAr}">${vesselName}</span>
                ${hasDutyFree ? '<span class="badge bg-success ms-2"><span data-translate="duty_free">Duty-Free</span></span>' : ''}
            `;
            
            li.appendChild(a);
            toVesselMenu.appendChild(li);
        }
    });
    
    // Enable the destination dropdown
    toVesselButton.disabled = false;
}

function clearForm() {
    document.getElementById('transferForm').reset();
    
    // Reset from vessel dropdown
    document.getElementById('fromVesselInput').value = '';
    document.getElementById('selectedFromVesselText').innerHTML = '<span data-translate="choose_source_vessel">Choose source vessel...</span>';
    document.querySelectorAll('#fromVesselDropdown + .dropdown-menu .dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Reset to vessel dropdown
    document.getElementById('toVesselInput').value = '';
    document.getElementById('selectedToVesselText').innerHTML = '<span data-translate="first_select_source_vessel">First select source vessel...</span>';
    document.getElementById('toVesselDropdown').disabled = true;
    document.getElementById('toVesselDropdownMenu').innerHTML = '';
    document.querySelectorAll('#toVesselDropdown + .dropdown-menu .dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
}

function viewTransferDetails(transferId) {
    window.location.href = `/transfer/${transferId}/`;
}

function resumeTransfer(transferId) {
    window.location.href = `/transfer/${transferId}/`;
}
</script>
{% endblock %}