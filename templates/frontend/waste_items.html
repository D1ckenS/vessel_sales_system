{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Waste Items - {{ waste_report.report_number }} - Vessel Sales System{% endblock %}

{% block extra_css %}
<style>
/* Cart summary styling - matching trip_sales */
.cart-summary-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-top: 2px solid #dee2e6;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .cart-summary-section .row {
        text-align: center !important;
    }
    
    .cart-summary-section .col-md-4 {
        margin-top: 10px;
    }
}

/* Animation for cart updates */
.cart-item-updated {
    animation: highlightUpdate 0.5s ease-in-out;
}

@keyframes highlightUpdate {
    0% { background-color: #fff3cd; }
    100% { background-color: transparent; }
}

/* Dynamic height for products table */
#productsTableContainer {
    height: auto;
    min-height: 500px;
    max-height: 1000px;
}

/* Match heights between cards */
@media (min-width: 768px) {
    .card.h-100 {
        height: auto !important;
    }
    
    .col-md-6 .card {
        min-height: 600px;
    }
}

/* Product selection hover effect */
.cursor-pointer {
    cursor: pointer;
    transition: background-color 0.2s;
}

.cursor-pointer:hover {
    background-color: rgba(0, 123, 255, 0.1);
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-trash text-danger"></i> 
                    <span data-translate="waste_items">Waste Items</span>: <span data-number data-original="{{ waste_report.report_number }}">{{ waste_report.report_number }}</span>
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-ship"></i> <span class="vessel-name" data-en="{{ waste_report.vessel.name }}" data-ar="{{ waste_report.vessel.name_ar }}">{{ waste_report.vessel.name }}</span> •
                    <i class="bi bi-calendar"></i> <span data-waste-date data-original="{{ waste_report.report_date|date:'d/m/Y' }}">{{ waste_report.report_date|date:"d/m/Y" }}</span>
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'frontend:waste_entry' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> <span data-translate="back_to_waste_entry">Back to Waste Entry</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Waste Summary Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white;">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="total_waste_cost">Total Waste Cost</span></h6>
                        <h3 class="mb-0" id="wasteRevenue">
                            <span id="waste-cost-display" data-number data-original="0.000">0.000</span> <span data-currency-symbol>JOD</span>
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="items_to_waste">Items to Waste</span></h6>
                        <h3 class="mb-0" id="itemCount">
                            <span id="waste-items-count" data-number data-original="0">0</span>
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="vessel">Vessel</span></h6>
                        <h3 class="mb-0">
                            <span class="vessel-name" data-en="{{ waste_report.vessel.name }}" data-ar="{{ waste_report.vessel.name_ar|default:waste_report.vessel.name }}">
                                {{ waste_report.vessel.name }}
                            </span>
                        </h3>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1 opacity-75"><span data-translate="status">Status</span></h6>
                        <h3 class="mb-0">
                            {% if can_edit %}
                            <span class="badge bg-warning fs-6"><span data-translate="in_progress">In Progress</span></span>
                            {% else %}
                            <span class="badge bg-success fs-6"><span data-translate="completed">Completed</span></span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    {% if can_edit %}
    <!-- LEFT SIDE: Add Waste Item Form -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0" id="formTitle">
                    <i class="bi bi-plus-circle"></i> <span data-translate="add_waste_item">Add Waste Item</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="addWasteForm">
                    <!-- Product Search -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search"></i> <span data-translate="search_products">Search Products</span>
                        </label>
                        <input type="text" id="productSearch" class="form-control form-control-lg" 
                               placeholder="Type product name or ID..."
                               data-placeholder-en="Type product name or ID..."
                               data-placeholder-ar="اكتب اسم المنتج أو الرقم...">
                    </div>

                    <!-- Selected Product Info -->
                    <div id="productInfo" style="display: none;" class="mb-3">
                        <div class="alert alert-info">
                            <strong id="productName"></strong>
                            <small class="d-block text-muted" id="productDetails"></small>
                            <small class="d-block" id="availableStock"></small>
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <span data-translate="quantity">Quantity</span>
                        </label>
                        <input type="number" id="wasteQuantity" class="form-control form-control-lg"
                        placeholder="0" disabled>
                    </div>

                    <!-- Damage Reason -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <span data-translate="damage_reason">Damage Reason</span>
                        </label>
                        <select id="damageReason" class="form-select" required>
                            <option value="" data-translate="select_damage_reason">Select damage reason...</option>
                            {% for value, label in damage_reasons %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <span data-translate="notes">Notes (Optional)</span>
                        </label>
                        <textarea id="wasteNotes" class="form-control" rows="2" 
                                  placeholder="Additional details about the waste..."
                                  data-placeholder-en="Additional details about the waste..."
                                  data-placeholder-ar="تفاصيل إضافية حول المهدر..."></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="button" id="addWasteBtn" class="btn btn-danger" disabled>
                            <i class="bi bi-plus-circle"></i> <span id="addBtnText" data-translate="add_to_waste">Add to Waste</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="bi bi-x-circle"></i> <span data-translate="clear_form">Clear Form</span>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="cancelEdit()">
                            <i class="bi bi-x-circle"></i> <span data-translate="cancel">Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- RIGHT SIDE: Available Products -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-boxes"></i> <span data-translate="available_products_for">Available products for</span> 
                    <span class="vessel-name" data-en="{{ waste_report.vessel.name }}" data-ar="{{ waste_report.vessel.name_ar }}">{{ waste_report.vessel.name }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="productsTableContainer" style="overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th><span data-translate="product_name">Product Name</span></th>
                                <th class="text-center"><span data-translate="product_id">Product ID</span></th>
                                <th class="text-end"><span data-translate="stock_available">Stock Available</span></th>
                            </tr>
                        </thead>
                        <tbody id="availableProductsList">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- For completed reports: Show summary information -->
    <div class="col-12">
        <div class="alert alert-success">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle"></i> <span data-translate="waste_report_completed">Waste Report Completed</span>
                    </h5>
                    <p class="mb-0">
                        <span data-translate="waste_report_completed_desc">This waste report has been completed and is now read-only. All items have been removed from inventory.</span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <small class="text-muted">
                        <span data-translate="completed">Completed</span>: 
                        <span data-waste-date data-original="{{ waste_report.updated_at|date:'d/m/Y H:i' }}">{{ waste_report.updated_at|date:"d/m/Y H:i" }}</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Waste Cart Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i>
                    {% if can_edit %}
                        <span data-translate="waste_cart">Waste Cart</span>
                    {% else %}
                        <span data-translate="waste_items">Waste Items</span>
                        (<span dir="ltr" id="cartItemsBadge">0</span>)
                    {% endif %}
                </h5>
                {% if can_edit %}
                <div>
                    <button type="button" id="completeWasteBtn" class="btn btn-success" disabled>
                        <i class="bi bi-check-circle"></i> <span data-translate="complete_waste_report">Complete Waste Report</span>
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body" id="cartBody">
                {% if can_edit %}
                <!-- Cart will be populated by JavaScript -->
                <div class="text-center text-muted py-4" id="emptyCart">
                    <i class="bi bi-cart display-4"></i>
                    <p class="mt-2 mb-0"><span data-translate="no_items_in_cart">No items in cart</span></p>
                    <small><span data-translate="use_form_waste">Use the form above to add waste items</span></small>
                </div>
                {% else %}
                <div id="completedWasteItems">
                    <!-- Will be populated by JavaScript for completed reports -->
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Hidden Inputs -->
<input type="hidden" id="wasteId" value="{{ waste_report.id }}">

<!-- Hidden Data -->
<script type="application/json" id="wasteData">
{
    "wasteReport": {
        "id": {{ waste_report.id }},
        "report_number": "{{ waste_report.report_number }}",
        "vessel_id": {{ waste_report.vessel.id }},
        "can_edit": {{ can_edit|yesno:"true,false" }}
    },
    "existingWasteItems": {{ existing_waste_items_json|safe }},
    "completedWasteItems": {{ completed_waste_items_json|safe }}
}
</script>
{% endblock %}

{% block extra_js %}
<script>
// Global state - following trip_sales pattern
let wasteItemsCart = [];
let selectedProduct = null;
let availableProducts = [];
let editingIndex = -1;

// Initialize page - following trip_sales pattern
document.addEventListener('DOMContentLoaded', function() {
    window.initializePage({
        titleKey: 'waste_items',
        fallbackTitle: 'Waste Items',
    })
    
    const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
    
    if (wasteData.wasteReport.can_edit) {
        // FIXED: Add localStorage persistence like trip_sales
        initializeWasteCart();
        loadAvailableProducts();
        setupEventListeners();
        updateCartDisplay();
    } else {
        displayCompletedWasteItems(wasteData.completedWasteItems || []);
    }
    
    updateWasteTotals();
});

// FIXED: Add localStorage persistence like trip_sales
function initializeWasteCart() {
    const wasteId = document.getElementById('wasteId').value;
    const storageKey = `waste_items_${wasteId}`;
    
    // Try to load from localStorage first
    const savedCart = localStorage.getItem(storageKey);
    if (savedCart) {
        try {
            wasteItemsCart = JSON.parse(savedCart);
            console.log('Loaded cart from localStorage:', wasteItemsCart);
        } catch (e) {
            console.log('Error parsing saved cart, starting fresh');
            wasteItemsCart = [];
        }
    }
    
    // If no saved cart, load from existing waste items (backend data)
    if (wasteItemsCart.length === 0) {
        const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
        if (wasteData.existingWasteItems && wasteData.existingWasteItems.length > 0) {
            wasteItemsCart = wasteData.existingWasteItems;
            console.log('Loaded cart from existing waste:', wasteItemsCart);
            saveCartToStorage();
        }
    }
}

function saveCartToStorage() {
    try {
        const wasteId = document.getElementById('wasteId').value;
        const storageKey = `waste_items_${wasteId}`;
        localStorage.setItem(storageKey, JSON.stringify(wasteItemsCart));
        console.log('Cart saved to localStorage:', storageKey, wasteItemsCart);
    } catch (error) {
        console.error('Error saving cart to localStorage:', error);
    }
}

// Load available products - following trip_sales pattern
function loadAvailableProducts() {
    const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
    
    fetch('{% url "frontend:waste_available_products" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.getCsrfToken()
        },
        body: JSON.stringify({
            vessel_id: wasteData.wasteReport.vessel_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            availableProducts = data.products;
            updateAvailableProductsList();
        } else {
            console.error('Error loading products:', data.error);
        }
    })
    .catch(error => {
        console.error('Error loading products:', error);
    });
}

// FIXED: Update available products table with click handlers
function updateAvailableProductsList() {
    const tbody = document.getElementById('availableProductsList');
    
    if (availableProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No products available</td></tr>';
        return;
    }
    
    tbody.innerHTML = availableProducts.map(product => `
        <tr class="cursor-pointer" onclick="selectProductFromList(${JSON.stringify(product).replace(/"/g, '&quot;')})">
            <td>
                <strong>${product.name}</strong>
                ${product.is_duty_free ? '<br><span class="badge bg-warning text-dark ms-1">Duty-Free</span></br>' : ''}
            </td>
            <td class="text-center">
                <code data-number data-original="${product.item_id}">${translateNumber(product.item_id)}</code>
            </td>
            <td class="text-end">
                <span class="fw-bold text-danger" data-number data-original="${product.available_quantity}">${translateNumber(product.available_quantity.toString())}</span>
                <br><small class="text-muted"><span data-number data-original="${product.current_cost.toFixed(3)}">${translateNumber(product.current_cost.toFixed(3))}</span> <span data-currency-symbol>JOD</span> <span data-translate="per_unit">/unit</span></small>
            </td>
        </tr>
    `).join('');
}

// FIXED: Add selectProductFromList function like trip_sales
function selectProductFromList(product) {
    selectedProduct = product;
    
    // FIXED: Update search field like po_supply and trip_sales
    document.getElementById('productSearch').value = product.name;
    
    // Update product info with waste cost information
    document.getElementById('productName').textContent = product.name;
    document.getElementById('productDetails').textContent = `ID: ${product.item_id}`;
    document.getElementById('availableStock').textContent = `Available: ${product.available_quantity} units • Cost: ${product.current_cost.toFixed(3)} JOD/unit`;
    document.getElementById('productInfo').style.display = 'block';
    
    // Enable form inputs
    document.getElementById('wasteQuantity').max = product.available_quantity;
    document.getElementById('wasteQuantity').disabled = false;
    
    updateWasteCost();
    validateWasteForm();
    
    // Focus on quantity input
    document.getElementById('wasteQuantity').focus();
}

// Product search - following trip_sales pattern
function setupEventListeners() {
    // Product search functionality
    let searchTimeout;
    document.getElementById('productSearch').addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        
        clearTimeout(searchTimeout);
        
        if (searchTerm.length >= 2) {
            searchTimeout = setTimeout(() => searchProducts(searchTerm), 300);
        } else if (searchTerm.length === 0) {
            // FIXED: Reset to show all products when search is completely cleared
            loadAvailableProducts();
        }
    });
    
    // Add form validation event listeners
    document.getElementById('wasteQuantity').addEventListener('input', function() {
        updateWasteCost();
        validateWasteForm();
    });

    document.getElementById('damageReason').addEventListener('change', function() {
        validateWasteForm();
    });
    
    // Add to waste button
    document.getElementById('addWasteBtn').addEventListener('click', function() {
        if (!validateWasteForm()) {
            return;
        }
        
        const quantity = parseInt(document.getElementById('wasteQuantity').value);
        const damageReason = document.getElementById('damageReason').value;
        const notes = document.getElementById('wasteNotes').value.trim();
        
        const wasteItem = {
            product_id: selectedProduct.id,
            product_name: selectedProduct.name,
            product_item_id: selectedProduct.item_id,
            quantity: quantity,
            unit_cost: selectedProduct.current_cost,
            total_cost: quantity * selectedProduct.current_cost,
            damage_reason: damageReason,
            notes: notes
        };
        
        if (editingIndex >= 0) {
            wasteItemsCart[editingIndex] = wasteItem;
            exitEditMode();
        } else {
            const existingIndex = wasteItemsCart.findIndex(item => item.product_id === selectedProduct.id);
            if (existingIndex !== -1) {
                wasteItemsCart[existingIndex] = wasteItem;
            } else {
                wasteItemsCart.push(wasteItem);
            }
        }
        
        saveCartToStorage();
        updateCartDisplay();
        updateWasteTotals();
        clearForm();
    });
    
    // Complete waste report button
    document.getElementById('completeWasteBtn').addEventListener('click', async function() {
        if (wasteItemsCart.length === 0) {
            window.showAlert('Please add at least one item to complete the waste report', 'warning');
            return;
        }
        
        const totalCost = wasteItemsCart.reduce((sum, item) => sum + item.total_cost, 0);
        
        const confirmed = await confirmTranslated('confirm_waste_report', {
            count: wasteItemsCart.length,
            cost: totalCost.toFixed(3)
        });
        // FIXED: Use proper confirmation dialog
        const message = `Complete waste report with ${wasteItemsCart.length} items?\n\nTotal Waste Value: ${totalCost.toFixed(3)} JOD\n\nThis will permanently remove items from inventory.`;
        
        if (confirmed) {
            const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
            
            try {
                const response = await fetch('{% url "frontend:waste_bulk_complete" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.getCsrfToken()
                    },
                    body: JSON.stringify({
                        waste_id: wasteData.wasteReport.id,
                        items: wasteItemsCart
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear localStorage
                    const wasteId = document.getElementById('wasteId').value;
                    const storageKey = `waste_items_${wasteId}`;
                    localStorage.removeItem(storageKey);
                    
                    window.showAlert(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "frontend:waste_entry" %}';
                    }, 1500);
                } else {
                    window.showAlert(data.error, 'danger');
                }
            } catch (error) {
                console.error('Error completing waste report:', error);
                window.showAlert('Error completing waste report', 'danger');
            }
        }
    });
}

function searchProducts(searchTerm) {
    const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
    
    fetch('{% url "frontend:waste_search_products" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.getCsrfToken()
        },
        body: JSON.stringify({
            search: searchTerm,
            vessel_id: wasteData.wasteReport.vessel_id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            availableProducts = data.products;
            updateAvailableProductsList();
        } else {
            window.showAlert(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error searching products:', error);
        window.showAlert('Error searching products', 'danger');
    });
}

function updateWasteCost() {
    const quantity = parseInt(document.getElementById('wasteQuantity').value) || 0;
    
    if (selectedProduct && quantity > 0) {
        const totalCost = quantity * selectedProduct.current_cost;
        // Cost is calculated and used in validation
    }
}

function validateWasteForm() {
    const quantity = parseInt(document.getElementById('wasteQuantity')?.value) || 0;
    const damageReason = document.getElementById('damageReason')?.value || '';
    const addBtn = document.getElementById('addWasteBtn');
    const addBtnText = document.getElementById('addBtnText');
    
    // 🔧 SAFETY: Exit early if required elements don't exist
    if (!addBtn || !addBtnText) {
        console.warn('validateWasteForm: Required DOM elements not found');
        return false;
    }
    
    let isValid = true;
    let buttonText = window.translator?._('add_to_waste') || 'Add to Waste';
    
    // 🔧 FIX: Check selectedProduct first before any operations
    if (!selectedProduct) {
        isValid = false;
        buttonText = window.translator?._('select_product_first') || 'Select Product First';
    } else if (!quantity || quantity <= 0) {
        isValid = false;
        buttonText = window.translator?._('enter_valid_quantity') || 'Enter Valid Quantity';
    } else if (selectedProduct.available_quantity && quantity > selectedProduct.available_quantity) {
        isValid = false;
        buttonText = `Max: ${selectedProduct.available_quantity}`;
    } else if (!damageReason) {
        isValid = false;
        buttonText = window.translator?._('select_damage_reason') || 'Select Damage Reason';
    } else {
        // 🔧 FIX: Only check for duplicates when selectedProduct exists and editingIndex is valid
        if (editingIndex === -1 && Array.isArray(wasteItemsCart) && wasteItemsCart.length > 0) {
            try {
                const existingIndex = wasteItemsCart.findIndex(item => 
                    item && item.product_id === selectedProduct.id
                );
                if (existingIndex !== -1) {
                    isValid = false;
                    buttonText = window.translator?._('already_in_cart') || 'Already in Cart';
                }
            } catch (error) {
                console.error('Error checking for duplicates:', error);
            }
        }
        
        // If still valid, use appropriate button text
        if (isValid) {
            buttonText = editingIndex >= 0 ? 
                (window.translator?._('update_item') || 'Update Item') : 
                (window.translator?._('add_to_waste') || 'Add to Waste');
        }
    }
    
    // Update button state
    addBtn.disabled = !isValid;
    addBtnText.textContent = buttonText;
    
    // Update button styling
    addBtn.className = isValid ? 'btn btn-danger' : 'btn btn-secondary';
    
    return isValid;
}

// FIXED: Cart management like trip_sales
function updateCartDisplay() {
    const cartBody = document.getElementById('cartBody');
    const emptyCart = document.getElementById('emptyCart');
    const completeBtn = document.getElementById('completeWasteBtn');
    
    if (wasteItemsCart.length === 0) {
        if (emptyCart) emptyCart.style.display = 'block';
        if (completeBtn) completeBtn.disabled = true;
        return;
    }
    
    if (emptyCart) emptyCart.style.display = 'none';
    if (completeBtn) completeBtn.disabled = false;
    
    const cartHtml = `
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th><span data-translate="product">Product</span></th>
                        <th><span data-translate="quantity">Quantity</span></th>
                        <th><span data-translate="total_cost">Total Cost</span></th>
                        <th><span data-translate="reason">Reason</span></th>
                        <th><span data-translate="actions">Actions</span></th>
                    </tr>
                </thead>
                <tbody>
                    ${wasteItemsCart.map((item, index) => `
                        <tr class="cursor-pointer" onclick="editWasteItem(${index})">
                            <td>
                                <strong>${item.product_name}</strong>
                                <small class="text-muted d-block">${_('id_label')}: <span data-number data-original="${item.product_item_id}">${translateNumber(item.product_item_id)}</span></small>
                                ${item.notes ? `<small class="text-muted d-block">📝 ${item.notes}</small>` : ''}
                            </td>
                            <td>
                                <span class="fw-bold text-primary" data-number data-original="${item.quantity}">${translateNumber(item.quantity.toString())}</span>
                                <small class="text-muted d-block">${_('units')}</small>
                            </td>
                            <td><span class="fw-bold text-danger" data-number data-original="${item.total_cost.toFixed(3)}">${item.total_cost.toFixed(3)} JOD</span></td>
                            <td><span class="badge bg-warning">${item.damage_reason}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editWasteItem(${index})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); removeWasteItem(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    cartBody.innerHTML = cartHtml;
}

function updateWasteTotals() {
    let totalItems = 0;
    let totalCost = 0;
    
    const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
    
    // For completed reports, calculate from completed items
    if (!wasteData.wasteReport.can_edit && wasteData.completedWasteItems) {
        totalItems = wasteData.completedWasteItems.length;
        totalCost = wasteData.completedWasteItems.reduce((sum, item) => sum + item.total_amount, 0);
    } else {
        // For active reports, calculate from cart
        totalItems = wasteItemsCart.length;
        totalCost = wasteItemsCart.reduce((sum, item) => sum + item.total_cost, 0);
    }
    
    // Update header card using the translation-aware method
    if (window.updateNumberElement) {
        window.updateNumberElement('waste-cost-display', totalCost.toFixed(3));
        window.updateNumberElement('waste-items-count', totalItems);
    } else {
        // Fallback method
        const costElement = document.getElementById('waste-cost-display');
        const itemsElement = document.getElementById('waste-items-count');
        
        if (costElement) {
            costElement.setAttribute('data-original', totalCost.toFixed(3));
            costElement.textContent = window.translateNumber ? 
                window.translateNumber(totalCost.toFixed(3)) : totalCost.toFixed(3);
        }
        
        if (itemsElement) {
            itemsElement.setAttribute('data-original', totalItems.toString());
            itemsElement.textContent = window.translateNumber ? 
                window.translateNumber(totalItems.toString()) : totalItems;
        }
    }
    
    // Update badge
    const badgeElement = document.getElementById('cartItemsBadge') || document.getElementById('completedItemsBadge');
    if (badgeElement) {
        badgeElement.textContent = window.translateNumber ? 
            window.translateNumber(totalItems.toString()) : totalItems;
    }
    
    // Apply translations to updated elements
    setTimeout(() => {
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
    }, 0);
}

function editWasteItem(index) {
    // 🔧 FIX: Comprehensive input validation
    if (typeof index !== 'number' || index < 0) {
        console.error('editWasteItem: Invalid index provided:', index);
        window.showAlert?.('Invalid item selected for editing', 'error');
        return;
    }
    
    // 🔧 FIX: Check if wasteItemsCart exists and has items
    if (!Array.isArray(wasteItemsCart) || wasteItemsCart.length === 0) {
        console.error('editWasteItem: Cart is empty or not initialized');
        window.showAlert?.('No items in cart to edit', 'warning');
        return;
    }
    
    // 🔧 FIX: Check bounds
    if (index >= wasteItemsCart.length) {
        console.error('editWasteItem: Index out of bounds:', index, 'Cart length:', wasteItemsCart.length);
        window.showAlert?.('Item no longer exists in cart', 'error');
        return;
    }
    
    const item = wasteItemsCart[index];
    
    // 🔧 FIX: Verify item exists and has required properties
    if (!item || typeof item !== 'object') {
        console.error('editWasteItem: Invalid item at index:', index, item);
        window.showAlert?.('Invalid item data', 'error');
        return;
    }
    
    if (!item.product_id) {
        console.error('editWasteItem: Item missing product_id:', item);
        window.showAlert?.('Item data is corrupted', 'error');
        return;
    }
    
    // 🔧 FIX: Check if availableProducts exists and is populated
    if (!Array.isArray(availableProducts) || availableProducts.length === 0) {
        console.warn('editWasteItem: Available products not loaded, attempting to reload...');
        window.showAlert?.('Loading product data...', 'info');
        
        // Attempt to reload products
        loadAvailableProducts().then(() => {
            // Retry edit after products are loaded
            setTimeout(() => editWasteItem(index), 500);
        }).catch(error => {
            console.error('Failed to reload products:', error);
            window.showAlert?.('Unable to load product data', 'error');
        });
        return;
    }
    
    // 🔧 FIX: Find product with error handling
    let foundProduct;
    try {
        foundProduct = availableProducts.find(p => p && p.id === item.product_id);
    } catch (error) {
        console.error('Error finding product in availableProducts:', error);
        window.showAlert?.('Error accessing product data', 'error');
        return;
    }
    
    if (!foundProduct) {
        console.warn('editWasteItem: Product not found in available products:', item.product_id);
        window.showAlert?.('Product no longer available for editing', 'warning');
        return;
    }
    
    // 🔧 SUCCESS: All validations passed, proceed with edit
    try {
        editingIndex = index;
        selectedProduct = foundProduct;
        
        // 🔧 FIX: Safely populate form fields with null checks
        const productSearchEl = document.getElementById('productSearch');
        const quantityEl = document.getElementById('wasteQuantity');
        const damageReasonEl = document.getElementById('damageReason');
        const notesEl = document.getElementById('wasteNotes');
        const formTitleEl = document.getElementById('formTitle');
        const addBtnTextEl = document.getElementById('addBtnText');
        
        if (productSearchEl) productSearchEl.value = item.product_name || '';
        if (quantityEl) {
            quantityEl.value = item.quantity || 0;
            quantityEl.disabled = false;
        }
        if (damageReasonEl) damageReasonEl.value = item.damage_reason || '';
        if (notesEl) notesEl.value = item.notes || '';
        
        // Update UI to edit mode
        if (formTitleEl) {
            formTitleEl.innerHTML = '<i class="bi bi-pencil"></i> ' + 
                (window.translator?._('edit_waste_item') || 'Edit Waste Item');
        }
        if (addBtnTextEl) {
            addBtnTextEl.textContent = window.translator?._('update_item') || 'Update Item';
        }
        
        // Show product info if function exists
        if (typeof selectProductFromList === 'function') {
            selectProductFromList(selectedProduct);
        }
        
        // Re-validate form
        if (typeof validateWasteForm === 'function') {
            validateWasteForm();
        }
        
        // Scroll to form
        const formEl = document.getElementById('addWasteForm');
        if (formEl && typeof formEl.scrollIntoView === 'function') {
            formEl.scrollIntoView({ behavior: 'smooth' });
        }
        
        console.log('✅ editWasteItem: Successfully entered edit mode for item:', item.product_name);
        
    } catch (error) {
        console.error('editWasteItem: Error during edit setup:', error);
        window.showAlert?.('Error setting up edit mode', 'error');
        
        // Reset state on error
        editingIndex = -1;
        selectedProduct = null;
    }
}   

async function removeWasteItem(index) {
    const confirmed = confirm('Remove this item from the waste cart?');
    if (confirmed) {
        wasteItemsCart.splice(index, 1);
        saveCartToStorage();
        updateCartDisplay();
        updateWasteTotals();
        showAlert('Item removed from waste cart', 'info');
    }
}

function exitEditMode() {
    editingIndex = -1;
    document.getElementById('formTitle').innerHTML = '<i class="bi bi-plus-circle"></i> ' + _('add_waste_item');
    document.getElementById('addBtnText').textContent = _('add_to_waste');
}

// Cancel logic - following trip_sales pattern
async function cancelEdit() {
    if (editingIndex >= 0) {
        exitEditMode();
        clearForm();
        return;
    }
    
    const wasteData = JSON.parse(document.getElementById('wasteData').textContent);
    await window.standardizeCancelOperation(
        'waste', 
        wasteData.wasteReport.id, 
        '/waste/cancel/', 
        '/waste/entry/'
    );
}

function clearForm() {
    try {
        // Reset form
        const formEl = document.getElementById('addWasteForm');
        if (formEl && typeof formEl.reset === 'function') {
            formEl.reset();
        }
        
        // Hide product info
        const productInfoEl = document.getElementById('productInfo');
        if (productInfoEl) {
            productInfoEl.style.display = 'none';
        }
        
        // Disable quantity input
        const quantityEl = document.getElementById('wasteQuantity');
        if (quantityEl) {
            quantityEl.disabled = true;
        }
        
        // Disable add button
        const addBtnEl = document.getElementById('addWasteBtn');
        if (addBtnEl) {
            addBtnEl.disabled = true;
        }
        
        // Clear product selection BEFORE validation
        selectedProduct = null;
        
        // Reset edit mode
        editingIndex = -1;
        
        // Reset form title
        const formTitleEl = document.getElementById('formTitle');
        if (formTitleEl) {
            formTitleEl.innerHTML = '<i class="bi bi-plus-circle"></i> ' + 
                (window.translator?._('add_waste_item') || 'Add Waste Item');
        }
        
        // Reset button text
        const addBtnTextEl = document.getElementById('addBtnText');
        if (addBtnTextEl) {
            addBtnTextEl.textContent = window.translator?._('add_to_waste') || 'Add to Waste';
        }
        
        // Re-validate form safely
        if (typeof validateWasteForm === 'function') {
            validateWasteForm();
        }
        
    } catch (error) {
        console.error('clearForm: Error during form reset:', error);
    }
}

// FIXED: Enhanced completed items display with full translation support
function displayCompletedWasteItems(items) {
    const container = document.getElementById('completedWasteItems');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4"></i>
                <p class="mt-2" data-translate="no_completed_items">No completed items found</p>
            </div>
        `;
        
        // Apply translations to the new content
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
        return;
    }
    
    const itemsHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th><span data-translate="time">Time</span></th>
                        <th><span data-translate="product">Product</span></th>
                        <th><span data-translate="quantity">Quantity</span></th>
                        <th><span data-translate="cost">Cost</span></th>
                        <th><span data-translate="damage_reason">Reason</span></th>
                        <th><span data-translate="notes">Notes</span></th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => `
                        <tr>
                            <td><small class="text-muted">${item.created_at}</small></td>
                            <td>
                                <strong>${item.product_name}</strong>
                                <small class="d-block text-muted">
                                    <span data-translate="id_label">ID</span>: 
                                    <span data-number data-original="${item.product_item_id}">${item.product_item_id}</span>
                                </small>
                            </td>
                            <td>
                                <span class="badge bg-primary">
                                    <span data-number data-original="${item.quantity}">${item.quantity}</span>
                                </span>
                            </td>
                            <td>
                                <span class="fw-bold text-danger">
                                    <span data-number data-original="${item.total_amount.toFixed(3)}">${item.total_amount.toFixed(3)}</span> 
                                    <span data-currency-symbol>JOD</span>
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-warning" data-translate="${item.damage_reason.toLowerCase()}">${item.damage_reason}</span>
                            </td>
                            <td>
                                <small class="text-muted">${item.notes || '-'}</small>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = itemsHtml;
    
    // IMPORTANT: Apply translations after inserting dynamic content
    setTimeout(() => {
        if (window.updatePageTranslations) {
            window.updatePageTranslations();
        }
    }, 0);
}

// Translation helpers - using existing system
function _(key) {
    return window.translator ? window.translator._(key) : key;
}

window.addEventListener('languageChanged', () => {
    updateCartDisplay();
});
</script>
{% endblock %}