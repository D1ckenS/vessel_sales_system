{% extends 'frontend/base.html' %}

{% block title %}Transfer Center - Vessel Sales System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-arrow-left-right text-warning"></i> 
                    Transfer Center
                </h2>
                <p class="text-muted mb-0">Move inventory between vessels while preserving FIFO costs</p>
            </div>
            <a href="{% url 'frontend:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Transfer Form -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-box-arrow-right"></i> New Transfer Transaction
                </h5>
            </div>
            <div class="card-body">
                <form id="transferForm">
                    {% csrf_token %}
                    
                    <!-- Vessel Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-danger"></i> From Vessel (Source)
                            </label>
                            <select class="form-select form-select-lg" id="fromVessel" required>
                                <option value="">Choose source vessel...</option>
                                {% for vessel in vessels %}
                                <option value="{{ vessel.id }}" data-name="{{ vessel.name }}" data-duty-free="{{ vessel.has_duty_free }}">
                                    <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                    {% if vessel.has_duty_free %}<span class="text-success">(Duty-Free)</span>{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-success"></i> To Vessel (Destination)
                            </label>
                            <select class="form-select form-select-lg" id="toVessel" required disabled>
                                <option value="">First select source vessel...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Transfer Date -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Transfer Date
                            </label>
                            <input type="date" class="form-control form-control-lg" id="transferDate" value="{{ today|date:'Y-m-d' }}" required>
                        </div>
                    </div>

                    <!-- Product Search -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search"></i> Search Product
                        </label>
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" placeholder="Type product name, ID, or scan barcode..." id="productSearch" disabled>
                            <button class="btn btn-outline-secondary" type="button" onclick="showComingSoon()" disabled>
                                <i class="bi bi-upc-scan"></i> Scan
                            </button>
                        </div>
                        <small class="text-muted">Select source vessel first, then search for products...</small>
                    </div>

                    <!-- Product Selection Results -->
                    <div id="productResults" class="mb-4" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-box-seam"></i> Selected Product
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="selectedProductInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Inventory Display -->
                    <div id="inventoryInfo" class="mb-4" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-layers"></i> Available FIFO Inventory
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="fifoLots"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="row mb-4" id="quantitySection" style="display: none;">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-123"></i> Quantity to Transfer
                            </label>
                            <input type="number" class="form-control form-control-lg" id="transferQuantity" placeholder="0" min="1" step="1">
                            <small class="text-muted">Maximum: <span id="maxQuantity">0</span> units</small>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">
                                <i class="bi bi-info-circle"></i> Transfer Notes (Optional)
                            </label>
                            <input type="text" class="form-control form-control-lg" id="transferNotes" placeholder="e.g., Emergency restock, planned redistribution...">
                        </div>
                    </div>

                    <!-- FIFO Preview -->
                    <div id="fifoPreview" class="mb-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-eye"></i> FIFO Transfer Preview
                            </h6>
                            <div id="previewContent"></div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>From <span id="previewFromVessel">--</span>:</strong></small>
                                    <div id="previewConsumption" class="text-danger small"></div>
                                </div>
                                <div class="col-md-6">
                                    <small><strong>To <span id="previewToVessel">--</span>:</strong></small>
                                    <div id="previewCreation" class="text-success small"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Duty-Free Validation -->
                    <div id="dutyFreeWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Warning:</strong> This is a duty-free product. Make sure the destination vessel supports duty-free items.
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary btn-lg me-md-2" onclick="clearForm()">
                            <i class="bi bi-x-circle"></i> Clear Form
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg" id="transferButton" disabled>
                            <i class="bi bi-arrow-right-circle"></i> Execute Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transfers -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Recent Transfers
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-calendar"></i> Date</th>
                                <th><i class="bi bi-ship"></i> From â†’ To</th>
                                <th><i class="bi bi-box"></i> Product</th>
                                <th><i class="bi bi-123"></i> Quantity</th>
                                <th><i class="bi bi-person"></i> By</th>
                                <th><i class="bi bi-gear"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransfersBody">
                            {% for transfer in recent_transfers %}
                            <tr>
                                <td>{{ transfer.transaction_date|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge bg-danger me-1">
                                        <span class="vessel-name" data-en="{{ transfer.vessel.name }}" data-ar="{{ transfer.vessel.name_ar }}">{{ transfer.vessel.name }}</span>
                                    </span>
                                    <i class="bi bi-arrow-right"></i>
                                    <span class="badge bg-success ms-1">
                                        <span class="vessel-name" data-en="{{ transfer.transfer_to_vessel.name }}" data-ar="{{ transfer.transfer_to_vessel.name_ar }}">{{ transfer.transfer_to_vessel.name }}</span>
                                    </span>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ transfer.product.name }}</strong>
                                        <small class="text-muted d-block">ID: {{ transfer.product.item_id }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold">{{ transfer.quantity|floatformat:0 }}</span>
                                    <small class="text-muted">units</small>
                                </td>
                                <td>
                                    <small>{{ transfer.created_by.username|default:"System" }}</small>
                                    <small class="text-muted d-block">{{ transfer.created_at|timesince }} ago</small>
                                </td>
                                <td>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewTransferDetails('{{ transfer.id }}')" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-arrow-left-right" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0">No transfers recorded yet</p>
                                    <small>Use the form above to create your first transfer</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Details Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-left-right"></i> Transfer Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transferModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedProduct = null;
let availableLots = [];

// Populate destination vessel when source is selected
document.getElementById('fromVessel').addEventListener('change', function() {
    const fromVesselId = this.value;
    const toVesselSelect = document.getElementById('toVessel');
    const productSearch = document.getElementById('productSearch');
    
    // Clear everything
    clearProductSelection();
    
    if (fromVesselId) {
        // Enable destination vessel and product search
        toVesselSelect.disabled = false;
        productSearch.disabled = false;
        
        // Populate destination options (exclude source vessel)
        toVesselSelect.innerHTML = '<option value="">Choose destination vessel...</option>';
        
        // Get all vessel options from the source select
        const sourceOptions = document.getElementById('fromVessel').options;
        for (let i = 1; i < sourceOptions.length; i++) { // Skip first "Choose..." option
            const option = sourceOptions[i];
            if (option.value !== fromVesselId) {
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.dataset.name = option.dataset.name;
                newOption.dataset.dutyFree = option.dataset.dutyFree;
                newOption.textContent = option.textContent;
                toVesselSelect.appendChild(newOption);
            }
        }
    } else {
        // Disable everything
        toVesselSelect.disabled = true;
        productSearch.disabled = true;
        toVesselSelect.innerHTML = '<option value="">First select source vessel...</option>';
        productSearch.placeholder = "Select source vessel first, then search for products...";
    }
});

// Product search with debouncing
let searchTimeout;
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.trim();
    const fromVesselId = document.getElementById('fromVessel').value;
    
    clearTimeout(searchTimeout);
    
    if (searchTerm.length >= 2 && fromVesselId) {
        searchTimeout = setTimeout(() => {
            searchProducts(searchTerm, fromVesselId);
        }, 500);
    } else {
        clearProductSelection();
    }
});

// Transfer quantity validation
document.getElementById('transferQuantity').addEventListener('input', function() {
    const quantity = parseInt(this.value) || 0;
    updateFifoPreview(quantity);
    validateTransfer();
});

// Destination vessel validation
document.getElementById('toVessel').addEventListener('change', function() {
    validateTransfer();
});

function searchProducts(searchTerm, vesselId) {
    fetch('/transfer/search-products/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            search: searchTerm,
            vessel_id: vesselId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.products.length > 0) {
            displayProductResults(data.products);
        } else {
            clearProductSelection();
            showAlert('No products found with available inventory on this vessel.', 'warning');
        }
    })
    .catch(error => {
        console.error('Error searching products:', error);
        showAlert('Error searching products. Please try again.', 'danger');
    });
}

function displayProductResults(products) {
    const resultsDiv = document.getElementById('productResults');
    const productInfo = document.getElementById('selectedProductInfo');
    
    if (products.length === 1) {
        // Auto-select if only one result
        selectProduct(products[0]);
    } else {
        // Show selection list
        productInfo.innerHTML = `
            <h6>Multiple products found:</h6>
            <div class="list-group">
                ${products.map(product => `
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <small class="text-muted">ID: ${product.item_id} â€¢ Available: ${product.total_quantity} units</small>
                            </div>
                            <span class="badge bg-primary">${product.total_quantity}</span>
                        </div>
                    </button>
                `).join('')}
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
}

function selectProduct(product) {
    selectedProduct = product;
    availableLots = product.lots;
    
    // Display selected product
    const productInfo = document.getElementById('selectedProductInfo');
    productInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">${product.name}</h6>
                <small class="text-muted">ID: ${product.item_id} â€¢ Available: ${product.total_quantity} units</small>
            </div>
            <div class="text-end">
                <div class="badge bg-success">Selected</div>
                <small class="d-block text-muted">${product.total_quantity} units available</small>
            </div>
        </div>
    `;
    
    document.getElementById('productResults').style.display = 'block';
    
    // Display FIFO lots
    displayFifoLots(product.lots);
    
    // Show quantity section
    document.getElementById('quantitySection').style.display = 'block';
    document.getElementById('maxQuantity').textContent = product.total_quantity;
    
    // Set max quantity
    document.getElementById('transferQuantity').max = product.total_quantity;
    
    // Check duty-free compatibility
    checkDutyFreeCompatibility(product);
    
    validateTransfer();
}

function displayFifoLots(lots) {
    const fifoDiv = document.getElementById('fifoLots');
    
    fifoDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Purchase Date</th>
                        <th>Available Quantity</th>
                        <th>Unit Cost</th>
                        <th>Total Value</th>
                        <th>FIFO Order</th>
                    </tr>
                </thead>
                <tbody>
                    ${lots.map((lot, index) => `
                        <tr class="${index === 0 ? 'table-warning' : ''}">
                            <td>${lot.purchase_date}</td>
                            <td>${lot.remaining_quantity}</td>
                            <td>${lot.purchase_price.toFixed(3)} JOD</td>
                            <td>${(lot.remaining_quantity * lot.purchase_price).toFixed(3)} JOD</td>
                            <td>
                                ${index === 0 ? '<span class="badge bg-warning">First (Oldest)</span>' : 
                                  index === 1 ? '<span class="badge bg-info">Second</span>' : 
                                  `<span class="badge bg-secondary">#${index + 1}</span>`}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> Transfer will consume lots in FIFO order (oldest first)
        </small>
    `;
    
    document.getElementById('inventoryInfo').style.display = 'block';
}

function updateFifoPreview(quantity) {
    if (!selectedProduct || quantity <= 0) {
        document.getElementById('fifoPreview').style.display = 'none';
        return;
    }
    
    // Calculate FIFO consumption
    let remainingToConsume = quantity;
    let consumptionPlan = [];
    
    for (let lot of availableLots) {
        if (remainingToConsume <= 0) break;
        
        const consumeFromThisLot = Math.min(lot.remaining_quantity, remainingToConsume);
        consumptionPlan.push({
            ...lot,
            consume_quantity: consumeFromThisLot
        });
        remainingToConsume -= consumeFromThisLot;
    }
    
    if (remainingToConsume > 0) {
        showAlert('Insufficient inventory for this quantity!', 'danger');
        return;
    }
    
    // Display preview
    const fromVesselName = document.getElementById('fromVessel').selectedOptions[0]?.dataset.name || '--';
    const toVesselName = document.getElementById('toVessel').selectedOptions[0]?.dataset.name || '--';
    
    document.getElementById('previewFromVessel').textContent = fromVesselName;
    document.getElementById('previewToVessel').textContent = toVesselName;
    
    document.getElementById('previewConsumption').innerHTML = consumptionPlan.map(lot => 
        `Will consume ${lot.consume_quantity} units @ ${lot.purchase_price.toFixed(3)} JOD (from ${lot.purchase_date})`
    ).join('<br>');
    
    document.getElementById('previewCreation').innerHTML = consumptionPlan.map(lot => 
        `Will create ${lot.consume_quantity} units @ ${lot.purchase_price.toFixed(3)} JOD (preserves ${lot.purchase_date} cost)`
    ).join('<br>');
    
    document.getElementById('fifoPreview').style.display = 'block';
}

function checkDutyFreeCompatibility(product) {
    const toVessel = document.getElementById('toVessel');
    const warning = document.getElementById('dutyFreeWarning');
    
    if (product.is_duty_free && toVessel.value) {
        const destinationSupportsDutyFree = toVessel.selectedOptions[0]?.dataset.dutyFree === 'true';
        if (!destinationSupportsDutyFree) {
            warning.style.display = 'block';
            warning.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error:</strong> This duty-free product cannot be transferred to ${toVessel.selectedOptions[0]?.dataset.name} 
                (vessel does not support duty-free items).
            `;
            warning.className = 'alert alert-danger';
        } else {
            warning.style.display = 'block';
        }
    } else {
        warning.style.display = 'none';
    }
}

function validateTransfer() {
    const fromVessel = document.getElementById('fromVessel').value;
    const toVessel = document.getElementById('toVessel').value;
    const quantity = parseInt(document.getElementById('transferQuantity').value) || 0;
    const transferButton = document.getElementById('transferButton');
    
    let isValid = true;
    
    // Basic validation
    if (!fromVessel || !toVessel || !selectedProduct || quantity <= 0) {
        isValid = false;
    }
    
    // Quantity validation
    if (quantity > selectedProduct?.total_quantity) {
        isValid = false;
    }
    
    // Duty-free validation
    if (selectedProduct?.is_duty_free) {
        const destinationSupportsDutyFree = document.getElementById('toVessel').selectedOptions[0]?.dataset.dutyFree === 'true';
        if (!destinationSupportsDutyFree) {
            isValid = false;
        }
    }
    
    transferButton.disabled = !isValid;
}

function clearProductSelection() {
    selectedProduct = null;
    availableLots = [];
    document.getElementById('productResults').style.display = 'none';
    document.getElementById('inventoryInfo').style.display = 'none';
    document.getElementById('quantitySection').style.display = 'none';
    document.getElementById('fifoPreview').style.display = 'none';
    document.getElementById('dutyFreeWarning').style.display = 'none';
    document.getElementById('transferButton').disabled = true;
}

function clearForm() {
    document.getElementById('transferForm').reset();
    document.getElementById('toVessel').disabled = true;
    document.getElementById('productSearch').disabled = true;
    clearProductSelection();
}

// Form submission
document.getElementById('transferForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateTransferForm()) return;
    
    const formData = {
        from_vessel_id: document.getElementById('fromVessel').value,
        to_vessel_id: document.getElementById('toVessel').value,
        product_id: selectedProduct.id,
        quantity: parseInt(document.getElementById('transferQuantity').value),
        transfer_date: document.getElementById('transferDate').value,
        notes: document.getElementById('transferNotes').value.trim()
    };
    
    // Show confirmation dialog
    if (confirm(`Confirm Transfer:\n\nFrom: ${document.getElementById('fromVessel').selectedOptions[0].dataset.name}\nTo: ${document.getElementById('toVessel').selectedOptions[0].dataset.name}\nProduct: ${selectedProduct.name}\nQuantity: ${formData.quantity} units\n\nThis will preserve FIFO costs. Continue?`)) {
        executeTransfer(formData);
    }
});

function validateTransferForm() {
    return document.getElementById('fromVessel').value && 
           document.getElementById('toVessel').value && 
           selectedProduct && 
           parseInt(document.getElementById('transferQuantity').value) > 0;
}

function executeTransfer(formData) {
    const submitButton = document.getElementById('transferButton');
    const originalText = submitButton.innerHTML;
    
    submitButton.innerHTML = '<span class="loading"></span> Processing Transfer...';
    submitButton.disabled = true;
    
    fetch('/transfer/execute/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Transfer completed successfully! ${data.message}`, 'success');
            clearForm();
            // Redirect to inventory to see updated stock
            setTimeout(() => {
                window.location.href = "{% url 'frontend:inventory_check' %}";
            }, 2000);
        } else {
            showAlert(`Transfer failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Transfer error:', error);
        showAlert('Transfer failed due to system error. Please try again.', 'danger');
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function viewTransferDetails(transferId) {
    // Implementation for viewing transfer details
    showComingSoon();
}

function showComingSoon() {
    alert('ðŸš€ This feature is coming soon! Stay tuned for updates.');
}
</script>
{% endblock %}