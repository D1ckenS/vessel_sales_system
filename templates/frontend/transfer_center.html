{% extends 'frontend/base.html' %}

{% block title %}<span data-translate="transfer_center">Transfer Center</span> - <span data-translate="vessel_sales_system">Vessel Sales System</span>{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-arrow-left-right text-warning"></i> 
                    <span data-translate="transfer_center">Transfer Center</span>
                </h2>
                <p class="text-muted mb-0"><span data-translate="transfer_center_desc">Move inventory between vessels while preserving FIFO costs</span></p>
            </div>
            <a href="{% url 'frontend:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> <span data-translate="back_to_dashboard">Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

<!-- Transfer Form -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-box-arrow-right"></i> <span data-translate="new_transfer_transaction">New Transfer Transaction</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="transferForm">
                    {% csrf_token %}
                    
                    <!-- Vessel Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-danger"></i> <span data-translate="from_vessel_source">From Vessel (Source)</span>
                            </label>
                            <select class="form-select form-select-lg" id="fromVessel" required>
                                <option value="" data-translate="choose_source_vessel">Choose source vessel...</option>
                                {% for vessel in vessels %}
                                <option value="{{ vessel.id }}" data-name="{{ vessel.name }}" data-name-ar="{{ vessel.name_ar }}" data-duty-free="{{ vessel.has_duty_free }}">
                                    <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                    {% if vessel.has_duty_free %}<span data-translate="duty_free_vessel">(<span data-translate="duty_free">Duty-Free</span>)</span>{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship text-success"></i> <span data-translate="to_vessel_destination">To Vessel (Destination)</span>
                            </label>
                            <select class="form-select form-select-lg" id="toVessel" required disabled>
                                <option value="" data-translate="first_select_source_vessel">First select source vessel...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Transfer Date -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> <span data-translate="transfer_date">Transfer Date</span>
                            </label>
                            <input type="date" class="form-control form-control-lg" id="transferDate" value="{{ today|date:'Y-m-d' }}" required>
                        </div>
                    </div>

                    <!-- Product Search -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search"></i> <span data-translate="search_product">Search Product</span>
                        </label>
                        <div class="input-group input-group-lg">
                            <input type="text" class="form-control" id="productSearch" disabled
                                   data-placeholder-en="Type product name, ID, or scan barcode..."
                                   data-placeholder-ar="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..."
                                   placeholder="Type product name, ID, or scan barcode...">
                            <button class="btn btn-outline-secondary" type="button" onclick="showComingSoon()" disabled>
                                <i class="bi bi-upc-scan"></i> <span data-translate="scan">Scan</span>
                            </button>
                        </div>
                        <small class="text-muted" data-translate="select_source_vessel_first">Select source vessel first, then search for products...</small>
                    </div>

                    <!-- Product Selection Results -->
                    <div id="productResults" class="mb-4" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-box-seam"></i> <span data-translate="selected_product">Selected Product</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="selectedProductInfo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Inventory Display -->
                    <div id="inventoryInfo" class="mb-4" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-layers"></i> <span data-translate="available_fifo_inventory">Available FIFO Inventory</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="fifoLots"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="row mb-4" id="quantitySection" style="display: none;">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-123"></i> <span data-translate="quantity_to_transfer">Quantity to Transfer</span>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="transferQuantity" placeholder="0" min="1" step="1">
                            <small class="text-muted"><span data-translate="maximum">Maximum</span>: <span id="maxQuantity">0</span> <span data-translate="units">units</span></small>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">
                                <i class="bi bi-info-circle"></i> <span data-translate="transfer_notes_optional">Transfer Notes (Optional)</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="transferNotes" 
                                   data-placeholder-en="e.g., Emergency restock, planned redistribution..."
                                   data-placeholder-ar="Ù…Ø«Ù„Ø§Ù‹ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ®Ø²ÙŠÙ† Ø·Ø§Ø±Ø¦Ø©ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ù…Ø®Ø·Ø·Ø©..."
                                   placeholder="e.g., Emergency restock, planned redistribution...">
                        </div>
                    </div>

                    <!-- FIFO Preview -->
                    <div id="fifoPreview" class="mb-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="bi bi-eye"></i> <span data-translate="fifo_transfer_preview">FIFO Transfer Preview</span>
                            </h6>
                            <div id="previewContent"></div>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong><span data-translate="from">From</span> <span id="previewFromVessel">--</span>:</strong></small>
                                    <div id="previewConsumption" class="text-danger small"></div>
                                </div>
                                <div class="col-md-6">
                                    <small><strong><span data-translate="to">To</span> <span id="previewToVessel">--</span>:</strong></small>
                                    <div id="previewCreation" class="text-success small"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Duty-Free Validation -->
                    <div id="dutyFreeWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong><span data-translate="warning">Warning</span>:</strong> <span data-translate="duty_free_warning_text">This is a duty-free product. Make sure the destination vessel supports duty-free items.</span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary btn-lg me-md-2" onclick="clearForm()">
                            <i class="bi bi-x-circle"></i> <span data-translate="clear_form">Clear Form</span>
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg" id="transferButton" disabled>
                            <i class="bi bi-arrow-right-circle"></i> <span data-translate="execute_transfer">Execute Transfer</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transfers -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> <span data-translate="recent_transfers">Recent Transfers</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><i class="bi bi-calendar"></i> <span data-translate="date">Date</span></th>
                                <th><i class="bi bi-ship"></i> <span data-translate="from_to">From â†’ To</span></th>
                                <th><i class="bi bi-box"></i> <span data-translate="product">Product</span></th>
                                <th><i class="bi bi-123"></i> <span data-translate="quantity">Quantity</span></th>
                                <th><i class="bi bi-person"></i> <span data-translate="by">By</span></th>
                                <th><i class="bi bi-gear"></i> <span data-translate="actions">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody id="recentTransfersBody">
                            {% for transfer in recent_transfers %}
                            <tr>
                                <td>{{ transfer.transaction_date|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge bg-danger me-1">
                                        <span class="vessel-name" data-en="{{ transfer.vessel.name }}" data-ar="{{ transfer.vessel.name_ar }}">{{ transfer.vessel.name }}</span>
                                    </span>
                                    <i class="bi bi-arrow-right"></i>
                                    <span class="badge bg-success ms-1">
                                        <span class="vessel-name" data-en="{{ transfer.transfer_to_vessel.name }}" data-ar="{{ transfer.transfer_to_vessel.name_ar }}">{{ transfer.transfer_to_vessel.name }}</span>
                                    </span>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ transfer.product.name }}</strong>
                                        <small class="text-muted d-block"><span data-translate="id_label">ID</span>: {{ transfer.product.item_id }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold" data-number data-original="{{ transfer.quantity|floatformat:0 }}">{{ transfer.quantity|floatformat:0 }}</span>
                                    <small class="text-muted" data-translate="units">units</small>
                                </td>
                                <td>
                                    <small>{{ transfer.created_by.username|default:"System" }}</small>
                                    <small class="text-muted d-block transaction-time" data-time="{{ transfer.created_at|timesince }}">{{ transfer.created_at|timesince }} ago</small>
                                </td>
                                <td>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewTransferDetails('{{ transfer.id }}')" data-translate="view_details" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-arrow-left-right" style="font-size: 2rem;"></i>
                                    <p class="mt-2 mb-0" data-translate="no_transfers_recorded">No transfers recorded yet</p>
                                    <small data-translate="use_form_above_transfer">Use the form above to create your first transfer</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Details Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-left-right"></i> <span data-translate="transfer_details">Transfer Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transferModalContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="close">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedProduct = null;
let availableLots = [];

// Add page-specific translations
document.addEventListener('DOMContentLoaded', function() {
    const pageTranslations = {
        en: {
            'transfer_center': 'Transfer Center',
            'vessel_sales_system': 'Vessel Sales System',
            'transfer_center_desc': 'Move inventory between vessels while preserving FIFO costs',
            'back_to_dashboard': 'Back to Dashboard',
            'new_transfer_transaction': 'New Transfer Transaction',
            'from_vessel_source': 'From Vessel (Source)',
            'choose_source_vessel': 'Choose source vessel...',
            'duty_free_vessel': '(Duty-Free)',
            'duty_free': 'Duty-Free',
            'to_vessel_destination': 'To Vessel (Destination)',
            'first_select_source_vessel': 'First select source vessel...',
            'transfer_date': 'Transfer Date',
            'search_product': 'Search Product',
            'scan': 'Scan',
            'select_source_vessel_first': 'Select source vessel first, then search for products...',
            'selected_product': 'Selected Product',
            'available_fifo_inventory': 'Available FIFO Inventory',
            'quantity_to_transfer': 'Quantity to Transfer',
            'maximum': 'Maximum',
            'units': 'units',
            'transfer_notes_optional': 'Transfer Notes (Optional)',
            'fifo_transfer_preview': 'FIFO Transfer Preview',
            'from': 'From',
            'to': 'To',
            'warning': 'Warning',
            'duty_free_warning_text': 'This is a duty-free product. Make sure the destination vessel supports duty-free items.',
            'clear_form': 'Clear Form',
            'execute_transfer': 'Execute Transfer',
            'recent_transfers': 'Recent Transfers',
            'date': 'Date',
            'from_to': 'From â†’ To',
            'product': 'Product',
            'quantity': 'Quantity',
            'by': 'By',
            'actions': 'Actions',
            'id_label': 'ID',
            'view_details': 'View Details',
            'no_transfers_recorded': 'No transfers recorded yet',
            'use_form_above_transfer': 'Use the form above to create your first transfer',
            'transfer_details': 'Transfer Details',
            'close': 'Close',
            // JavaScript translations
            'choose_destination_vessel': 'Choose destination vessel...',
            'multiple_products_found': 'Multiple products found:',
            'available': 'Available',
            'selected': 'Selected',
            'units_available': 'units available',
            'purchase_date': 'Purchase Date',
            'available_quantity': 'Available Quantity',
            'unit_cost': 'Unit Cost',
            'total_value': 'Total Value',
            'fifo_order': 'FIFO Order',
            'first_oldest': 'First (Oldest)',
            'second': 'Second',
            'transfer_fifo_info': 'Transfer will consume lots in FIFO order (oldest first)',
            'insufficient_inventory': 'Insufficient inventory for this quantity!',
            'will_consume': 'Will consume',
            'units_at': 'units @',
            'from_date': 'from',
            'will_create': 'Will create',
            'preserves_cost': 'preserves',
            'cost': 'cost',
            'error_duty_free_vessel': 'Error: This duty-free product cannot be transferred to',
            'vessel_no_duty_free': '(vessel does not support duty-free items).',
            'confirm_transfer': 'Confirm Transfer:',
            'from_label': 'From:',
            'to_label': 'To:',
            'product_label': 'Product:',
            'quantity_label': 'Quantity:',
            'preserve_fifo_costs': 'This will preserve FIFO costs. Continue?',
            'processing_transfer': 'Processing Transfer...',
            'transfer_completed': 'Transfer completed successfully!',
            'transfer_failed': 'Transfer failed:',
            'transfer_system_error': 'Transfer failed due to system error. Please try again.',
            'no_products_found': 'No products found with available inventory on this vessel.',
            'error_searching_products': 'Error searching products. Please try again.',
            'feature_coming_soon': 'ðŸš€ This feature is coming soon! Stay tuned for updates.'
        },
        ar: {
            'transfer_center': 'Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª',
            'vessel_sales_system': 'Ù†Ø¸Ø§Ù… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø³ÙÙ†',
            'transfer_center_desc': 'Ù†Ù‚Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨ÙŠÙ† Ø§Ù„Ø³ÙÙ† Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹',
            'back_to_dashboard': 'Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
            'new_transfer_transaction': 'Ø­Ø±ÙƒØ© ØªØ­ÙˆÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©',
            'from_vessel_source': 'Ù…Ù† Ø§Ù„Ø³ÙÙŠÙ†Ø© (Ø§Ù„Ù…ØµØ¯Ø±)',
            'choose_source_vessel': 'Ø§Ø®ØªØ± Ø§Ù„Ø³ÙÙŠÙ†Ø© Ø§Ù„Ù…ØµØ¯Ø±...',
            'duty_free_vessel': '(Ø³ÙˆÙ‚ Ø­Ø±Ø©)',
            'duty_free': 'Ø³ÙˆÙ‚ Ø­Ø±Ø©',
            'to_vessel_destination': 'Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙÙŠÙ†Ø© (Ø§Ù„ÙˆØ¬Ù‡Ø©)',
            'first_select_source_vessel': 'Ø§Ø®ØªØ± Ø§Ù„Ø³ÙÙŠÙ†Ø© Ø§Ù„Ù…ØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹...',
            'transfer_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'search_product': 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬',
            'scan': 'Ù…Ø³Ø­',
            'select_source_vessel_first': 'Ø§Ø®ØªØ± Ø§Ù„Ø³ÙÙŠÙ†Ø© Ø§Ù„Ù…ØµØ¯Ø± Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...',
            'selected_product': 'Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø±',
            'available_fifo_inventory': 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)',
            'quantity_to_transfer': 'Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„ØªØ­ÙˆÙŠÙ„',
            'maximum': 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰',
            'units': 'ÙˆØ­Ø¯Ø§Øª',
            'transfer_notes_optional': 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
            'fifo_transfer_preview': 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)',
            'from': 'Ù…Ù†',
            'to': 'Ø¥Ù„Ù‰',
            'warning': 'ØªØ­Ø°ÙŠØ±',
            'duty_free_warning_text': 'Ù‡Ø°Ø§ Ù…Ù†ØªØ¬ Ø³ÙˆÙ‚ Ø­Ø±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙÙŠÙ†Ø© Ø§Ù„Ù…Ù‚ØµÙˆØ¯Ø© ØªØ¯Ø¹Ù… Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø±Ø©.',
            'clear_form': 'Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',
            'execute_transfer': 'ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'recent_transfers': 'Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©',
            'date': 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
            'from_to': 'Ù…Ù† â† Ø¥Ù„Ù‰',
            'product': 'Ø§Ù„Ù…Ù†ØªØ¬',
            'quantity': 'Ø§Ù„ÙƒÙ…ÙŠØ©',
            'by': 'Ø¨ÙˆØ§Ø³Ø·Ø©',
            'actions': 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',
            'id_label': 'Ø±Ù‚Ù…',
            'view_details': 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„',
            'no_transfers_recorded': 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ­ÙˆÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯',
            'use_form_above_transfer': 'Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ ØªØ­ÙˆÙŠÙ„',
            'transfer_details': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'close': 'Ø¥ØºÙ„Ø§Ù‚',
            // JavaScript translations
            'choose_destination_vessel': 'Ø§Ø®ØªØ± Ø§Ù„Ø³ÙÙŠÙ†Ø© Ø§Ù„Ù…Ù‚ØµÙˆØ¯Ø©...',
            'multiple_products_found': 'Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©:',
            'available': 'Ù…ØªÙˆÙØ±',
            'selected': 'Ù…Ø®ØªØ§Ø±',
            'units_available': 'ÙˆØ­Ø¯Ø© Ù…ØªÙˆÙØ±Ø©',
            'purchase_date': 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡',
            'available_quantity': 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©',
            'unit_cost': 'ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©',
            'total_value': 'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©',
            'fifo_order': 'ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹',
            'first_oldest': 'Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø£Ù‚Ø¯Ù…)',
            'second': 'Ø§Ù„Ø«Ø§Ù†ÙŠ',
            'transfer_fifo_info': 'Ø³ÙŠØ³ØªÙ‡Ù„Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹',
            'insufficient_inventory': 'Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ…ÙŠØ©!',
            'will_consume': 'Ø³ÙŠØ³ØªÙ‡Ù„Ùƒ',
            'units_at': 'ÙˆØ­Ø¯Ø§Øª Ø¨Ø³Ø¹Ø±',
            'from_date': 'Ù…Ù†',
            'will_create': 'Ø³ÙŠÙ†Ø´Ø¦',
            'preserves_cost': 'ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰',
            'cost': 'ØªÙƒÙ„ÙØ©',
            'error_duty_free_vessel': 'Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­ÙˆÙŠÙ„ Ù…Ù†ØªØ¬ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø±Ø© Ø¥Ù„Ù‰',
            'vessel_no_duty_free': '(Ø§Ù„Ø³ÙÙŠÙ†Ø© Ù„Ø§ ØªØ¯Ø¹Ù… Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø±Ø©).',
            'confirm_transfer': 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„:',
            'from_label': 'Ù…Ù†:',
            'to_label': 'Ø¥Ù„Ù‰:',
            'product_label': 'Ø§Ù„Ù…Ù†ØªØ¬:',
            'quantity_label': 'Ø§Ù„ÙƒÙ…ÙŠØ©:',
            'preserve_fifo_costs': 'Ø³ÙŠØ­Ø§ÙØ¸ Ù‡Ø°Ø§ Ø¹Ù„Ù‰ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ',
            'processing_transfer': 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„...',
            'transfer_completed': 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
            'transfer_failed': 'ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„:',
            'transfer_system_error': 'ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
            'no_products_found': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù…Ø®Ø²ÙˆÙ† Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙÙŠÙ†Ø©.',
            'error_searching_products': 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
            'feature_coming_soon': 'ðŸš€ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚Ø§Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹! ØªØ±Ù‚Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª.'
        }
    };

    // Merge with global translations
    const currentTranslations = window.translator.translations;
    Object.keys(pageTranslations).forEach(lang => {
        if (currentTranslations[lang]) {
            Object.assign(currentTranslations[lang], pageTranslations[lang]);
        }
    });
    
    // Apply translations
    updatePageTranslations();
});

// Populate destination vessel when source is selected
document.getElementById('fromVessel').addEventListener('change', function() {
    const fromVesselId = this.value;
    const toVesselSelect = document.getElementById('toVessel');
    const productSearch = document.getElementById('productSearch');
    
    // Clear everything
    clearProductSelection();
    
    if (fromVesselId) {
        // Enable destination vessel and product search
        toVesselSelect.disabled = false;
        productSearch.disabled = false;
        
        // Populate destination options (exclude source vessel)
        toVesselSelect.innerHTML = `<option value="">${_('choose_destination_vessel')}</option>`;
        
        // Get all vessel options from the source select
        const sourceOptions = document.getElementById('fromVessel').options;
        for (let i = 1; i < sourceOptions.length; i++) { // Skip first "Choose..." option
            const option = sourceOptions[i];
            if (option.value !== fromVesselId) {
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.dataset.name = option.dataset.name;
                newOption.dataset.nameAr = option.dataset.nameAr;
                newOption.dataset.dutyFree = option.dataset.dutyFree;
                
                // Set option text based on current language
                const currentLang = window.translator.currentLanguage;
                const vesselName = (currentLang === 'ar' && option.dataset.nameAr) ? option.dataset.nameAr : option.dataset.name;
                const dutyFreeText = option.dataset.dutyFree === 'true' ? ` (${_('duty_free')})` : '';
                newOption.textContent = vesselName + dutyFreeText;
                
                toVesselSelect.appendChild(newOption);
            }
        }
    } else {
        // Disable everything
        toVesselSelect.disabled = true;
        productSearch.disabled = true;
        toVesselSelect.innerHTML = `<option value="">${_('first_select_source_vessel')}</option>`;
        productSearch.placeholder = _('select_source_vessel_first');
    }
});

// Product search with debouncing
let searchTimeout;
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.trim();
    const fromVesselId = document.getElementById('fromVessel').value;
    
    clearTimeout(searchTimeout);
    
    if (searchTerm.length >= 2 && fromVesselId) {
        searchTimeout = setTimeout(() => {
            searchProducts(searchTerm, fromVesselId);
        }, 500);
    } else {
        clearProductSelection();
    }
});

// Transfer quantity validation
document.getElementById('transferQuantity').addEventListener('input', function() {
    const quantity = parseInt(this.value) || 0;
    updateFifoPreview(quantity);
    validateTransfer();
});

// Destination vessel validation
document.getElementById('toVessel').addEventListener('change', function() {
    validateTransfer();
});

function searchProducts(searchTerm, vesselId) {
    fetch('/transfer/search-products/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            search: searchTerm,
            vessel_id: vesselId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.products.length > 0) {
            displayProductResults(data.products);
        } else {
            clearProductSelection();
            showAlert(_('no_products_found'), 'warning');
        }
    })
    .catch(error => {
        console.error('Error searching products:', error);
        showAlert(_('error_searching_products'), 'danger');
    });
}

function displayProductResults(products) {
    const resultsDiv = document.getElementById('productResults');
    const productInfo = document.getElementById('selectedProductInfo');
    
    if (products.length === 1) {
        // Auto-select if only one result
        selectProduct(products[0]);
    } else {
        // Show selection list
        productInfo.innerHTML = `
            <h6>${_('multiple_products_found')}</h6>
            <div class="list-group">
                ${products.map(product => `
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectProduct(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${product.name}</h6>
                                <small class="text-muted">${_('id_label')}: ${product.item_id} â€¢ ${_('available')}: ${translateNumber(product.total_quantity)} ${_('units')}</small>
                            </div>
                            <span class="badge bg-primary" data-number data-original="${product.total_quantity}">${translateNumber(product.total_quantity)}</span>
                        </div>
                    </button>
                `).join('')}
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
}

function selectProduct(product) {
    selectedProduct = product;
    availableLots = product.lots;
    
    // Display selected product
    const productInfo = document.getElementById('selectedProductInfo');
    productInfo.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">${product.name}</h6>
                <small class="text-muted">${_('id_label')}: ${product.item_id} â€¢ ${_('available')}: ${translateNumber(product.total_quantity)} ${_('units')}</small>
            </div>
            <div class="text-end">
                <div class="badge bg-success">${_('selected')}</div>
                <small class="d-block text-muted">${translateNumber(product.total_quantity)} ${_('units_available')}</small>
            </div>
        </div>
    `;
    
    document.getElementById('productResults').style.display = 'block';
    
    // Display FIFO lots
    displayFifoLots(product.lots);
    
    // Show quantity section
    document.getElementById('quantitySection').style.display = 'block';
    document.getElementById('maxQuantity').textContent = translateNumber(product.total_quantity);
    
    // Set max quantity
    document.getElementById('transferQuantity').max = product.total_quantity;
    
    // Check duty-free compatibility
    checkDutyFreeCompatibility(product);
    
    validateTransfer();
}

function displayFifoLots(lots) {
    const fifoDiv = document.getElementById('fifoLots');
    
    fifoDiv.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>${_('purchase_date')}</th>
                        <th>${_('available_quantity')}</th>
                        <th>${_('unit_cost')}</th>
                        <th>${_('total_value')}</th>
                        <th>${_('fifo_order')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${lots.map((lot, index) => `
                        <tr class="${index === 0 ? 'table-warning' : ''}">
                            <td>${lot.purchase_date}</td>
                            <td data-number data-original="${lot.remaining_quantity}">${translateNumber(lot.remaining_quantity)}</td>
                            <td><span data-number data-original="${lot.purchase_price.toFixed(3)}">${translateNumber(lot.purchase_price.toFixed(3))}</span> <span data-currency-symbol>JOD</span></td>
                            <td><span data-number data-original="${(lot.remaining_quantity * lot.purchase_price).toFixed(3)}">${translateNumber((lot.remaining_quantity * lot.purchase_price).toFixed(3))}</span> <span data-currency-symbol>JOD</span></td>
                            <td>
                                ${index === 0 ? `<span class="badge bg-warning">${_('first_oldest')}</span>` : 
                                  index === 1 ? `<span class="badge bg-info">${_('second')}</span>` : 
                                  `<span class="badge bg-secondary">#${translateNumber(index + 1)}</span>`}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> ${_('transfer_fifo_info')}
        </small>
    `;
    
    document.getElementById('inventoryInfo').style.display = 'block';
}

function updateFifoPreview(quantity) {
    if (!selectedProduct || quantity <= 0) {
        document.getElementById('fifoPreview').style.display = 'none';
        return;
    }
    
    // Calculate FIFO consumption
    let remainingToConsume = quantity;
    let consumptionPlan = [];
    
    for (let lot of availableLots) {
        if (remainingToConsume <= 0) break;
        
        const consumeFromThisLot = Math.min(lot.remaining_quantity, remainingToConsume);
        consumptionPlan.push({
            ...lot,
            consume_quantity: consumeFromThisLot
        });
        remainingToConsume -= consumeFromThisLot;
    }
    
    if (remainingToConsume > 0) {
        showAlert(_('insufficient_inventory'), 'danger');
        return;
    }
    
    // Display preview
    const fromVesselSelect = document.getElementById('fromVessel');
    const toVesselSelect = document.getElementById('toVessel');
    const currentLang = window.translator.currentLanguage;
    
    const fromVesselName = fromVesselSelect.selectedOptions[0] ? 
        (currentLang === 'ar' && fromVesselSelect.selectedOptions[0].dataset.nameAr ? 
         fromVesselSelect.selectedOptions[0].dataset.nameAr : 
         fromVesselSelect.selectedOptions[0].dataset.name) : '--';
         
    const toVesselName = toVesselSelect.selectedOptions[0] ? 
        (currentLang === 'ar' && toVesselSelect.selectedOptions[0].dataset.nameAr ? 
         toVesselSelect.selectedOptions[0].dataset.nameAr : 
         toVesselSelect.selectedOptions[0].dataset.name) : '--';
    
    document.getElementById('previewFromVessel').textContent = fromVesselName;
    document.getElementById('previewToVessel').textContent = toVesselName;
    
    document.getElementById('previewConsumption').innerHTML = consumptionPlan.map(lot => 
        `${_('will_consume')} ${translateNumber(lot.consume_quantity)} ${_('units_at')} ${translateNumber(lot.purchase_price.toFixed(3))} <span data-currency-symbol>JOD</span> (${_('from_date')} ${lot.purchase_date})`
    ).join('<br>');
    
    document.getElementById('previewCreation').innerHTML = consumptionPlan.map(lot => 
        `${_('will_create')} ${translateNumber(lot.consume_quantity)} ${_('units_at')} ${translateNumber(lot.purchase_price.toFixed(3))} <span data-currency-symbol>JOD</span> (${_('preserves_cost')} ${lot.purchase_date} ${_('cost')})`
    ).join('<br>');
    
    document.getElementById('fifoPreview').style.display = 'block';
    
    // Apply translations to the dynamically created content
    updatePageTranslations();
}

function checkDutyFreeCompatibility(product) {
    const toVessel = document.getElementById('toVessel');
    const warning = document.getElementById('dutyFreeWarning');
    
    if (product.is_duty_free && toVessel.value) {
        const destinationSupportsDutyFree = toVessel.selectedOptions[0]?.dataset.dutyFree === 'true';
        if (!destinationSupportsDutyFree) {
            warning.style.display = 'block';
            const currentLang = window.translator.currentLanguage;
            const vesselName = currentLang === 'ar' && toVessel.selectedOptions[0]?.dataset.nameAr ? 
                              toVessel.selectedOptions[0].dataset.nameAr : 
                              toVessel.selectedOptions[0]?.dataset.name;
            warning.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>${_('error_duty_free_vessel')}</strong> ${vesselName} 
                ${_('vessel_no_duty_free')}
            `;
            warning.className = 'alert alert-danger';
        } else {
            warning.style.display = 'block';
        }
    } else {
        warning.style.display = 'none';
    }
}

function validateTransfer() {
    const fromVessel = document.getElementById('fromVessel').value;
    const toVessel = document.getElementById('toVessel').value;
    const quantity = parseInt(document.getElementById('transferQuantity').value) || 0;
    const transferButton = document.getElementById('transferButton');
    
    let isValid = true;
    
    // Basic validation
    if (!fromVessel || !toVessel || !selectedProduct || quantity <= 0) {
        isValid = false;
    }
    
    // Quantity validation
    if (quantity > selectedProduct?.total_quantity) {
        isValid = false;
    }
    
    // Duty-free validation
    if (selectedProduct?.is_duty_free) {
        const destinationSupportsDutyFree = document.getElementById('toVessel').selectedOptions[0]?.dataset.dutyFree === 'true';
        if (!destinationSupportsDutyFree) {
            isValid = false;
        }
    }
    
    transferButton.disabled = !isValid;
}

function clearProductSelection() {
    selectedProduct = null;
    availableLots = [];
    document.getElementById('productResults').style.display = 'none';
    document.getElementById('inventoryInfo').style.display = 'none';
    document.getElementById('quantitySection').style.display = 'none';
    document.getElementById('fifoPreview').style.display = 'none';
    document.getElementById('dutyFreeWarning').style.display = 'none';
    document.getElementById('transferButton').disabled = true;
}

function clearForm() {
    document.getElementById('transferForm').reset();
    document.getElementById('toVessel').disabled = true;
    document.getElementById('productSearch').disabled = true;
    clearProductSelection();
}

// Form submission
document.getElementById('transferForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!validateTransferForm()) return;
    
    const fromVesselSelect = document.getElementById('fromVessel');
    const toVesselSelect = document.getElementById('toVessel');
    const currentLang = window.translator.currentLanguage;
    
    const fromVesselName = currentLang === 'ar' && fromVesselSelect.selectedOptions[0].dataset.nameAr ? 
                          fromVesselSelect.selectedOptions[0].dataset.nameAr : 
                          fromVesselSelect.selectedOptions[0].dataset.name;
    const toVesselName = currentLang === 'ar' && toVesselSelect.selectedOptions[0].dataset.nameAr ? 
                        toVesselSelect.selectedOptions[0].dataset.nameAr : 
                        toVesselSelect.selectedOptions[0].dataset.name;
    
    const formData = {
        from_vessel_id: fromVesselSelect.value,
        to_vessel_id: toVesselSelect.value,
        product_id: selectedProduct.id,
        quantity: parseInt(document.getElementById('transferQuantity').value),
        transfer_date: document.getElementById('transferDate').value,
        notes: document.getElementById('transferNotes').value.trim()
    };
    
    // Show confirmation dialog
    const confirmMessage = `${_('confirm_transfer')}\n\n${_('from_label')} ${fromVesselName}\n${_('to_label')} ${toVesselName}\n${_('product_label')} ${selectedProduct.name}\n${_('quantity_label')} ${translateNumber(formData.quantity)} ${_('units')}\n\n${_('preserve_fifo_costs')}`;
    
    if (confirm(confirmMessage)) {
        executeTransfer(formData);
    }
});

function validateTransferForm() {
    return document.getElementById('fromVessel').value && 
           document.getElementById('toVessel').value && 
           selectedProduct && 
           parseInt(document.getElementById('transferQuantity').value) > 0;
}

function executeTransfer(formData) {
    const submitButton = document.getElementById('transferButton');
    const originalText = submitButton.innerHTML;
    
    submitButton.innerHTML = `<span class="loading"></span> ${_('processing_transfer')}`;
    submitButton.disabled = true;
    
    fetch('/transfer/execute/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`${_('transfer_completed')} ${data.message}`, 'success');
            clearForm();
            // Redirect to inventory to see updated stock
            setTimeout(() => {
                window.location.href = "{% url 'frontend:inventory_check' %}";
            }, 2000);
        } else {
            showAlert(`${_('transfer_failed')} ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Transfer error:', error);
        showAlert(_('transfer_system_error'), 'danger');
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function viewTransferDetails(transferId) {
    // Implementation for viewing transfer details
    showComingSoon();
}

function showComingSoon() {
    alertTranslated('feature_coming_soon');
}
</script>
{% endblock %}