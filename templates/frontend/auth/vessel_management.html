{% extends 'frontend/base.html' %}
{% load static %}
{% csrf_token %}

{% block title %}
    <span data-translate="vessel_management">Vessel Management</span> - <span data-translate="vessel_sales_system">Vessel Sales System</span>
{% endblock %}

{% block extra_css %}
<style>
/* OPTIMIZED: Consolidated styling */
.stats-card {
    background: white;
    border: 1px solid #e0e6ed;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.vessel-card {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,.125);
}

.vessel-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* FIXED RTL: Simplified duty-free indicator */
.duty-free-indicator {
    position: absolute;
    top: 10px;
    inset-inline-end: 10px; /* RTL-aware positioning */
    background: linear-gradient(135deg, #ffc107, #ff8c00);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.7rem;
    font-weight: bold;
}

.vessel-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* OPTIMIZED: Pricing status styles */
.pricing-status-section {
    border-top: 1px solid #e9ecef;
    margin-top: 1rem;
    padding-top: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 0 0 8px 8px;
}

.pricing-status-complete, .pricing-status-incomplete, .pricing-status-na {
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
}

.pricing-status-complete {
    color: var(--success-green);
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.2);
}

.pricing-status-incomplete {
    color: var(--warning-orange);
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.pricing-status-na {
    color: var(--dark-gray);
    background: rgba(108, 117, 125, 0.1);
    border: 1px solid rgba(108, 117, 125, 0.2);
}

.pricing-completion-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.pricing-completion-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--success-green), #20c997);
}

.pricing-completion-incomplete .pricing-completion-fill {
    background: linear-gradient(90deg, var(--warning-orange), #ffc107);
}

/* Loading overlay */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="bi bi-ship me-2" style="color: var(--secondary-blue);"></i>
                        <span data-translate="vessel_management">Vessel Management</span>
                    </h2>
                    <p class="text-muted mb-0" data-translate="vessel_management_desc">
                        Manage vessel fleet, configurations, and operational status
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createVesselModal">
                        <i class="bi bi-ship me-2"></i>
                        <span data-translate="add_vessel">Add Vessel</span>
                    </button>
                    <a href="{% url 'frontend:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        <span data-translate="back_to_dashboard">Back to Dashboard</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- OPTIMIZED: Date Filter Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-2">
                                <i class="bi bi-calendar3 me-2"></i>
                                <span data-translate="revenue_date_filter">Revenue Date Filter</span>
                            </h5>
                            <p class="text-muted mb-0">
                                <span data-translate="select_date_for_30day_revenue">Select a date to calculate 30-day revenue ending on that date</span>
                            </p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <span data-translate="reference_date">Reference Date</span>
                            </label>
                            <input type="date" id="referenceDatePicker" class="form-control" 
                                   value="{{ reference_date|date:'Y-m-d' }}" max="{{ today|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <span data-translate="date_range">Date Range</span>
                            </label>
                            <div class="form-control bg-light">
                                <span id="dateRangeDisplay">{{ thirty_days_ago|date:'d/m/Y' }} - {{ reference_date|date:'d/m/Y' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%); color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number" data-number data-original="{{ stats.total_vessels }}">{{ stats.total_vessels }}</div>
                        <div class="stats-label text-white" data-translate="total_vessels">Total Vessels</div>
                    </div>
                    <i class="bi bi-ship" style="font-size: 2.5rem; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--success-green) 0%, #20c997 100%); color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number" data-number data-original="{{ stats.active_vessels }}">{{ stats.active_vessels }}</div>
                        <div class="stats-label text-white" data-translate="active_vessels">Active Vessels</div>
                    </div>
                    <i class="bi bi-check-circle" style="font-size: 2.5rem; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--warning-orange) 0%, #ffc107 100%); color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number" data-number data-original="{{ stats.duty_free_vessels }}">{{ stats.duty_free_vessels }}</div>
                        <div class="stats-label text-white" data-translate="duty_free_vessels">Duty-Free Vessels</div>
                    </div>
                    <i class="bi bi-star" style="font-size: 2.5rem; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, var(--accent-blue) 0%, #87ceeb 100%); color: var(--primary-blue);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number" data-number data-original="{{ stats.inactive_vessels }}">{{ stats.inactive_vessels }}</div>
                        <div class="stats-label" data-translate="inactive_vessels" style="color: var(--primary-blue);">Inactive Vessels</div>
                    </div>
                    <i class="bi bi-pause-circle" style="font-size: 2.5rem; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- SINGLE WARNING: Vessel Pricing Status Alert (KEEP THIS ONE ONLY) -->
    {% if pricing_summary.vessels_with_incomplete_pricing > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning border-0 shadow-sm">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="mb-1"><span data-translate="vessel_pricing_issues">Vessel Pricing Issues Detected</span></h6>
                        <small class="mb-0">
                            <span data-number data-original="{{ pricing_summary.vessels_with_incomplete_pricing }}">{{ pricing_summary.vessels_with_incomplete_pricing }}</span> 
                            <span data-translate="vessels_incomplete_pricing">vessels have incomplete pricing for</span>
                            <span data-number data-original="{{ pricing_summary.total_missing_prices }}">{{ pricing_summary.total_missing_prices }}</span> 
                            <span data-translate="products">products</span>
                        </small>
                    </div>
                    <div class="text-end">
                        <a href="{% url 'frontend:bulk_pricing_management' %}" class="btn btn-warning btn-sm">
                            <i class="bi bi-gear"></i> <span data-translate="fix_pricing">Fix Pricing</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- OPTIMIZED: Vessel Fleet Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3 me-2"></i>
                        <span data-translate="vessel_fleet">Vessel Fleet</span>
                    </h5>
                </div>
                <div class="card-body position-relative">
                    <!-- Loading overlay -->
                    <div class="loading-overlay d-none" id="loadingOverlay">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="row" id="vesselGridContainer">
                        {% for vessel_info in vessel_data %}
                        <div class="col-lg-4 col-md-6 mb-4" data-vessel-id="{{ vessel_info.vessel.id }}">
                            <div class="vessel-card card h-100 position-relative">
                                {% if vessel_info.vessel.has_duty_free %}
                                <div class="duty-free-indicator">
                                    <i class="bi bi-star"></i> <span data-translate="duty_free">Duty-Free</span>
                                </div>
                                {% endif %}
                                <div class="card-body text-center">
                                    <div class="vessel-icon">
                                        <i class="bi bi-ship"></i>
                                    </div>
                                    <h5 class="card-title">
                                        <!-- FIXED: Simplified vessel name translation -->
                                        <span class="vessel-name" 
                                              data-en="{{ vessel_info.vessel.name }}" 
                                              data-ar="{{ vessel_info.vessel.name_ar|default:vessel_info.vessel.name }}">
                                            {{ vessel_info.vessel.name }}
                                        </span>
                                    </h5>
                                    
                                    <!-- FIXED: Simplified status badges -->
                                    <div class="mb-3">
                                        <span class="badge vessel-status-badge {% if vessel_info.vessel.active %}bg-success{% else %}bg-danger{% endif %}">
                                            <i class="bi bi-{% if vessel_info.vessel.active %}check{% else %}x{% endif %}-circle me-1"></i>
                                            <span data-translate="{% if vessel_info.vessel.active %}active{% else %}inactive{% endif %}">
                                                {% if vessel_info.vessel.active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </span>
                                        
                                        <span class="badge vessel-status-badge ms-2 {% if vessel_info.vessel.has_duty_free %}bg-warning{% else %}bg-secondary{% endif %}">
                                            <i class="bi bi-{% if vessel_info.vessel.has_duty_free %}star{% else %}x-circle{% endif %} me-1"></i>
                                            <span data-translate="{% if vessel_info.vessel.has_duty_free %}duty_free{% else %}no_duty_free{% endif %}">
                                                {% if vessel_info.vessel.has_duty_free %}Duty-Free{% else %}No Duty-Free{% endif %}
                                            </span>
                                        </span>
                                    </div>
                                    
                                    <!-- FIXED: Show 30-day data instead of total -->
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <small class="text-muted d-block" data-translate="trips_30d">Trips (30d)</small>
                                            <strong class="vessel-total-trips" data-number data-original="{{ vessel_info.trips_30d }}">{{ vessel_info.trips_30d }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">
                                                <span data-translate="revenue_30d">Revenue (30d)</span>
                                            </small>
                                            <strong>
                                                <span class="vessel-revenue-30d" data-number data-original="{{ vessel_info.revenue_30d|floatformat:0 }}">{{ vessel_info.revenue_30d|floatformat:0 }}</span> 
                                                <span data-currency-symbol>JOD</span>
                                            </strong>
                                        </div>
                                    </div>
                                    
                                    <!-- OPTIMIZED: Vessel Pricing Status Section -->
                                    <div class="pricing-status-section">
                                        {% if vessel_info.vessel.has_duty_free %}
                                        <!-- Duty-free vessels don't use custom pricing -->
                                        <div class="pricing-status-na text-center">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <span data-translate="duty_free_pricing">Duty-Free Pricing</span>
                                        </div>
                                        <small class="text-muted d-block mt-2" data-translate="uses_default_pricing">Uses default product pricing</small>
                                        {% else %}
                                        <!-- Touristic vessels with custom pricing -->
                                        {% if vessel_info.pricing_warnings.has_warnings %}
                                        <div class="pricing-status-incomplete text-center">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            <span data-number data-original="{{ vessel_info.pricing_warnings.missing_price_count }}">{{ vessel_info.pricing_warnings.missing_price_count }}</span>
                                            <span data-translate="products_missing_pricing">products missing custom pricing</span>
                                        </div>
                                        {% else %}
                                        <div class="pricing-status-complete text-center">
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span data-translate="all_products_priced">All products priced</span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Pricing completion bar -->
                                        {% if vessel_info.pricing_data.total_products > 0 %}
                                        <div class="pricing-completion-bar {% if vessel_info.pricing_warnings.has_warnings %}pricing-completion-incomplete{% endif %}">
                                            <div class="pricing-completion-fill" 
                                                style="width: {{ vessel_info.pricing_data.completion_percentage }}%"></div>
                                        </div>
                                        <div class="text-center">
                                            <small class="text-muted">
                                                <span data-number data-original="{{ vessel_info.pricing_data.products_priced }}">{{ vessel_info.pricing_data.products_priced }}</span>/<span data-number data-original="{{ vessel_info.pricing_data.total_products }}">{{ vessel_info.pricing_data.total_products }}</span> 
                                                <span data-translate="products_priced">products priced</span>
                                                <span class="ms-2">
                                                    (<span dir="ltr" data-number data-original="{{ vessel_info.pricing_data.completion_percentage }}">{{ vessel_info.pricing_data.completion_percentage }}</span>%)
                                                </span>
                                            </small>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Quick action button for pricing -->
                                        <div class="text-center mt-2">
                                            <a href="{% url 'frontend:bulk_pricing_management' %}?vessel={{ vessel_info.vessel.id }}" 
                                               class="btn {% if vessel_info.pricing_warnings.has_warnings %}btn-warning{% else %}btn-outline-success{% endif %} btn-sm">
                                                <i class="bi bi-{% if vessel_info.pricing_warnings.has_warnings %}gear{% else %}eye{% endif %} me-1"></i>
                                                <span data-translate="{% if vessel_info.pricing_warnings.has_warnings %}fix_pricing{% else %}view_pricing{% endif %}">
                                                    {% if vessel_info.pricing_warnings.has_warnings %}Fix Pricing{% else %}View Pricing{% endif %}
                                                </span>
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="btn-group w-100 mt-3">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editVessel({{ vessel_info.vessel.id }}, '{{ vessel_info.vessel.name }}', '{{ vessel_info.vessel.name_ar|default:vessel_info.vessel.name }}', {{ vessel_info.vessel.has_duty_free|yesno:'true,false' }}, {{ vessel_info.vessel.active|yesno:'true,false' }})">
                                            <i class="bi bi-pencil"></i> <span data-translate="edit">Edit</span>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="viewVesselStats({{ vessel_info.vessel.id }}, '{{ vessel_info.vessel.name }}')">
                                            <i class="bi bi-graph-up"></i> <span data-translate="stats">Stats</span>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="toggleVesselStatus({{ vessel_info.vessel.id }}, '{{ vessel_info.vessel.name }}', {{ vessel_info.vessel.active|yesno:'true,false' }})">
                                            {% if vessel_info.vessel.active %}
                                            <i class="bi bi-pause"></i> <span data-translate="deactivate">Deactivate</span>
                                            {% else %}
                                            <i class="bi bi-play"></i> <span data-translate="activate">Activate</span>
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Vessel Modal -->
<div class="modal fade" id="createVesselModal" tabindex="-1" aria-labelledby="createVesselModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createVesselModalLabel">
                    <i class="bi bi-ship me-2"></i>
                    <span data-translate="add_new_vessel">Add New Vessel</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createVesselForm" method="POST" action="{% url 'frontend:create_vessel' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship me-1"></i>
                                <span data-translate="vessel_name_english">Vessel Name (English)</span> *
                            </label>
                            <input type="text" class="form-control" name="name" required 
                                   placeholder="e.g., Amman, Aylah, Sinaa"
                                   data-placeholder-en="e.g., Amman, Aylah, Sinaa"
                                   data-placeholder-ar="مثال: Amman, Aylah, Sinaa">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-translate me-1"></i>
                                <span data-translate="vessel_name_arabic">Vessel Name (Arabic)</span>
                            </label>
                            <input type="text" class="form-control" name="name_ar" 
                                   placeholder="e.g., عمان، أيلة، سيناء"
                                   data-placeholder-en="e.g., عمان، أيلة، سيناء"
                                   data-placeholder-ar="مثال: عمان، أيلة، سيناء">
                        </div>
                        <div class="col-12 mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="has_duty_free" id="createHasDutyFree">
                                        <label class="form-check-label fw-bold" for="createHasDutyFree">
                                            <i class="bi bi-star me-1"></i>
                                            <span data-translate="duty_free_enabled">Duty-Free Enabled</span>
                                        </label>
                                        <small class="text-muted d-block"><span data-translate="vessel_can_sell_duty_free">Vessel can sell duty-free products</span></small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="active" id="createActive" checked>
                                        <label class="form-check-label fw-bold" for="createActive">
                                            <i class="bi bi-check-circle me-1"></i>
                                            <span data-translate="active_vessel">Active Vessel</span>
                                        </label>
                                        <small class="text-muted d-block"><span data-translate="vessel_available_operations">Vessel available for operations</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <span data-translate="cancel">Cancel</span>
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-ship me-1"></i>
                        <span data-translate="create_vessel">Create Vessel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Vessel Modal -->
<div class="modal fade" id="editVesselModal" tabindex="-1" aria-labelledby="editVesselModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVesselModalLabel">
                    <i class="bi bi-pencil me-2"></i>
                    <span data-translate="edit_vessel">Edit Vessel</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editVesselForm" method="POST">
                {% csrf_token %}
                <input type="hidden" id="editVesselId" name="vessel_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-ship me-1"></i>
                                <span data-translate="vessel_name_english">Vessel Name (English)</span> *
                            </label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-translate me-1"></i>
                                <span data-translate="vessel_name_arabic">Vessel Name (Arabic)</span>
                            </label>
                            <input type="text" class="form-control" id="editNameAr" name="name_ar">
                        </div>
                        <div class="col-12 mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="has_duty_free" id="editHasDutyFree">
                                        <label class="form-check-label fw-bold" for="editHasDutyFree">
                                            <i class="bi bi-star me-1"></i>
                                            <span data-translate="duty_free_enabled">Duty-Free Enabled</span>
                                        </label>
                                        <small class="text-muted d-block"><span data-translate="vessel_can_sell_duty_free">Vessel can sell duty-free products</span></small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="active" id="editActive">
                                        <label class="form-check-label fw-bold" for="editActive">
                                            <i class="bi bi-check-circle me-1"></i>
                                            <span data-translate="active_vessel">Active Vessel</span>
                                        </label>
                                        <small class="text-muted d-block"><span data-translate="vessel_available_operations">Vessel available for operations</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <span data-translate="cancel">Cancel</span>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>
                        <span data-translate="update_vessel">Update Vessel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Vessel Stats Modal -->
<div class="modal fade" id="vesselStatsModal" tabindex="-1" aria-labelledby="vesselStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vesselStatsModalLabel">
                    <i class="bi bi-graph-up me-2"></i>
                    <span id="statsVesselName">Vessel</span> <span data-translate="statistics">Statistics</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number text-primary" id="statsTotalTrips" data-number>-</div>
                            <div class="stats-label" data-translate="total_trips">Total Trips</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number text-success" id="statsTotalRevenue">-</div>
                            <div class="stats-label" data-translate="total_revenue">Total Revenue</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number text-info" id="statsTotalPassengers" data-number>-</div>
                            <div class="stats-label" data-translate="total_passengers">Total Passengers</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number text-warning" id="statsAvgRevenue">-</div>
                            <div class="stats-label" data-translate="avg_revenue_per_passenger">Avg Revenue/Passenger</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" data-translate="recent_performance">Recent Performance</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="vesselPerformanceChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" data-translate="top_products">Top Products</h6>
                            </div>
                            <div class="card-body" id="topProductsList">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-translate="close">Close</span>
                </button>
                <button type="button" class="btn btn-primary" onclick="exportVesselStats()">
                    <i class="bi bi-download me-1"></i>
                    <span data-translate="export_stats">Export Stats</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // MINIMAL page-specific translations - ONLY NEW KEYS NOT IN translations.js
    const pageTranslations = {
        en: {
            'add_new_vessel': 'Add New Vessel',
            'vessel_name_english': 'Vessel Name (English)',
            'vessel_name_arabic': 'Vessel Name (Arabic)', 
            'duty_free_enabled': 'Duty-Free Enabled',
            'vessel_can_sell_duty_free': 'Vessel can sell duty-free products',
            'active_vessel': 'Active Vessel',
            'vessel_available_operations': 'Vessel available for operations',
            'create_vessel': 'Create Vessel',
            'edit_vessel': 'Edit Vessel',
            'update_vessel': 'Update Vessel',
            'recent_performance': 'Recent Performance',
            'export_stats': 'Export Stats',
            'no_duty_free': 'No Duty-Free',
            'products_missing_pricing': 'products missing custom pricing',
            'trips_30d': 'Trips (30d)',
            'confirm_deactivate_vessel': 'Deactivate vessel "{vessel_name}"?',
            'confirm_activate_vessel': 'Activate vessel "{vessel_name}"?',
            'vessel_deactivated_success': 'Vessel "{vessel_name}" has been deactivated successfully.',
            'vessel_activated_success': 'Vessel "{vessel_name}" has been activated successfully.',
            'vessel_created_success': 'Vessel "{vessel_name}" created successfully!',
            'vessel_updated_success': 'Vessel "{vessel_name}" updated successfully!',
            'error_updating_vessel_status': 'Error updating vessel status',
            'error_creating_vessel': 'Error creating vessel',
            'error_updating_vessel': 'Error updating vessel',
            'error_updating_vessel_data': 'Error updating vessel data',
            'error_processing_request': 'Error processing request',
            'unknown_error': 'Unknown error occurred',
            'operation_completed': 'Operation completed successfully',
            'loading_vessel_data': 'Loading vessel data...',
            'updating_vessel_status': 'Updating vessel status...',
            'creating_vessel': 'Creating vessel...',
            'updating_vessel': 'Updating vessel...',
            'notification': 'Notification',
            'confirm': 'Confirm',
            'ok': 'OK',
        },
        ar: {
            'add_new_vessel': 'إضافة سفينة جديدة',
            'vessel_name_english': 'اسم السفينة (الإنجليزية)',
            'vessel_name_arabic': 'اسم السفينة (العربية)',
            'duty_free_enabled': 'سوق حرة مفعلة',
            'vessel_can_sell_duty_free': 'يمكن للسفينة بيع منتجات السوق الحرة',
            'active_vessel': 'سفينة نشطة',
            'vessel_available_operations': 'السفينة متاحة للعمليات',
            'create_vessel': 'إنشاء سفينة',
            'edit_vessel': 'تحرير السفينة',
            'update_vessel': 'تحديث السفينة',
            'recent_performance': 'الأداء الحديث',
            'export_stats': 'تصدير الإحصائيات',
            'no_duty_free': 'غير سوق حرة',
            'products_missing_pricing': 'منتجات تفتقر للتسعير المخصص',
            'trips_30d': 'الرحلات (٣٠ يوم)',
            'confirm_deactivate_vessel': 'إلغاء تفعيل السفينة "{vessel_name}"؟',
            'confirm_activate_vessel': 'تفعيل السفينة "{vessel_name}"؟',
            'vessel_deactivated_success': 'تم إلغاء تفعيل السفينة "{vessel_name}" بنجاح.',
            'vessel_activated_success': 'تم تفعيل السفينة "{vessel_name}" بنجاح.',
            'vessel_created_success': 'تم إنشاء السفينة "{vessel_name}" بنجاح!',
            'vessel_updated_success': 'تم تحديث السفينة "{vessel_name}" بنجاح!',
            'error_updating_vessel_status': 'خطأ في تحديث حالة السفينة',
            'error_creating_vessel': 'خطأ في إنشاء السفينة',
            'error_updating_vessel': 'خطأ في تحديث السفينة',
            'error_updating_vessel_data': 'خطأ في تحديث بيانات السفينة',
            'error_processing_request': 'خطأ في معالجة الطلب',
            'unknown_error': 'حدث خطأ غير معروف',
            'operation_completed': 'تمت العملية بنجاح',
            'loading_vessel_data': 'جاري تحميل بيانات السفينة...',
            'updating_vessel_status': 'جاري تحديث حالة السفينة...',
            'creating_vessel': 'جاري إنشاء السفينة...',
            'updating_vessel': 'جاري تحديث السفينة...',
            'notification': 'إشعار',
            'confirm': 'تأكيد',
            'ok': 'موافق',
        }
    };

    // Merge with global translations - OPTIMIZED: Single merge operation
    const currentTranslations = window.translator.translations;
    Object.keys(pageTranslations).forEach(lang => {
        if (currentTranslations[lang]) {
            Object.assign(currentTranslations[lang], pageTranslations[lang]);
        }
    });
    
    // Apply translations
    window.updatePageTranslations();
    updatePageTitle();
    
    // Date picker functionality - OPTIMIZED
    const datePicker = document.getElementById('referenceDatePicker');
    const dateRangeDisplay = document.getElementById('dateRangeDisplay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    datePicker?.addEventListener('change', function() {
        const selectedDate = this.value;
        if (selectedDate) updateVesselData(selectedDate);
    });
    
    // OPTIMIZED: Single AJAX update function
    async function updateVesselData(selectedDate) {
        loadingOverlay?.classList.remove('d-none');
        
        const refDate = new Date(selectedDate);
        const thirtyDaysAgo = new Date(refDate.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        if (dateRangeDisplay) {
            const formatDate = date => date.toLocaleDateString('en-GB');
            dateRangeDisplay.textContent = `${formatDate(thirtyDaysAgo)} - ${formatDate(refDate)}`;
        }
        
        try {
            const response = await fetch('{% url "frontend:vessel_data_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ date: selectedDate })
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateVesselCards(data.vessel_data);
                window.updatePageTranslations();
                updateVesselSpecificTranslations();
            } else {
                await alertTranslated('error_updating_vessel_data');
            }
        } catch (error) {
            await alertTranslated('error_updating_vessel_data');
        } finally {
            loadingOverlay?.classList.add('d-none');
        }
    }
    
    // OPTIMIZED: Update vessel cards function
    function updateVesselCards(vesselData) {
        vesselData.forEach(vessel => {
            const vesselCard = document.querySelector(`[data-vessel-id="${vessel.vessel_id}"]`);
            if (vesselCard) {
                // Update 30-day trips
                const totalTripsEl = vesselCard.querySelector('.vessel-total-trips');
                if (totalTripsEl) {
                    totalTripsEl.setAttribute('data-original', vessel.trips_30d);
                    totalTripsEl.textContent = window.translateNumber ? 
                        window.translateNumber(vessel.trips_30d) : vessel.trips_30d;
                }
                
                // Update revenue
                const revenueEl = vesselCard.querySelector('.vessel-revenue-30d');
                if (revenueEl) {
                    const formattedRevenue = Math.round(vessel.revenue_30d);
                    revenueEl.setAttribute('data-original', formattedRevenue);
                    revenueEl.textContent = window.translateNumber ? 
                        window.translateNumber(formattedRevenue) : formattedRevenue;
                }
            }
        });
    }
    
    // Modal functions
    window.editVessel = function(vesselId, name, nameAr, hasDutyFree, active) {
        document.getElementById('editVesselId').value = vesselId;
        document.getElementById('editName').value = name;
        document.getElementById('editNameAr').value = nameAr || '';
        document.getElementById('editHasDutyFree').checked = hasDutyFree;
        document.getElementById('editActive').checked = active;
        
        document.getElementById('editVesselForm').action = 
            `{% url 'frontend:edit_vessel' 0 %}`.replace('0', vesselId);
        
        new bootstrap.Modal(document.getElementById('editVesselModal')).show();
        // OPTIMIZED: Single timeout for translations
        setTimeout(() => {
            window.updatePageTranslations();
            updateVesselSpecificTranslations();
        }, 100);
    };

    // OPTIMIZED: Simplified loading message system
    function showLoadingMessage(translationKey) {
        if (window.translator && window.translator._) {
            const message = window.translator._(translationKey);
            const loadingToast = document.createElement('div');
            loadingToast.id = 'loadingToast';
            loadingToast.className = 'toast align-items-center text-white bg-primary border-0 position-fixed top-0 end-0 m-3';
            loadingToast.style.zIndex = '9999';
            loadingToast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(loadingToast);
            
            const toast = new bootstrap.Toast(loadingToast);
            toast.show();
        }
    }

    function hideLoadingMessage() {
        const loadingToast = document.getElementById('loadingToast');
        if (loadingToast) {
            const toast = bootstrap.Toast.getInstance(loadingToast);
            if (toast) {
                toast.hide();
            }
            setTimeout(() => {
                if (loadingToast.parentNode) {
                    loadingToast.parentNode.removeChild(loadingToast);
                }
            }, 500);
        }
    }

    // OPTIMIZED: Toggle vessel status function
    window.toggleVesselStatus = async function(vesselId, vesselName, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        const confirmKey = isActive ? 'confirm_deactivate_vessel' : 'confirm_activate_vessel';
        
        const confirmed = await confirmTranslated(confirmKey, { vessel_name: vesselName });
        if (!confirmed) return;
        
        showLoadingMessage('updating_vessel_status');
        
        try {
            const response = await fetch(`{% url 'frontend:toggle_vessel_status' 0 %}`.replace('0', vesselId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            const data = await response.json();
            
            hideLoadingMessage();
            
            if (data.success) {
                const successKey = isActive ? 'vessel_deactivated_success' : 'vessel_activated_success';
                await alertTranslated(successKey, { vessel_name: vesselName });
                
                // OPTIMIZED: Single reload with delay
                setTimeout(() => location.reload(), 500);
            } else {
                await alertTranslated('error_updating_vessel_status');
            }
        } catch (error) {
            hideLoadingMessage();
            await alertTranslated('error_processing_request');
        }
    };
    
    // OPTIMIZED: View vessel stats function
    window.viewVesselStats = function(vesselId, vesselName) {
        window.currentStatsVesselId = vesselId;
        document.getElementById('statsVesselName').textContent = vesselName;
        
        fetch(`{% url 'frontend:vessel_statistics' 0 %}`.replace('0', vesselId))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update statistics display
                    const statsTotalTrips = document.getElementById('statsTotalTrips');
                    if (statsTotalTrips) {
                        statsTotalTrips.setAttribute('data-original', data.statistics.total_trips);
                        statsTotalTrips.textContent = window.translateNumber ? 
                            window.translateNumber(data.statistics.total_trips) : data.statistics.total_trips;
                    }
                    
                    document.getElementById('statsTotalRevenue').textContent = 
                        data.statistics.total_revenue.toFixed(2) + ' JOD';
                    
                    const statsTotalPassengers = document.getElementById('statsTotalPassengers');
                    if (statsTotalPassengers) {
                        statsTotalPassengers.setAttribute('data-original', data.statistics.total_passengers);
                        statsTotalPassengers.textContent = window.translateNumber ? 
                            window.translateNumber(data.statistics.total_passengers) : data.statistics.total_passengers;
                    }
                    
                    document.getElementById('statsAvgRevenue').textContent = 
                        data.statistics.avg_revenue_per_passenger.toFixed(2) + ' JOD';
                    
                    // Update top products
                    const topProductsList = document.getElementById('topProductsList');
                    if (data.top_products.length > 0) {
                        topProductsList.innerHTML = data.top_products.map(product => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <span>${product.product__name}</span>
                                <span class="badge bg-primary">${window.translateNumber ? 
                                    window.translateNumber(product.total_quantity) : product.total_quantity} 
                                    <span data-translate="units">units</span>
                                </span>
                            </div>
                        `).join('');
                        
                        // OPTIMIZED: Single translation update
                        setTimeout(() => {
                            window.updatePageTranslations();
                            updateVesselSpecificTranslations();
                        }, 0);
                    } else {
                        topProductsList.innerHTML = '<p class="text-muted">No product data available</p>';
                    }
                }
            })
            .catch(error => {
                // Silent error handling - no console logs
                topProductsList.innerHTML = '<p class="text-muted">Error loading data</p>';
            });
        
        new bootstrap.Modal(document.getElementById('vesselStatsModal')).show();
        
        // OPTIMIZED: Single translation update
        setTimeout(() => {
            window.updatePageTranslations();
            updateVesselSpecificTranslations();
        }, 100);
    };
    
    window.exportVesselStats = function() {
        if (window.currentStatsVesselId) {
            window.open(`{% url 'frontend:vessel_statistics' 0 %}`.replace('0', window.currentStatsVesselId) + '?export=1');
        }
    };
    
    // Form handlers - OPTIMIZED
    document.getElementById('createVesselForm')?.addEventListener('submit', handleFormSubmit);
    document.getElementById('editVesselForm')?.addEventListener('submit', handleFormSubmit);
    
    async function handleFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const isCreateForm = this.id === 'createVesselForm';
        const vesselName = formData.get('name');
        
        const loadingKey = isCreateForm ? 'creating_vessel' : 'updating_vessel';
        showLoadingMessage(loadingKey);
        
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });
            
            const data = await response.json();
            
            hideLoadingMessage();
            
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(this.closest('.modal'));
                modal?.hide();
                
                const successKey = isCreateForm ? 'vessel_created_success' : 'vessel_updated_success';
                await alertTranslated(successKey, { vessel_name: vesselName });
                
                // OPTIMIZED: Single reload with delay
                setTimeout(() => location.reload(), 500);
            } else {
                const errorKey = isCreateForm ? 'error_creating_vessel' : 'error_updating_vessel';
                await alertTranslated(errorKey);
            }
        } catch (error) {
            hideLoadingMessage();
            await alertTranslated('error_processing_request');
        }
    }
    
    // OPTIMIZED: Language change listener
    window.addEventListener('languageChanged', function() {
        updateVesselSpecificTranslations();
        updatePageTitle();
    });
    
    // Initial call
    updateVesselSpecificTranslations();
});

// OPTIMIZED: Vessel-specific translations function
function updateVesselSpecificTranslations() {
    document.querySelectorAll('[data-translate="products_missing_pricing"]').forEach(element => {
        const countSpan = element.parentElement.querySelector('[data-number][data-original]');
        if (countSpan) {
            const count = countSpan.getAttribute('data-original') || countSpan.textContent.trim();
            const translatedCount = window.translateNumber ? window.translateNumber(count) : count;
            
            if (window.translator && window.translator._) {
                element.textContent = window.translator._('products_missing_pricing', { count: translatedCount });
            }
        }
    });
}

function updatePageTitle() {
    if (!window.translator || !window.translator._) {
        return;
    }
    
    const vesselManagement = window.translator._('vessel_management');
    const vesselSalesSystem = window.translator._('vessel_sales_system');
    
    document.title = `${vesselManagement} - ${vesselSalesSystem}`;
}
</script>
{% endblock %}