{% extends 'frontend/base.html' %}
{% load dict_extras %}

{% block title %}
{% if mode == 'edit' %}Edit Product{% else %}Add Product{% endif %} - Vessel Sales System
{% endblock %}

{% block extra_css %}
<style>
#productTabs .nav-link {
    color: #0f4c75 !important;
    font-weight: 600 !important;
}

#productTabs .nav-link:hover {
    color: #0a3a5c !important;
}

#productTabs .nav-link.active {
    color: #ffffff !important;
    background-color: #0f4c75 !important;
}

.card {
    border: 1px solid rgba(0,0,0,.125);
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
}

.vessel-pricing-card {
    border-left: 4px solid #ffc107;
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
}

.vessel-price-input {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.vessel-price-input:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.form-floating > label {
    opacity: 0.65;
}

.form-floating > .form-control:focus ~ label,
.form-floating > .form-control:not(:placeholder-shown) ~ label {
    opacity: 0.85;
    transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
}

@media (max-width: 768px) {
    .btn-group-sm {
        flex-direction: column;
    }
    
    .btn-group-sm .btn {
        margin-bottom: 2px;
        border-radius: 4px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<body data-mode="{{ mode }}">
<!-- Product Management Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-box text-primary"></i> 
                    {% if mode == 'edit' %}
                        <span data-translate="edit_product">Edit Product</span>
                    {% else %}
                        <span data-translate="add_new_product">Add New Product</span>
                    {% endif %}
                </h2>
                <p class="text-muted mb-0">
                    {% if mode == 'edit' %}
                        <span data-translate="edit_product_desc">Update product information and pricing</span>
                    {% else %}
                        <span data-translate="add_product_desc">Create a new product with pricing information</span>
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'frontend:product_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> <span data-translate="back_to_products">Back to Products</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs nav-fill" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="{% url 'frontend:product_list' %}" role="tab">
                    <i class="bi bi-list"></i> <span data-translate="product_list">Product List</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if mode == 'create' %}active{% endif %}" 
                   href="{% url 'frontend:product_create' %}" role="tab">
                    <i class="bi bi-plus-circle"></i> <span data-translate="add_product">Add Product</span>
                </a>
            </li>
            {% if mode == 'edit' %}
            <li class="nav-item" role="presentation">
                <a class="nav-link active" href="#" role="tab">
                    <i class="bi bi-pencil"></i> <span data-translate="edit_product">Edit Product</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
</div>

<!-- Product Form -->
<div class="row">
    <div class="col-lg-8 mx-auto">
        <form method="POST" id="productForm" novalidate>
            {% csrf_token %}
            
            <!-- Basic Product Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> <span data-translate="basic_information">Basic Information</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{% if product %}{{ product.name }}{% endif %}" 
                                       placeholder=" " required>
                                <label for="name"><span data-translate="product_name">Product Name</span> *</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="item_id" name="item_id" 
                                       value="{% if product %}{{ product.item_id }}{% endif %}" 
                                       placeholder=" " required>
                                       <label for="item_id"><span data-translate="item_id">Item ID</span> *</label>
                                    </div>
                                </div>
                            </div>
                            <div id="ajaxAlert" class="alert d-none" role="alert"></div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="form-floating">
                                        <select class="form-select" id="category" name="category" required>
                                            <option value=""><span data-translate="select_category">Select Category</span></option>
                                            {% for category in categories %}
                                            <option value="{{ category.id }}" {% if product and product.category.id == category.id %}selected{% endif %}>
                                                {{ category.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                <label for="category"><span data-translate="category">Category</span> *</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="purchase_price" name="purchase_price" 
                                       value="{% if product %}{{ product.purchase_price }}{% endif %}" 
                                       step="0.001" min="0" placeholder=" " required>
                                <label for="purchase_price"><span data-translate="purchase_price">Purchase Price (JOD)</span> *</label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="selling_price" name="selling_price" 
                                       value="{% if product %}{{ product.selling_price }}{% endif %}" 
                                       step="0.001" min="0" placeholder=" " required>
                                <label for="selling_price"><span data-translate="selling_price">Selling Price (JOD)</span> *</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear"></i> <span data-translate="product_settings">Product Settings</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dutyFreeSwitch" name="is_duty_free" 
                                       {% if product and product.is_duty_free %}checked{% endif %}
                                       onchange="toggleVesselPricing()">
                                <label class="form-check-label" for="dutyFreeSwitch">
                                    <span data-translate="duty_free_product">Duty-Free Product</span>
                                </label>
                                <div class="form-text">
                                    <span data-translate="duty_free_desc">Check if this product is duty-free (no vessel-specific pricing needed)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="active" name="active" 
                                       {% if not product or product.active %}checked{% endif %}>
                                <label class="form-check-label" for="active">
                                    <span data-translate="active_product">Active Product</span>
                                </label>
                                <div class="form-text">
                                    <span data-translate="active_desc">Uncheck to deactivate this product</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vessel-Specific Pricing (for General Products only) -->
            <div class="card mb-4 vessel-pricing-card" id="vesselPricingCard" 
                 style="{% if product and product.is_duty_free %}display: none;{% endif %}">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-ship"></i> <span data-translate="vessel_pricing">Vessel-Specific Pricing</span>
                    </h5>
                    <small class="text-muted">
                        <span data-translate="vessel_pricing_desc">Set different selling prices for each touristic vessel</span>
                    </small>
                </div>
                <div class="card-body">
                    {% if touristic_vessels %}
                        <div class="row">
                            {% for vessel in touristic_vessels %}
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="number" 
                                           class="form-control vessel-price-input" 
                                           id="vessel_price_{{ vessel.id }}" 
                                           name="vessel_price_{{ vessel.id }}" 
                                           value="{% if existing_vessel_prices %}{{ existing_vessel_prices|get_item:vessel.id|default_if_none:'' }}{% endif %}"
                                           step="0.001" 
                                           min="0" 
                                           placeholder=" ">
                                    <label for="vessel_price_{{ vessel.id }}">
                                        <i class="bi bi-ship"></i> {{ vessel.name }} <span data-translate="price">Price</span> (JOD)
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <span data-translate="vessel_pricing_optional">Vessel-specific pricing is optional. Leave blank to use the default selling price.</span>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span data-translate="no_touristic_vessels">No touristic vessels found. Contact administrator to add vessels.</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Form Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex gap-2 flex-wrap">
                                {% if mode == 'edit' %}
                                    <button type="submit" name="action" value="save" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> <span data-translate="update_product">Update Product</span>
                                    </button>
                                {% else %}
                                    <button type="submit" name="action" value="save" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> <span data-translate="save_product">Save Product</span>
                                    </button>
                                    <button type="submit" name="action" value="save_and_add_stock" class="btn btn-success" id="saveWithStockBtn">
                                        <i class="bi bi-plus-square"></i> <span data-translate="save_and_add_stock">Save & Add Stock</span>
                                    </button>
                                {% endif %}
                                <a href="{% url 'frontend:product_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> <span data-translate="cancel">Cancel</span>
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            {% if mode == 'edit' %}
                                <button type="button" class="btn btn-outline-danger" onclick="deleteProduct({{ product.id }}, '{{ product.name }}')">
                                    <i class="bi bi-trash"></i> <span data-translate="delete_product">Delete Product</span>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Field Validity & Save Button Control ---
    const saveBtn = document.getElementById('saveProductBtn');
    const saveWithStockBtn = document.getElementById('saveWithStockBtn');
    let fieldValidity = { item_id: true, name: true };

    ['item_id', 'name'].forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (!input) return;

        const checkExists = async () => {
            const currentValue = input.value.trim();
            if (!currentValue) return;

            const param = `${fieldId}=${encodeURIComponent(currentValue)}`;
            const response = await fetch(`/products/check-exists/?${param}`);
            const data = await response.json();

            if (data.exists) {
                showAlert(`${fieldId.toUpperCase()} already exists`, 'warning');
                input.classList.add('is-invalid');
                fieldValidity[fieldId] = false;
            } else {
                input.classList.remove('is-invalid');
                fieldValidity[fieldId] = true;
            }

            const isFormValid = fieldValidity.item_id && fieldValidity.name;
            if (saveBtn) saveBtn.disabled = !isFormValid;
            if (saveWithStockBtn) saveWithStockBtn.disabled = !isFormValid;
        };

        input.addEventListener('blur', checkExists);
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkExists();
            }
        });
    });

    // --- Styled AJAX Alert ---
    function showAlert(message, type = 'info') {
        const alertEl = document.getElementById('ajaxAlert');
        if (!alertEl) return;

        alertEl.className = `alert alert-${type}`;
        alertEl.textContent = message;
        alertEl.classList.remove('d-none');

        setTimeout(() => {
            alertEl.classList.add('d-none');
        }, 5000);
    }

    function updateVesselAvailability() {
        const dutyFreeSwitch = document.getElementById('dutyFreeSwitch');
        const isDutyFree = dutyFreeSwitch.checked;

        document.querySelectorAll('.vessel-checkbox').forEach(checkbox => {
            const row = checkbox.closest('tr');
            const vesselId = checkbox.dataset.vesselId;
            const vesselHasDutyFree = row.querySelector('.badge') !== null;

            if (isDutyFree && !vesselHasDutyFree) {
                checkbox.disabled = true;
                checkbox.checked = false;
                row.style.opacity = '0.5';
                clearVesselInputs(vesselId);
            } else {
                checkbox.disabled = false;
                row.style.opacity = '1';
            }
        });

        const dutyFreeWarning = document.getElementById('dutyFreeWarning');
        dutyFreeWarning.style.display = isDutyFree ? 'block' : 'none';

    }

    function clearVesselInputs(vesselId) {
        const quantityInput = document.querySelector(`input[name="vessel_${vesselId}_quantity"]`);
        const costInput = document.querySelector(`input[name="vessel_${vesselId}_cost"]`);

        quantityInput.value = '';
        quantityInput.readOnly = true;
        quantityInput.style.backgroundColor = '#f8f9fa';

        costInput.value = '';
        costInput.readOnly = true;
        costInput.style.backgroundColor = '#f8f9fa';

        updateVesselTotal(vesselId);
    }

    function clearAllVessels() {
        document.querySelectorAll('.vessel-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = false;
            const vesselId = checkbox.dataset.vesselId;
            clearVesselInputs(vesselId);
            checkbox.closest('tr').style.opacity = '1';
        });

        const dutyFreeWarning = document.getElementById('dutyFreeWarning');
        dutyFreeWarning.style.display = 'none';

        updateGrandTotal();
    }

    function updateVesselTotal(vesselId) {
        const quantityInput = document.querySelector(`input[name="vessel_${vesselId}_quantity"]`);
        const costInput = document.querySelector(`input[name="vessel_${vesselId}_cost"]`);
        const totalElement = document.querySelector(`.total-value[data-vessel-id="${vesselId}"]`);

        const quantity = parseFloat(quantityInput.value) || 0;
        const cost = parseFloat(costInput.value) || 0;
        const total = quantity * cost;

        totalElement.textContent = total.toFixed(3);
        updateGrandTotal();
    }

    function updateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.total-value').forEach(element => {
            const value = parseFloat(element.textContent) || 0;
            grandTotal += value;
        });

        document.getElementById('grandTotal').textContent = grandTotal.toFixed(3);
    }
});
</script>
{% endblock %}