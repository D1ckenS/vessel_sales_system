{% extends 'frontend/base.html' %}
{% load i18n %}

{% block title %}<span data-translate="add_new_product">Add New Product</span> - <span data-translate="vessel_sales_system">Vessel Sales System</span>{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-plus-circle text-success"></i> 
                    <span data-translate="add_new_product">Add New Product</span>
                </h2>
                <p class="text-muted mb-0" data-translate="create_product_desc">Create new product and optionally add initial stock to vessels</p>
            </div>
            <a href="{% url 'frontend:inventory_check' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> <span data-translate="back_to_inventory">Back to Inventory</span>
            </a>
        </div>
    </div>
</div>

<!-- Add Product Form -->
<div class="row">
    <div class="col-lg-10 mx-auto">
        <form method="POST" id="addProductForm">
            {% csrf_token %}
            
            <!-- Step 1: Product Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-1-circle"></i> <span data-translate="product_information">Product Information</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Product Name -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-tag"></i> <span data-translate="product_name">Product Name</span> *
                            </label>
                            <input type="text" class="form-control form-control-lg" name="name" 
                                   placeholder="e.g., بيبسي 250 ملل or Pepsi 250ml"
                                   data-placeholder-en="e.g., بيبسي 250 ملل or Pepsi 250ml"
                                   data-placeholder-ar="مثال: بيبسي 250 ملل او Pepsi 250ml"
                                   required>
                            <small class="text-muted" data-translate="arabic_english_name">Arabic or English name</small>
                        </div>

                        <!-- Item ID -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-hash"></i> <span data-translate="item_id">Item ID</span> *
                            </label>
                            <input type="text" class="form-control form-control-lg" name="item_id" 
                                   placeholder="e.g., 105, PEPSI250, etc."
                                   data-placeholder-en="e.g., 105, PEPSI250, etc."
                                   data-placeholder-ar="مثال: 105, PEPSI250, الخ"
                                   required>
                            <small class="text-muted" data-translate="unique_identifier_manual">Unique identifier - enter manually</small>
                        </div>

                        <!-- Barcode -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-upc-scan"></i> <span data-translate="barcode">Barcode</span>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" name="barcode" 
                                       placeholder="Optional barcode"
                                       data-placeholder-en="Optional barcode"
                                       data-placeholder-ar="باركود اختياري">
                                <button class="btn btn-outline-secondary" type="button" onclick="showComingSoon()">
                                    <i class="bi bi-upc-scan"></i> <span data-translate="scan">Scan</span>
                                </button>
                            </div>
                            <small class="text-muted" data-translate="optional_leave_empty">Optional - leave empty if not available</small>
                        </div>

                        <!-- Category -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-collection"></i> <span data-translate="category">Category</span> *
                            </label>
                            <select class="form-select form-select-lg" name="category" required>
                                <option value="" data-translate="select_category">Select category...</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted" data-translate="choose_appropriate_category">Choose appropriate product category</small>
                        </div>

                        <!-- Purchase Price -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-currency-dollar"></i> <span data-translate="purchase_price_jod">Purchase Price (JOD)</span> *
                            </label>
                            <input type="number" class="form-control form-control-lg" name="purchase_price" 
                                   placeholder="0.000" min="0.001" step="0.001" required>
                            <small class="text-muted" data-translate="cost_price_3_decimal">Cost price - 3 decimal places</small>
                        </div>

                        <!-- Selling Price -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-cash"></i> <span data-translate="selling_price_jod">Selling Price (JOD)</span> *
                            </label>
                            <input type="number" class="form-control form-control-lg" name="selling_price" 
                                   placeholder="0.000" min="0.001" step="0.001" required>
                            <small class="text-muted" data-translate="customer_price_3_decimal">Customer price - 3 decimal places</small>
                        </div>

                        <!-- Product Options -->
                        <div class="col-12 mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_duty_free" id="dutyFreeSwitch">
                                        <label class="form-check-label fw-bold" for="dutyFreeSwitch">
                                            <i class="bi bi-star"></i> <span data-translate="duty_free_product">Duty-Free Product</span>
                                        </label>
                                        <small class="text-muted d-block" data-translate="only_duty_free_vessels">Only available on duty-free vessels</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="active" id="activeSwitch" checked>
                                        <label class="form-check-label fw-bold" for="activeSwitch">
                                            <i class="bi bi-check-circle"></i> <span data-translate="active_product">Active Product</span>
                                        </label>
                                        <small class="text-muted d-block" data-translate="available_for_transactions">Product available for transactions</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Initial Stock (Optional) -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-2-circle"></i> <span data-translate="initial_stock_distribution">Initial Stock Distribution</span>
                        </h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableInitialStock">
                            <label class="form-check-label fw-bold" for="enableInitialStock">
                                <span data-translate="add_initial_stock">Add Initial Stock</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="initialStockSection" style="display: none;">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i>
                        <strong data-translate="optional">Optional:</strong> <span data-translate="add_initial_stock_desc">Add initial stock to vessels. This will create SUPPLY transactions and inventory lots.</span>
                    </div>

                    <!-- Purchase Date -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> <span data-translate="purchase_date">Purchase Date</span>
                            </label>
                            <input type="date" class="form-control form-control-lg" name="purchase_date" value="{{ today|date:'Y-m-d' }}">
                            <small class="text-muted" data-translate="date_stock_received">Date when stock was received</small>
                        </div>
                    </div>

                    <!-- Vessel Stock Distribution -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">
                                        <i class="bi bi-check2-square"></i> <span data-translate="add_stock">Add Stock</span>
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-ship"></i> <span data-translate="vessel">Vessel</span>
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-123"></i> <span data-translate="quantity">Quantity</span>
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-currency-dollar"></i> <span data-translate="purchase_cost_jod">Purchase Cost (JOD)</span>
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-calculator"></i> <span data-translate="total_value">Total Value</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vessel in vessels %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input vessel-checkbox" type="checkbox" 
                                                   name="vessel_{{ vessel.id }}_enabled" id="vessel_{{ vessel.id }}"
                                                   data-vessel-id="{{ vessel.id }}" value="on">
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>
                                                <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                            </strong>
                                            {% if vessel.has_duty_free %}
                                            <span class="badge bg-warning ms-2" data-translate="duty_free">Duty-Free</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control quantity-input" 
                                               name="vessel_{{ vessel.id }}_quantity" placeholder="0" 
                                               min="1" step="1" readonly 
                                               style="background-color: #f8f9fa;" 
                                               data-vessel-id="{{ vessel.id }}">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control cost-input" 
                                               name="vessel_{{ vessel.id }}_cost" placeholder="0.000" 
                                               min="0.001" step="0.001" readonly 
                                               style="background-color: #f8f9fa;"
                                               data-vessel-id="{{ vessel.id }}">
                                    </td>
                                    <td>
                                        <span class="fw-bold total-value" data-vessel-id="{{ vessel.id }}">0.000</span>
                                        <small class="text-muted">JOD</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end fw-bold" data-translate="total_initial_investment">Total Initial Investment:</td>
                                    <td class="fw-bold text-primary">
                                        <span id="grandTotal">0.000</span> JOD
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Duty-Free Warning -->
                    <div id="dutyFreeWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong data-translate="duty_free_product_warning">Duty-Free Product Warning:</strong> <span data-translate="duty_free_vessel_only">This product can only be added to duty-free vessels. Regular vessels are disabled.</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'frontend:inventory_check' %}" class="btn btn-outline-secondary btn-lg me-md-2">
                            <i class="bi bi-arrow-left"></i> <span data-translate="back_to_inventory">Back to Inventory</span>
                        </a>
                        <button type="submit" name="action" value="product_only" class="btn btn-primary btn-lg me-md-2">
                            <i class="bi bi-box"></i> <span data-translate="save_product_only">Save Product Only</span>
                        </button>
                        <button type="submit" name="action" value="with_stock" class="btn btn-success btn-lg" id="saveWithStockBtn" disabled>
                            <i class="bi bi-plus-circle"></i> <span data-translate="save_with_initial_stock">Save with Initial Stock</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Add page-specific translations
document.addEventListener('DOMContentLoaded', function() {
    const pageTranslations = {
        en: {
            'add_new_product': 'Add New Product',
            'vessel_sales_system': 'Vessel Sales System',
            'create_product_desc': 'Create new product and optionally add initial stock to vessels',
            'back_to_inventory': 'Back to Inventory',
            'product_information': 'Product Information',
            'product_name': 'Product Name',
            'arabic_english_name': 'Arabic or English name',
            'item_id': 'Item ID',
            'unique_identifier_manual': 'Unique identifier - enter manually',
            'barcode': 'Barcode',
            'optional_leave_empty': 'Optional - leave empty if not available',
            'category': 'Category',
            'select_category': 'Select category...',
            'choose_appropriate_category': 'Choose appropriate product category',
            'purchase_price_jod': 'Purchase Price (JOD)',
            'cost_price_3_decimal': 'Cost price - 3 decimal places',
            'selling_price_jod': 'Selling Price (JOD)',
            'customer_price_3_decimal': 'Customer price - 3 decimal places',
            'duty_free_product': 'Duty-Free Product',
            'only_duty_free_vessels': 'Only available on duty-free vessels',
            'active_product': 'Active Product',
            'available_for_transactions': 'Product available for transactions',
            'initial_stock_distribution': 'Initial Stock Distribution',
            'add_initial_stock': 'Add Initial Stock',
            'optional': 'Optional',
            'add_initial_stock_desc': 'Add initial stock to vessels. This will create SUPPLY transactions and inventory lots.',
            'purchase_date': 'Purchase Date',
            'date_stock_received': 'Date when stock was received',
            'add_stock': 'Add Stock',
            'vessel': 'Vessel',
            'quantity': 'Quantity',
            'purchase_cost_jod': 'Purchase Cost (JOD)',
            'total_value': 'Total Value',
            'duty_free': 'Duty-Free',
            'total_initial_investment': 'Total Initial Investment:',
            'duty_free_product_warning': 'Duty-Free Product Warning:',
            'duty_free_vessel_only': 'This product can only be added to duty-free vessels. Regular vessels are disabled.',
            'save_product_only': 'Save Product Only',
            'save_with_initial_stock': 'Save with Initial Stock',
            'barcode_coming_soon': '🚀 Barcode scanning feature coming soon!'
        },
        ar: {
            'add_new_product': 'إضافة منتج جديد',
            'vessel_sales_system': 'نظام مبيعات السفن',
            'create_product_desc': 'إنشاء منتج جديد واختياريا إضافة مخزون أولي للسفن',
            'back_to_inventory': 'العودة للمخزون',
            'product_information': 'معلومات المنتج',
            'product_name': 'اسم المنتج',
            'arabic_english_name': 'اسم عربي أو إنجليزي',
            'item_id': 'رقم الصنف',
            'unique_identifier_manual': 'معرف فريد - أدخل يدوياً',
            'barcode': 'الباركود',
            'optional_leave_empty': 'اختياري - اتركه فارغاً إذا لم يكن متوفراً',
            'category': 'الفئة',
            'select_category': 'اختر الفئة...',
            'choose_appropriate_category': 'اختر فئة المنتج المناسبة',
            'purchase_price_jod': 'سعر الشراء (دينار)',
            'cost_price_3_decimal': 'سعر التكلفة - 3 خانات عشرية',
            'selling_price_jod': 'سعر البيع (دينار)',
            'customer_price_3_decimal': 'سعر العميل - 3 خانات عشرية',
            'duty_free_product': 'منتج معفى من الرسوم',
            'only_duty_free_vessels': 'متوفر فقط على السفن المعفاة من الرسوم',
            'active_product': 'منتج نشط',
            'available_for_transactions': 'المنتج متاح للمعاملات',
            'initial_stock_distribution': 'توزيع المخزون الأولي',
            'add_initial_stock': 'إضافة مخزون أولي',
            'optional': 'اختياري',
            'add_initial_stock_desc': 'إضافة مخزون أولي للسفن. سيؤدي هذا إلى إنشاء معاملات توريد ومخزون.',
            'purchase_date': 'تاريخ الشراء',
            'date_stock_received': 'تاريخ استلام المخزون',
            'add_stock': 'إضافة مخزون',
            'vessel': 'السفينة',
            'quantity': 'الكمية',
            'purchase_cost_jod': 'تكلفة الشراء (دينار)',
            'total_value': 'القيمة الإجمالية',
            'duty_free': 'معفى من الرسوم',
            'total_initial_investment': 'إجمالي الاستثمار الأولي:',
            'duty_free_product_warning': 'تحذير منتج معفى من الرسوم:',
            'duty_free_vessel_only': 'يمكن إضافة هذا المنتج فقط للسفن المعفاة من الرسوم. السفن العادية معطلة.',
            'save_product_only': 'حفظ المنتج فقط',
            'save_with_initial_stock': 'حفظ مع المخزون الأولي',
            'barcode_coming_soon': '🚀 ميزة مسح الباركود قريباً!'
        }
    };
    
    // Merge with existing translations
    Object.assign(window.translator.translations.en, pageTranslations.en);
    Object.assign(window.translator.translations.ar, pageTranslations.ar);
    
    // Update page translations
    updatePageTranslations();
});

// Rest of the existing JavaScript code...
[Keep all the existing JavaScript functions unchanged]

function showComingSoon() {
    alertTranslated('barcode_coming_soon');
}
</script>
{% endblock %}