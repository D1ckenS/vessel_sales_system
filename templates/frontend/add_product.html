{% extends 'frontend/base.html' %}
{% load i18n %}

{% block title %}{% trans "Add New Product" %} - {% trans "Vessel Sales System" %}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-plus-circle text-success"></i> 
                    Add New Product
                </h2>
                <p class="text-muted mb-0">Create new product and optionally add initial stock to vessels</p>
            </div>
            <a href="{% url 'frontend:inventory_check' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Inventory
            </a>
        </div>
    </div>
</div>

<!-- Add Product Form -->
<div class="row">
    <div class="col-lg-10 mx-auto">
        <form method="POST" id="addProductForm">
            {% csrf_token %}
            
            <!-- Step 1: Product Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-1-circle"></i> Product Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Product Name -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-tag"></i> Product Name *
                            </label>
                            <input type="text" class="form-control form-control-lg" name="name" 
                                   placeholder="e.g., بيبسي 250 ملل or Pepsi 250ml" required>
                            <small class="text-muted">Arabic or English name</small>
                        </div>

                        <!-- Item ID -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-hash"></i> Item ID *
                            </label>
                            <input type="text" class="form-control form-control-lg" name="item_id" 
                                   placeholder="e.g., 105, PEPSI250, etc." required>
                            <small class="text-muted">Unique identifier - enter manually</small>
                        </div>

                        <!-- Barcode -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-upc-scan"></i> Barcode
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" name="barcode" 
                                       placeholder="Optional barcode">
                                <button class="btn btn-outline-secondary" type="button" onclick="showComingSoon()">
                                    <i class="bi bi-upc-scan"></i> Scan
                                </button>
                            </div>
                            <small class="text-muted">Optional - leave empty if not available</small>
                        </div>

                        <!-- Category -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-collection"></i> Category *
                            </label>
                            <select class="form-select form-select-lg" name="category" required>
                                <option value="">Select category...</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Choose appropriate product category</small>
                        </div>

                        <!-- Purchase Price -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-currency-dollar"></i> Purchase Price (JOD) *
                            </label>
                            <input type="number" class="form-control form-control-lg" name="purchase_price" 
                                   placeholder="0.000" min="0.001" step="0.001" required>
                            <small class="text-muted">Cost price - 3 decimal places</small>
                        </div>

                        <!-- Selling Price -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-cash"></i> Selling Price (JOD) *
                            </label>
                            <input type="number" class="form-control form-control-lg" name="selling_price" 
                                   placeholder="0.000" min="0.001" step="0.001" required>
                            <small class="text-muted">Customer price - 3 decimal places</small>
                        </div>

                        <!-- Product Options -->
                        <div class="col-12 mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_duty_free" id="dutyFreeSwitch">
                                        <label class="form-check-label fw-bold" for="dutyFreeSwitch">
                                            <i class="bi bi-star"></i> Duty-Free Product
                                        </label>
                                        <small class="text-muted d-block">Only available on duty-free vessels</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="active" id="activeSwitch" checked>
                                        <label class="form-check-label fw-bold" for="activeSwitch">
                                            <i class="bi bi-check-circle"></i> Active Product
                                        </label>
                                        <small class="text-muted d-block">Product available for transactions</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Initial Stock (Optional) -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-2-circle"></i> Initial Stock Distribution
                        </h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableInitialStock">
                            <label class="form-check-label fw-bold" for="enableInitialStock">
                                Add Initial Stock
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card-body" id="initialStockSection" style="display: none;">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle"></i>
                        <strong>Optional:</strong> Add initial stock to vessels. This will create SUPPLY transactions and inventory lots.
                    </div>

                    <!-- Purchase Date -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar"></i> Purchase Date
                            </label>
                            <input type="date" class="form-control form-control-lg" name="purchase_date" value="{{ today|date:'Y-m-d' }}">
                            <small class="text-muted">Date when stock was received</small>
                        </div>
                    </div>

                    <!-- Vessel Stock Distribution -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">
                                        <i class="bi bi-check2-square"></i> Add Stock
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-ship"></i> Vessel
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-123"></i> Quantity
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-currency-dollar"></i> Purchase Cost (JOD)
                                    </th>
                                    <th class="border-0">
                                        <i class="bi bi-calculator"></i> Total Value
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vessel in vessels %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input vessel-checkbox" type="checkbox" 
                                                   name="vessel_{{ vessel.id }}_enabled" id="vessel_{{ vessel.id }}"
                                                   data-vessel-id="{{ vessel.id }}" value="on">
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>
                                                <span class="vessel-name" data-en="{{ vessel.name }}" data-ar="{{ vessel.name_ar }}">{{ vessel.name }}</span>
                                            </strong>
                                            {% if vessel.has_duty_free %}
                                            <span class="badge bg-warning ms-2">Duty-Free</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control quantity-input" 
                                               name="vessel_{{ vessel.id }}_quantity" placeholder="0" 
                                               min="1" step="1" readonly 
                                               style="background-color: #f8f9fa;" 
                                               data-vessel-id="{{ vessel.id }}">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control cost-input" 
                                               name="vessel_{{ vessel.id }}_cost" placeholder="0.000" 
                                               min="0.001" step="0.001" readonly 
                                               style="background-color: #f8f9fa;"
                                               data-vessel-id="{{ vessel.id }}">
                                    </td>
                                    <td>
                                        <span class="fw-bold total-value" data-vessel-id="{{ vessel.id }}">0.000</span>
                                        <small class="text-muted">JOD</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">Total Initial Investment:</td>
                                    <td class="fw-bold text-primary">
                                        <span id="grandTotal">0.000</span> JOD
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Duty-Free Warning -->
                    <div id="dutyFreeWarning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Duty-Free Product Warning:</strong> This product can only be added to duty-free vessels. 
                        Regular vessels are disabled.
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'frontend:inventory_check' %}" class="btn btn-outline-secondary btn-lg me-md-2">
                            <i class="bi bi-arrow-left"></i> Back to Inventory
                        </a>
                        <button type="submit" name="action" value="product_only" class="btn btn-primary btn-lg me-md-2">
                            <i class="bi bi-box"></i> Save Product Only
                        </button>
                        <button type="submit" name="action" value="with_stock" class="btn btn-success btn-lg" id="saveWithStockBtn" disabled>
                            <i class="bi bi-plus-circle"></i> Save with Initial Stock
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Toggle initial stock section
document.getElementById('enableInitialStock').addEventListener('change', function() {
    const stockSection = document.getElementById('initialStockSection');
    const saveWithStockBtn = document.getElementById('saveWithStockBtn');
    
    if (this.checked) {
        stockSection.style.display = 'block';
        updateSaveButtonState();
    } else {
        stockSection.style.display = 'none';
        saveWithStockBtn.disabled = true;
        // Clear all vessel selections
        document.querySelectorAll('.vessel-checkbox').forEach(cb => {
            cb.checked = false;
            toggleVesselInputs(cb.dataset.vesselId, false);
        });
    }
});

// Handle vessel checkbox changes
document.querySelectorAll('.vessel-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const vesselId = this.dataset.vesselId;
        const isEnabled = this.checked;
        
        toggleVesselInputs(vesselId, isEnabled);
        updateVesselTotal(vesselId);
        updateSaveButtonState();
        
        // Auto-fill cost from purchase price if available
        if (isEnabled) {
            const purchasePrice = document.querySelector('[name="purchase_price"]').value;
            if (purchasePrice) {
                const costInput = document.querySelector(`[name="vessel_${vesselId}_cost"]`);
                if (!costInput.value) {
                    costInput.value = purchasePrice;
                    updateVesselTotal(vesselId);
                }
            }
        }
    });
});

// Handle quantity and cost changes
document.querySelectorAll('.quantity-input, .cost-input').forEach(input => {
    input.addEventListener('input', function() {
        const vesselId = this.dataset.vesselId;
        updateVesselTotal(vesselId);
        updateSaveButtonState();
    });
});

// Auto-fill costs when purchase price changes
document.querySelector('[name="purchase_price"]').addEventListener('input', function() {
    const purchasePrice = this.value;
    if (purchasePrice) {
        // Fixed: Look for enabled inputs (not readonly) that don't have values
        document.querySelectorAll('.cost-input').forEach(costInput => {
            if (!costInput.readOnly && !costInput.value) {
                costInput.value = purchasePrice;
                updateVesselTotal(costInput.dataset.vesselId);
            }
        });
    }
});

// Handle duty-free product changes
document.getElementById('dutyFreeSwitch').addEventListener('change', function() {
    updateDutyFreeVessels();
});

function toggleVesselInputs(vesselId, enabled) {
    const quantityInput = document.querySelector(`[name="vessel_${vesselId}_quantity"]`);
    const costInput = document.querySelector(`[name="vessel_${vesselId}_cost"]`);
    
    // Don't disable the inputs, just change their appearance
    if (enabled) {
        quantityInput.style.backgroundColor = '';
        costInput.style.backgroundColor = '';
        quantityInput.readOnly = false;
        costInput.readOnly = false;
    } else {
        quantityInput.style.backgroundColor = '#f8f9fa';
        costInput.style.backgroundColor = '#f8f9fa';
        quantityInput.readOnly = true;
        costInput.readOnly = true;
        quantityInput.value = '';
        costInput.value = '';
        updateVesselTotal(vesselId);
    }
}

function updateVesselTotal(vesselId) {
    const quantityInput = document.querySelector(`[name="vessel_${vesselId}_quantity"]`);
    const costInput = document.querySelector(`[name="vessel_${vesselId}_cost"]`);
    const totalSpan = document.querySelector(`[data-vessel-id="${vesselId}"].total-value`);
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const cost = parseFloat(costInput.value) || 0;
    const total = quantity * cost;
    
    totalSpan.textContent = total.toFixed(3);
    updateGrandTotal();
}

function updateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll('.total-value').forEach(span => {
        const value = parseFloat(span.textContent) || 0;
        grandTotal += value;
    });
    
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(3);
}

function updateSaveButtonState() {
    const enableInitialStock = document.getElementById('enableInitialStock').checked;
    const saveWithStockBtn = document.getElementById('saveWithStockBtn');
    
    if (!enableInitialStock) {
        saveWithStockBtn.disabled = true;
        return;
    }
    
    // Check if at least one vessel has valid quantity and cost
    let hasValidVessel = false;
    document.querySelectorAll('.vessel-checkbox:checked').forEach(checkbox => {
        const vesselId = checkbox.dataset.vesselId;
        const quantity = parseFloat(document.querySelector(`[name="vessel_${vesselId}_quantity"]`).value) || 0;
        const cost = parseFloat(document.querySelector(`[name="vessel_${vesselId}_cost"]`).value) || 0;
        
        if (quantity > 0 && cost > 0) {
            hasValidVessel = true;
        }
    });
    
    saveWithStockBtn.disabled = !hasValidVessel;
}

function updateDutyFreeVessels() {
    const isDutyFree = document.getElementById('dutyFreeSwitch').checked;
    const warning = document.getElementById('dutyFreeWarning');
    
    if (isDutyFree) {
        warning.style.display = 'block';
        
        // Disable non-duty-free vessels
        {% for vessel in vessels %}
        {% if not vessel.has_duty_free %}
        const vessel{{ vessel.id }}Checkbox = document.querySelector('[name="vessel_{{ vessel.id }}_enabled"]');
        const vessel{{ vessel.id }}Row = vessel{{ vessel.id }}Checkbox.closest('tr');
        vessel{{ vessel.id }}Checkbox.checked = false;
        vessel{{ vessel.id }}Checkbox.style.display = 'none';
        vessel{{ vessel.id }}Row.style.opacity = '0.5';
        toggleVesselInputs('{{ vessel.id }}', false);
        {% endif %}
        {% endfor %}
    } else {
        warning.style.display = 'none';
        
        // Re-enable all vessels
        {% for vessel in vessels %}
        const vessel{{ vessel.id }}Checkbox = document.querySelector('[name="vessel_{{ vessel.id }}_enabled"]');
        const vessel{{ vessel.id }}Row = vessel{{ vessel.id }}Checkbox.closest('tr');
        vessel{{ vessel.id }}Checkbox.style.display = '';
        vessel{{ vessel.id }}Row.style.opacity = '1';
        {% endfor %}
    }
    
    updateSaveButtonState();
}

// Form validation
document.getElementById('addProductForm').addEventListener('submit', function(e) {
    const action = e.submitter?.value || 'product_only';
    
    // Add hidden input to ensure action is captured
    const hiddenAction = document.createElement('input');
    hiddenAction.type = 'hidden';
    hiddenAction.name = 'form_action';
    hiddenAction.value = action;
    this.appendChild(hiddenAction);
    
    console.log('DEBUG: Form submission with action:', action);
    console.log('DEBUG: Submitter:', e.submitter);
    
    if (action === 'with_stock') {
        // Check if initial stock section is enabled
        const initialStockEnabled = document.getElementById('enableInitialStock').checked;
        console.log('DEBUG: Initial stock enabled:', initialStockEnabled);
        
        if (!initialStockEnabled) {
            alert('Please enable "Add Initial Stock" toggle first!');
            e.preventDefault();
            return;
        }
        
        // Validate that at least one vessel is selected with valid data
        let hasValidStock = false;
        
        document.querySelectorAll('.vessel-checkbox').forEach(checkbox => {
            const vesselId = checkbox.dataset.vesselId;
            const isChecked = checkbox.checked;
            const quantity = parseFloat(document.querySelector(`[name="vessel_${vesselId}_quantity"]`).value) || 0;
            const cost = parseFloat(document.querySelector(`[name="vessel_${vesselId}_cost"]`).value) || 0;
            
            if (isChecked && quantity > 0 && cost > 0) {
                hasValidStock = true;
                console.log(`DEBUG: Valid stock found - Vessel ${vesselId}: ${quantity} units @ ${cost}`);
            }
        });
        
        if (!hasValidStock) {
            e.preventDefault();
            alert('Please select at least one vessel with valid quantity and cost for initial stock.');
            return;
        }
    }
    
    // Show loading state
    e.submitter.innerHTML = '<span class="loading"></span> Saving...';
    e.submitter.disabled = true;
});

function showComingSoon() {
    alert('🚀 Barcode scanning feature coming soon!');
}
</script>
{% endblock %}